<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE sqlMap PUBLIC "-//ibatis.apache.org//DTD SQL Map 2.0//EN" 
 "http://ibatis.apache.org/dtd/sql-map-2.dtd">
<sqlMap namespace="RecommendationLog">
	
	<!-- +
		 | Get list of tag names for given contentid
		 + -->	
	<select id="getTagsForCID" parameterClass="integer" resultMap="RecommendationBibCommon.tagName">
		SELECT tag_name
		FROM tas
		WHERE content_id = #id#
	</select>

	<!-- +
		 | Get list of tag names for given contentid
		 + -->	
	<select id="getTagNamesForCID" parameterClass="integer" resultClass="string">
		SELECT tag_name
		FROM tas
		WHERE content_id = #id#
	</select>


	<!-- +
		 | Get list of pairs containing given user's most popular tag name and frequency
		 + --> 
	<select id="getMostPopularTagsForUser" parameterClass="getTagsForResParam" resultMap="RecommendationBibCommon.tagFrequency">
		SELECT t.tag_lower as first, COUNT(tag_lower) as second 
		FROM tas t
		WHERE t.user_name = #userName# 
		GROUP BY tag_lower 
		ORDER BY COUNT(tag_lower) DESC 
		LIMIT #range#
	</select>
	
	<!--  +
		  | Get list of pairs containing given bookmark's most popular tag name and frequency
		  | - Only take public posts into account!
		  + -->
	<select id="getMostPopularTagsForBookmark" parameterClass="getTagsForResParam" resultMap="RecommendationBibCommon.tagFrequency">
		SELECT tag_lower as first, COUNT(tag_lower) as second 
		  FROM tas t 
		    JOIN bookmark b USING (content_id)
		  WHERE b.content_id = #id#
		    AND b.group = 0
		  GROUP BY tag_lower 
		  ORDER BY COUNT(tag_lower) DESC 
		  LIMIT #range#
	</select>
	
	<!--  +
		  | Get list of pairs containing given publication's most popular tag name and frequency
		  + -->
	<select id="getMostPopularTagsForBibTeX" parameterClass="getTagsForResParam" resultMap="RecommendationBibCommon.tagFrequency">
		SELECT tag_lower as first, COUNT(tag_lower) as second 
		  FROM tas t
		    JOIN bibtex b USING (content_id) 
		WHERE b.content_id = #id#
		  AND b.group = 0 
		GROUP BY tag_lower 
		ORDER BY COUNT(tag_lower) DESC 
		LIMIT #range#
	</select>	
		
	<!-- +
		 | Get number of tags used by 
		 + --> 
	<select id="getNumberOfTagsForUser" parameterClass="string" resultClass="integer">
		SELECT COUNT(DISTINCT tag_lower) 
		FROM tas 
		WHERE user_name = #userName#
	</select>

	<!-- +
		 | Get number of TAS  
		 + --> 
	<select id="getNumberOfTasForUser" parameterClass="string" resultClass="integer">
		SELECT COUNT(*) 
		FROM tas 
		WHERE user_name = #userName#
	</select>	

	<!-- +
		 | Get number of tags for bookmark 
		 + --> 
	<select id="getNumberOfTagsForBookmark" parameterClass="string" resultClass="integer">
		SELECT COUNT(DISTINCT tag_lower) 
		  FROM tas 
		    JOIN bookmark b USING (content_id)  
		  WHERE b.content_id = #entityId#
		    AND b.group = 0
	</select>

	<!-- +
		 | Get number of TAS for bookmark 
		 + --> 
	<select id="getNumberOfTasForBookmark" parameterClass="string" resultClass="integer">
		SELECT COUNT(*) 
		  FROM tas 
		    JOIN bookmark b USING (content_id)  
		  WHERE b.content_id = #entityId#
		    AND b.group = 0
	</select>	
	
	<!-- +
		 | Get number of tags used by 
		 + --> 
	<select id="getNumberOfTagsForBibTeX" parameterClass="string" resultClass="integer">
		SELECT COUNT(DISTINCT tag_lower) 
		  FROM tas
		    JOIN bibtex b USING (content_id) 
		  WHERE b.content_id = #entityId#
		    AND b.group = 0
	</select>
	
	<!-- +
		 | Get number of TAS 
		 + --> 
	<select id="getNumberOfTasForBibTeX" parameterClass="string" resultClass="integer">
		SELECT COUNT(*) 
		  FROM tas
		    JOIN bibtex b USING (content_id) 
		  WHERE b.content_id = #entityId#
		    AND b.group = 0
	</select>	

	<!-- +
		 | Get user name for given user id 
		 + --> 
	<select id="getUserNameByID" parameterClass="integer" resultClass="string">
		SELECT user_name 
		  FROM user 
		  WHERE id = #id#
	</select>	

	<!-- +
		 | Get user id for given user name 
		 + --> 
	<select id="getUserIDByName" parameterClass="string" resultClass="integer">
		SELECT id 
		  FROM user 
		  WHERE user_name = #name#
	</select>	


	<!--+
		| Get list of top five query_ids nearest to given post
		+-->    
	<select id="getNearestPostsForQuery" parameterClass="getTagsForResParam" resultMap="RecommendationBibCommon.postGuess">
		SELECT DISTINCT content_id, ABS(TIMESTAMPDIFF(SECOND, date, #timestamp#)) as diff
		FROM tas 
		WHERE user_name= #userName# 
		   AND ABS(TIMESTAMPDIFF(SECOND, date, #timestamp#)) &lt; 3600 
		ORDER BY ABS(TIMESTAMPDIFF(SECOND, date, #timestamp#)) ASC
		LIMIT 5
	</select>
	
	<!--+
	    | try to get latest content id for given post data
	    +-->
	<select id="lookupBookmarkContentID-1" resultClass="integer" parameterClass="postRecParam">
		SELECT content_id 
		FROM bookmark
		WHERE 
			book_url_hash = #hash# AND
			user_name = #userName# AND
			date = #date#
		LIMIT 1
	</select>
	<!--+
	    | try to get old content id for given post data
	    +-->
	<select id="lookupBookmarkContentID-2" resultClass="integer" parameterClass="postRecParam">
		SELECT content_id 
		FROM log_bookmark
		WHERE 
			book_url_hash = #hash# AND
			user_name = #userName# AND
			date = #date#
		LIMIT 1
	</select>

	<!--+
	    | try to get latest content id for given post data
	    +-->
	<select id="lookupBibTeXContentID-1" resultClass="integer" parameterClass="postRecParam">
		SELECT content_id 
		FROM bibtex
		WHERE 
			simhash2 = #hash# AND
			user_name = #userName# AND
			date = #date#
		LIMIT 1
	</select>
	<!--+
	    | try to get old content id for given post data
	    +-->
	<select id="lookupBibTeXContentID-2" resultClass="integer" parameterClass="postRecParam">
		SELECT content_id 
		FROM log_bibtex
		WHERE 
			simhash2 = #hash# AND
			user_name = #userName# AND
			date = #date#
		LIMIT 1
	</select>

	<select id="getCompleteTagsForCID" resultMap="RecommendationBibCommon.tagByID" parameterClass="integer">
		SELECT tags.tag_id, tags.tag_name
		FROM tas, tags 
		WHERE tas.tag_name = tags.tag_name AND tas.content_id = #contentID#
		GROUP BY tag_name
	</select>
	
	
	<!-- +
		 |
		 | ITEM-RECOMMENDER SETTINGS
		 |
		 + -->
	
	<!-- +
		 | try to get the count most actual bibtex entries
		 + -->
	
	<select id="getMostActualBibTex" resultMap="BibTexCommon.bibtexPost" parameterClass="bibtexParam">
		SELECT <include refid ="bibtexAttributes2"/>, t.change_date, t.tag_name, g.*, b2.count, <include refid="reviewRatingsRows" />
		FROM (SELECT t1.*, h.ctr AS count
		      FROM bibtex t1, bibhash h
		      WHERE <include refid="bibtexSimHash3"/>
		            <include refid="restrictToGroups"/>
			  		<include refid="sysTagsEntryType"/>
			  		<include refid="sysTagsYear"/>		            
		      ORDER BY date DESC
		      LIMIT #limit# OFFSET #offset#) AS b2
		LEFT OUTER JOIN tas AS t ON b2.content_id = t.content_id <include refid="reviewRatingsJoinPublication2" />, groupids AS g
		WHERE b2.group = g.group
	</select>
	
	<!-- +
		 | try to get the count most actual bookmark entries
		 + -->
	<select id="getMostActualBookmark" resultMap="BookmarkCommon.bookmarkPost" parameterClass="bookmarkParam">
		SELECT g.*, bb.content_id, bb.book_url_hash AS interHash, bb.book_url_hash AS intraHash, title, description, bb.date,
		       bb.book_url, bb.book_url_ctr AS count, t.tag_name, bb.user_name, t.change_date, <include refid="reviewRatingsRows" />
		FROM (SELECT t1.content_id, t1.book_url_hash, t1.book_description AS title, t1.book_extended AS description, t1.date,
		             u.book_url, u.book_url_ctr, t1.group, t1.user_name, t1.change_date
		      FROM bookmark t1, urls u
		      WHERE u.book_url_hash = t1.book_url_hash
		            <include refid="restrictToGroups"/>
		      ORDER BY date DESC
		      LIMIT #limit# OFFSET #offset#) AS bb
		LEFT OUTER JOIN tas AS t ON bb.content_id = t.content_id <include refid="reviewRatingsJoinBookmark2" />, groupids AS g
		WHERE bb.group = g.group
	</select>
	
	<select id="getSimilarUsersByFolkrank" resultClass="string" parameterClass="itemRecRequestParam">
		SELECT w.item AS user_name, ROUND(weight,5) * 10000 AS weight
		FROM rankings r
			JOIN weights w USING (id)
			JOIN user u ON (w.item = u.user_name)
			WHERE r.item=#userName# AND r.dim = 1
			AND w.dim = 1
			AND w.item != #userName#
			AND u.role != 3
		ORDER BY 2 DESC
		LIMIT #count#
	</select>
	
	<select id="getSimilarUsersByCosineSimilarity" resultClass="string" parameterClass="itemRecRequestParam">
		SELECT u2 FROM useruser_similarity 
		WHERE u1 = #userName# 
			AND measure_id=1 
		ORDER BY sim DESC 
		LIMIT #count# OFFSET 1;
	</select>
	
	<!-- +
		 | get all users which used at least one equal tag to the requesting user
		 + -->
	
	<select id="getSimilarUsersByEqualTags" resultClass="string" parameterClass="itemRecRequestParam">
		SELECT u.user_name FROM 
			(SELECT t.user_name, COUNT(t.tag_name) as tag_count
			 FROM tas t 
			 WHERE t.tag_name=#tag# AND t.user_name!=#userName#
			 GROUP BY t.user_name
			 ORDER BY tag_count DESC) t1 
		JOIN user u ON (u.user_name=t1.user_name AND u.role!=3 AND u.spammer!=1)
		LIMIT #count#
	</select>
	
	<!-- +
		 | retrieve the count most used tags of a user
		 + -->
		 
	<select id="getMostImportantTagsOfUser" parameterClass="itemRecRequestParam" resultClass="string">
		SELECT tag_name, COUNT(content_id) as count 
		FROM tas WHERE user_name=#userName#
		GROUP BY tag_name 
		ORDER BY count DESC 
		LIMIT #count#
	</select>
	
	<select id="getBibTexById" resultMap="BibTexCommon.bibtexPost" parameterClass="bibtexParam">
		SELECT <include refid ="bibtexAttributes2"/>, t.change_date, t.tag_name, g.*, b2.count, <include refid="reviewRatingsRows" />
		FROM (SELECT t1.*, h.ctr AS count
		      FROM bibtex t1, bibhash h
		      WHERE t1.content_id = #requestedContentId#
		      		AND <include refid="bibtexSimHash3"/>) AS b2
		LEFT OUTER JOIN tas AS t ON b2.content_id = t.content_id <include refid="reviewRatingsJoinPublication2" />, groupids AS g
		WHERE b2.group = g.group
	</select>
	
	<select id="getBookmarkById" resultMap="BookmarkCommon.bookmarkPost" parameterClass="bookmarkParam">
		SELECT g.*, bb.content_id, bb.book_url_hash AS interHash, bb.book_url_hash AS intraHash, title, description, bb.date,
		       bb.book_url, bb.book_url_ctr AS count, t.tag_name, bb.user_name, t.change_date, <include refid="reviewRatingsRows" />
		FROM (SELECT t1.content_id, t1.book_url_hash, t1.book_description AS title, t1.book_extended AS description, t1.date,
		             u.book_url, u.book_url_ctr, t1.group, t1.user_name, t1.change_date
		      FROM bookmark t1, urls u
		      WHERE t1.content_id = #requestedContentId#
		      		AND u.book_url_hash = t1.book_url_hash) AS bb
		LEFT OUTER JOIN tas AS t ON bb.content_id = t.content_id <include refid="reviewRatingsJoinBookmark2" />, groupids AS g
		WHERE bb.group = g.group
	</select>
	
	<select id="getReducedUserBookmark" resultMap="BookmarkCommon.bookmarkPost" parameterClass="bookmarkParam">
		SELECT bb.content_id, bb.book_url_hash AS interHash, bb.book_url_hash AS intraHash, title, description, bb.date,
		       bb.book_url, bb.book_url_ctr AS count, t.tag_name, bb.user_name, t.change_date, NULL AS `group`, 
				NULL AS group_name, NULL AS rating, NULL as number_of_ratings, -1 as scraperid
		FROM (SELECT t1.content_id, t1.book_url_hash, t1.book_description AS title, t1.book_extended AS description, t1.date,
		             u.book_url, u.book_url_ctr, t1.group, t1.user_name, t1.change_date
		      FROM bookmark t1, urls u
		      WHERE t1.user_name = #requestedUserName#
		      		AND t1.group = #groupId#
		      		AND u.book_url_hash = t1.book_url_hash
		      		ORDER BY date DESC
		       LIMIT #limit# OFFSET #offset#) AS bb
		LEFT OUTER JOIN tas AS t ON (bb.content_id = t.content_id)
		GROUP BY bb.content_id
	</select>
	
	<select id="getReducedUserBibTex" resultMap="BibTexCommon.bibtexPost" parameterClass="bibtexParam">
		SELECT <include refid="commonBibtexAttributes2"/>, b2.change_date, t.tag_name, NULL AS `group`, 
				NULL AS group_name, 1 AS count, NULL AS rating, NULL as number_of_ratings, -1 as scraperid
		FROM (SELECT * FROM bibtex b1
			WHERE b1.group = #groupId#
			AND b1.user_name=#requestedUserName#
			ORDER BY date DESC
			LIMIT #limit# OFFSET #offset#) b2
		LEFT OUTER JOIN tas AS t ON (b2.content_id = t.content_id)
		GROUP BY b2.content_id
	</select>
	
	<!-- +
		 | allow the privacy filter to get the user ids
		 + -->
	<select id="getUserIdByName" resultClass="long" parameterClass="string">
		SELECT id 
		FROM user 
		WHERE user_name=#user_name#
	</select>
</sqlMap>
