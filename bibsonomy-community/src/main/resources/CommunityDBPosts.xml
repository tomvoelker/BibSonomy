<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE sqlMap PUBLIC "-//ibatis.apache.org//DTD SQL Map 2.0//EN" "http://ibatis.apache.org/dtd/sql-map-2.dtd">

<sqlMap namespace="CommunityDBManage">
	<!--+ =================================================================+ 
	    |                            lookup                                |
	    +================================================================= +-->
	    
	<!-- get list of all public non-spam bibtex posts belonging to given community -->
	<select id="getBibTexForCommunity" parameterClass="resourceParam" resultMap="BibTexCommon.communityBibtexPost">
		SELECT <include refid ="allBibtexAttributesWithSimHashes"/>, t.tag_name, r.p as weight, m.community_uid
		FROM $communityDBName$.resources AS r
		JOIN $communityDBName$.community_mapping m ON (r.run_id = m.run_id AND r.community_id = m.community_id)
		JOIN bibtex AS b ON (r.hash = b.simhash1)
		JOIN tas AS t ON (b.content_id = t.content_id)
		WHERE m.community_uid = #communityId#
		  AND r.content_type = 2
		  AND b.group = 0
		GROUP BY b.simhash1
		ORDER BY r.p DESC
		LIMIT #offset#, #limit#
	</select>
	
	<!-- get list of all public non-spam bookmarks belonging to given community -->
	<select id="getBookmarksForCommunity" parameterClass="resourceParam" resultMap="BookmarkCommon.communityBookmarkPost">
		SELECT <include refid ="bookmarkAttributes"/>, t.tag_name, u.book_url, r.p as weight, m.community_uid
		FROM $communityDBName$.resources AS r
		JOIN $communityDBName$.community_mapping m ON (r.run_id = m.run_id AND r.community_id = m.community_id)
		JOIN bookmark AS b ON (r.hash = b.book_url_hash)
		JOIN tas AS t ON (b.content_id = t.content_id)
		JOIN urls AS u USING (book_url_hash)
		WHERE m.community_uid = #communityId#
		  AND r.content_type = 1
		  AND b.group = 0
		GROUP BY b.book_url_hash
		ORDER BY r.p DESC
		LIMIT #offset#, #limit#
	</select>
	
	<!-- get list of most popular tags for given community -->
	<select id="getTagCloudPopularForCommunity" parameterClass="resourceParam" resultMap="Common.tagCount">
		SELECT t.tag_name AS name, t.count AS count, t.p as weight
		FROM $communityDBName$.topics t
		JOIN $communityDBName$.community_mapping m ON (t.run_id = m.run_id AND t.community_id = m.community_id)
		WHERE m.community_uid = #communityId#
		ORDER BY t.p DESC
		LIMIT #offset#, #limit#
	</select>

</sqlMap>
