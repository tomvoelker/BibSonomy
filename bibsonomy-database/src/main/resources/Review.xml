<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE sqlMap PUBLIC "-//iBATIS.com//DTD SQL Map 2.0//EN" "http://www.ibatis.com/dtd/sql-map-2.dtd">

<sqlMap namespace="Review">

	<select id="getReviews" parameterClass="string" resultMap="ReviewCommon.review">
		SELECT <include refid ="allReviewRows"/> FROM reviews WHERE interHash = #interHash# ORDER BY date ASC
	</select>
		
	<insert id="insertReview" parameterClass="reviewParam">
		INSERT INTO reviews (interHash, user_name, text, rating, date) VALUES (#interHash#, #username#, #review.text#, #review.rating#, CURRENT_TIMESTAMP)
	</insert>
	
	<select id="selectReviewForHashAndUser" parameterClass="reviewParam" resultMap="ReviewCommon.review">
		SELECT <include refid ="allReviewRows"/> FROM reviews WHERE user_name = #username# AND interHash = #interHash#
	</select>
	
	<update id="updateReview" parameterClass="reviewParam">
		UPDATE reviews SET text = #review.text#, rating = #review.rating# WHERE user_name = #username# AND interHash = #interHash#
	</update>
	
	<delete id="deleteReview" parameterClass="reviewParam">
		DELETE FROM reviews WHERE user_name = #username# AND interHash = #interHash#
	</delete>
	
	
	<!-- review mark as helpful/not helpful -->
	
	<select id="getReviewMark" parameterClass="reviewParam" resultClass="boolean">
		SELECT COUNT(interHash) FROM reviews_helpful WHERE user_name = #username# AND interHash = #interHash# AND mark_user_name = #loggedinUsername#
	</select>
	
	<insert id="insertMark" parameterClass="reviewParam">
		INSERT INTO reviews_helpful (<include refid ="allReviewHelpfulRows" />) VALUES
	(#interHash#, #username#, #loggedinUsername#, #helpful#);
			
	</insert>
	
	<update id="updateHelpful" parameterClass="reviewParam">
		UPDATE reviews SET helpful_count = helpful_count + 1 WHERE user_name = #username# AND interHash = #interHash#
	</update>
	
	<update id="updateNotHelpful" parameterClass="reviewParam">
		UPDATE reviews SET not_helpful_count = not_helpful_count + 1 WHERE user_name = #username# AND interHash = #interHash#
	</update>
	
</sqlMap>