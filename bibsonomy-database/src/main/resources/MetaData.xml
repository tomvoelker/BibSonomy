<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE sqlMap PUBLIC "-//iBATIS.com//DTD SQL Map 2.0//EN" "http://www.ibatis.com/dtd/sql-map-2.dtd">

<sqlMap namespace="MetaData">

	<resultMap id="postMetaDataList" class="postMetaData">
		<result property="userName"    	column="user_name"		javaType="String" />
		<result property="interHash"  	column="inter_hash"		javaType="String" />
		<result property="intraHash"    column="intra_hash"		javaType="String" />
		<result property="key"      	column="key"			javaType="String" />
		<result property="value"      	column="value"			javaType="String" />
    	<result property="date"     	column="date"			javaType="Date" />
	</resultMap>
	
	<select id="getPostMetaData" parameterClass="metaDataPostParam" resultMap="postMetaDataList">
		SELECT a.user_name, a.key, a.value, a.date, b1.simhash1 AS inter_hash, b1.simhash2 AS intra_hash FROM post_metadata AS a
		JOIN bibtex b1 ON a.content_id = b1.content_id
		JOIN bibtex b2 ON a.ref_content_id = b2.content_id
		WHERE 
			b1.group IN (
			<iterate property="groups" conjunction=",">
		    	$groups[]$
			</iterate>)
			AND b2.group IN (
			<iterate property="groups" conjunction=",">
		    	$groups[]$
			</iterate>)
			<isNotEmpty property="intraHash" prepend="AND"> 
				(b2.`simhash2` = #intraHash# OR b1.`simhash2` = #intraHash#)
			</isNotEmpty>
			<isNotEmpty property="interHash" prepend="AND"> 
				()b2.`simhash1` = #interHash# or b1.`simhash1` = #interHash#)
			</isNotEmpty>
			<isNotEmpty property="userName" prepend="AND"> 
				`user_name` = #userName# 
			</isNotEmpty>
			<isNotEmpty property="key" prepend="AND"> 
				`key` = #key# 
			</isNotEmpty>
		ORDER BY a.`date` ASC
	</select>
 
</sqlMap>