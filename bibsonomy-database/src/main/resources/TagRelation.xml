<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE sqlMap PUBLIC "-//iBATIS.com//DTD SQL Map 2.0//EN" "http://www.ibatis.com/dtd/sql-map-2.dtd">

<sqlMap namespace="TagRelation">
	<insert id="insertTagRelationIfNotPresent" parameterClass="tagRelationParam">
		INSERT INTO tagtagrelations  (relationID, lower, upper, date_of_create, user_name)
		SELECT value+1, #lowerTagName#, #upperTagName#, #creationDate#, #ownerUserName# FROM ids WHERE name = 2
	</insert>
	
	<delete id="deleteTagRelation" parameterClass="tagRelationParam">
		DELETE FROM tagtagrelations WHERE lower=#lowerTagName# AND upper=#upperTagName# AND user_name=#ownerUserName#
	</delete>
	
	<delete id="deleteConcept" parameterClass="tagRelationParam">
		DELETE FROM tagtagrelations WHERE upper=#upperTagName# AND user_name=#ownerUserName#
	</delete>	
	
	<select id="getPickedConceptsForUser" parameterClass="String" resultMap="TagCommon.tagWithSubtags">
		SELECT r.upper AS tag_name, GROUP_CONCAT(r.lower ORDER BY r.lower SEPARATOR ' ') AS subtags 
		FROM tagtagrelations r, picked_concepts p 
		WHERE r.user_name=#userName# AND r.user_name=p.user_name AND r.upper=p.upper 
		GROUP BY r.upper 
		ORDER BY r.upper
	</select>
	
	<select id="getAllConceptsForUser" parameterClass="String" resultMap="TagCommon.tagWithSubtags">
		SELECT upper AS tag_name, GROUP_CONCAT(lower ORDER BY lower SEPARATOR ' ') AS subtags 
		FROM tagtagrelations 
		WHERE user_name=#userName# 
		GROUP BY upper 
		ORDER BY upper
	</select>
	
	<select id="getConceptForUser" parameterClass="tagRelationParam" resultMap="TagCommon.tagWithSubtags">
		SELECT upper AS tag_name, GROUP_CONCAT(lower ORDER BY lower SEPARATOR ' ') AS subtags 
		FROM tagtagrelations 
		WHERE upper=#upperTagName#
		AND user_name=#ownerUserName# 		
		GROUP BY upper 
		ORDER BY upper
	</select>
	
	<select id="getRelationID" parameterClass="tagRelationParam" resultClass="string">
		SELECT relationID FROM tagtagrelations where user_name = #ownerUserName# and lower = #lowerTagName# and upper = #upperTagName# 
	</select>
</sqlMap>