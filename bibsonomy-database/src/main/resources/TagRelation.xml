<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE sqlMap PUBLIC "-//iBATIS.com//DTD SQL Map 2.0//EN" "http://www.ibatis.com/dtd/sql-map-2.dtd">

<sqlMap namespace="TagRelation">
	<insert id="insertTagRelationIfNotPresent" parameterClass="tagRelationParam">
		INSERT INTO tagtagrelations (relationID, lower, upper, date_of_create,
			user_name, lower_lcase, upper_lcase)
		SELECT value+1, #lowerTagName#, #upperTagName#, #creationDate#, 
			#ownerUserName#, LCASE(#lowerTagName#), LCASE(#upperTagName#)
		FROM ids 
		WHERE name = 2
	</insert>

	<delete id="deleteTagRelation" parameterClass="tagRelationParam">
		DELETE FROM tagtagrelations
		WHERE user_name=#ownerUserName# 
			AND lower=#lowerTagName#
			AND upper=#upperTagName#
	</delete>

	<delete id="deleteConcept" parameterClass="tagRelationParam">
		DELETE FROM tagtagrelations 
		WHERE user_name=#ownerUserName#
			AND upper=#upperTagName#
	</delete>

	<!-- the resultMap needs the column subTagCount whose value is always 1, since a 
		user cannot	have the same relation twice -->
	<select id="getPickedConceptsForUser" parameterClass="String"
		resultMap="TagCommon.tagWithSubtags">
		SELECT upper AS tag_name, 
			lower AS subTag, 
			'1' AS subTagCount
		FROM tagtagrelations
		USE INDEX (username_picked_upperlcase_upper_lowerlcase_idx)
		WHERE user_name=#userName#
			AND picked=true
	</select>

	<!-- the resultMap needs the column subTagCount whose value is always 1, since a 
		user cannot	have the same relation twice -->
	<select id="getAllConceptsForUser" parameterClass="tagRelationParam"
		resultMap="TagCommon.tagWithSubtags">
		SELECT t.upper AS tag_name,
			t.lower AS subTag,
			'1' AS subTagCount
		FROM tagtagrelations t,
		(SELECT DISTINCT upper AS tag_name
			FROM tagtagrelations
			USE INDEX (username_upperlcase_upper_lowerlcase_idx)
			WHERE user_name=#requestedUserName#
			LIMIT #limit#
			OFFSET #offset#) AS r
		WHERE user_name=#requestedUserName#
		AND t.upper=r.tag_name;
	</select>

	<!-- the resultMap needs the column subTagCount whose value is always 1, since a 
		user cannot	have the same relation twice -->
	<select id="getConceptForUser" parameterClass="tagRelationParam"
		resultMap="TagCommon.tagWithSubtags">
		SELECT upper AS tag_name, 
			lower AS subTag,
			'1' as subTagCount
		FROM tagtagrelations
		WHERE user_name=#ownerUserName#
			AND upper_lcase=LCASE(#upperTagName#)
	</select>

	
	<select id="getAllConcepts" resultMap="TagCommon.tagWithSubtagsAndUserCount">
		SELECT tagCount.upper AS tag_name, 
			r.lower_lcase AS subTag, 
			tagCount.usercount AS user_count, 
			COUNT(r.lower_lcase) AS subTagCount
		FROM tagtagrelations r JOIN user u USING(user_name), 
			(SELECT upper_lcase AS upper, COUNT(DISTINCT user_name) AS usercount, 
			COUNT(upper_lcase COLLATE utf8_unicode_ci) AS count
			FROM tagtagrelations JOIN user u USING(user_name)
			WHERE u.spammer = 0
			GROUP BY upper COLLATE utf8_unicode_ci 
			ORDER BY usercount DESC, count DESC LIMIT 50
		) AS tagCount
		WHERE tagCount.upper=r.upper_lcase
			AND u.spammer = 0
		GROUP BY tagCount.upper, 
			r.lower_lcase
	</select>

	<select id="getGlobalConceptByName" parameterClass="String"
		resultMap="TagCommon.tagWithSubtags">
		SELECT upper_lcase AS tag_name, 
			lower_lcase AS subTag,
			COUNT(DISTINCT user_name) AS subTagCount
		FROM tagtagrelations JOIN user u USING(user_name)
		WHERE upper_lcase = LCASE(#conceptName#)
			AND u.spammer = 0
		GROUP BY upper_lcase, 
			lower_lcase
	</select>

	<select id="getRelationID" parameterClass="tagRelationParam"
		resultClass="string">
		SELECT relationID 
		FROM tagtagrelations 
		WHERE user_name = #ownerUserName# 
			AND lower = #lowerTagName#
			AND upper = #upperTagName# 
	</select>
	
	<update id="pickConcept" parameterClass="tagRelationParam">
		UPDATE tagtagrelations 
		SET picked = true
		WHERE user_name = #ownerUserName# 
			AND upper = #upperTagName#
	</update>
	
	<update id="unpickConcept" parameterClass="tagRelationParam">
		UPDATE tagtagrelations 
		SET picked = false
		WHERE user_name = #ownerUserName# 
			AND upper = #upperTagName#
	</update>
	
	<update id="pickAllConcepts" parameterClass="String">
		UPDATE tagtagrelations 
		SET picked = true
		WHERE user_name = #ownerUserName#
	</update>
	
	<update id="unpickAllConcepts" parameterClass="String">
		UPDATE tagtagrelations 
		SET picked = false
		WHERE user_name = #ownerUserName#
	</update>
</sqlMap>