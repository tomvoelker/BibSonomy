<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE sqlMap PUBLIC "-//iBATIS.com//DTD SQL Map 2.0//EN" "http://www.ibatis.com/dtd/sql-map-2.dtd">

<sqlMap namespace="Group">

	<select id="getAllGroups" resultMap="GroupCommon.group" parameterClass="groupParam">
		SELECT i.group, i.group_name, u.user_realname, u.user_homepage, u.user_name
		FROM groupids i, user u
		WHERE i.group > 2
		      AND i.group_name = u.user_name
		ORDER BY i.group_name
		LIMIT #limit# OFFSET #offset#
	</select>

	<select id="getGroupByName" resultMap="GroupCommon.group" parameterClass="string">
		SELECT i.group, i.group_name, u.user_realname, u.user_homepage, u.user_name
		FROM groupids i, user u
		WHERE i.group_name = #groupname#
		      AND i.group_name = u.user_name
	</select>

	<select id="getGroupMembers" resultMap="GroupCommon.group" parameterClass="string">
		SELECT i.group, i.group_name, u.user_realname, u.user_homepage, u.user_name
		FROM groupids i, groups g, user u
		WHERE group_name = #groupname#
		      AND i.group = g.group
		      AND i.group > 2
		      <!-- AND g.user_name != #requestedGroupName# -->
		      AND u.user_name = g.user_name
	</select>
	
	<select id="getFriendsOfUser" resultMap="UserCommon.user" parameterClass="string">
		SELECT u.user_name, u.user_email, u.user_homepage, u.user_realname, u.openUrl, u.api_key
		FROM user u, friends f
		WHERE f.user_name = #requestedUserName# AND u.user_name=f.f_user_name
		ORDER BY u.user_name
	</select>

	<select id="getPrivlevelForGroup" resultClass="int" parameterClass="int">
		SELECT privlevel FROM groupids WHERE `group` = #groupId#
	</select>

	<select id="getGroupsForUser" resultMap="GroupCommon.group_basic" parameterClass="string">
		(SELECT i.group_name, i.group
		 FROM groups g, groupids i
		 WHERE g.user_name = #username#
		       AND g.group=i.group)
		UNION
		(SELECT i.group_name, i.group
		 FROM groupids i
		 WHERE i.group BETWEEN 0 AND 2)
		ORDER BY `group`
	</select>
	
	<select id="getGroupsForContentId" resultMap="GroupCommon.group_basic" parameterClass="Integer">
		SELECT DISTINCT G.group, G.group_name 
		FROM groupids G, tas T 
		WHERE T.content_id = #contentId# 
		  AND T.group = G.group 
	</select>	
	
	<select id="getNewGroupId" resultClass="int">
		SELECT MAX(`group`) + 1 AS id FROM groupids
	</select>

	<insert id="insertGroup" parameterClass="group">
		INSERT INTO groupids (group_name, `group`, privlevel) VALUES (#name#, #groupId#, #privlevel#)
	</insert>

	<delete id="deleteGroup" parameterClass="int">
		DELETE FROM groupids WHERE `group` = #groupId#
	</delete>

	<insert id="addUserToGroup" parameterClass="group">
		INSERT INTO groups (user_name, `group`, defaultgroup) VALUES (#name#, #groupId#, #groupId#)
	</insert>

	<delete id="removeUserFromGroup" parameterClass="group">
		DELETE FROM groups WHERE `group` = #groupId# AND user_name = #name#
	</delete>

	<delete id="removeAllUserFromGroup" parameterClass="int">
		DELETE FROM groups WHERE `group` = #groupId#
	</delete>

</sqlMap>