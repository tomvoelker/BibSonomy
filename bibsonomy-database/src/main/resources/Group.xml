<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE sqlMap PUBLIC "-//iBATIS.com//DTD SQL Map 2.0//EN" "http://www.ibatis.com/dtd/sql-map-2.dtd">

<sqlMap namespace="Group">

	<select id="getAllGroups" resultMap="GroupCommon.group" parameterClass="groupParam">
		SELECT i.group, i.group_name, i.privlevel, i.sharedDocuments, <include refid="requestColumns" />, <include refid="reportingColumns" />, u.user_realname AS realname, u.user_homepage AS homepage
		FROM groupids i 
		  JOIN user u ON (i.group_name = u.user_name)
		WHERE i.group > 2
		ORDER BY i.group_name
		LIMIT #limit# OFFSET #offset#
	</select>
	
	<select id="getPendingGroup" resultMap="GroupCommon.group" parameterClass="String">
		SELECT i.group, i.group_name, i.privlevel, i.sharedDocuments, <include refid="requestColumns" />, <include refid="reportingColumns" />, u.user_realname AS realname, u.user_homepage AS homepage
		FROM pendingGroupids i 
		  JOIN pendingUser u ON (i.group_name = u.user_name)
		WHERE i.group_name = #groupname#
	</select>
	
	<select id="getPendingGroups" resultMap="GroupCommon.group" parameterClass="groupParam">
		SELECT i.group, i.group_name, i.privlevel, i.sharedDocuments, <include refid="requestColumns" />, <include refid="reportingColumns" />, u.user_realname AS realname, u.user_homepage AS homepage
		FROM pendingGroupids i 
		  JOIN pendingUser u ON (i.group_name = u.user_name)
		ORDER BY i.group_name
		LIMIT #limit# OFFSET #offset#
	</select>

	<select id="getGroupByName" resultMap="GroupCommon.group" parameterClass="string">
		SELECT i.group, i.group_name, i.privlevel, i.sharedDocuments, <include refid="requestColumns" />, <include refid="reportingColumns" />, u.user_realname AS realname, u.user_homepage AS homepage
		FROM groupids i 
		  JOIN user u ON (i.group_name = u.user_name)
		WHERE i.group_name = #groupname#
	</select>

	<select id="getGroupMembers" resultMap="GroupCommon.groupWithMembers" parameterClass="string">
		SELECT i.group, i.group_name, i.privlevel, i.sharedDocuments, u.user_realname, u.user_homepage, u.user_name, g.group_role, g.user_shared_documents
		FROM groupids i 
		  JOIN groups g USING (`group`) 
		  JOIN user u ON (u.user_name = g.user_name) 
		WHERE group_name = #groupname#
		  AND i.group > 2
		  <!-- AND g.user_name != #requestedGroupName# -->
	</select>

	<select id="getGroupMemberships" resultMap="GroupCommon.groupWithMemberships" parameterClass="string">
		SELECT i.group, i.group_name, i.privlevel, i.sharedDocuments, u.user_realname, u.user_homepage, u.user_name, g.group_role, g.user_shared_documents
		FROM groupids i 
		  JOIN groups g USING (`group`) 
		  JOIN user u ON (u.user_name = g.user_name) 
		WHERE group_name = #groupname#
		  AND i.group > 2
		  <!-- AND g.user_name != #requestedGroupName# -->
	</select>

	<select id="getPrivlevelForGroup" resultClass="Privlevel" parameterClass="int">
		SELECT privlevel FROM groupids WHERE `group` = #groupId#
	</select>

	<select id="getGroupsForUser" resultMap="GroupCommon.groupWithUserSharedDocumentsAndRole" parameterClass="string">
		(SELECT i.group_name, i.group, i.privlevel, i.sharedDocuments, <include refid="reportingColumns" />, g.user_shared_documents, g.group_role
		 FROM groups g
		   JOIN groupids i USING (`group`)
		 WHERE g.user_name = #username#
		)
		UNION
		(SELECT i.group_name, i.group, i.privlevel, i.sharedDocuments, NULL AS publ_reporting_mail, NULL AS publ_reporting_mail_template, NULL AS publ_reporting_external_url, FALSE AS user_shared_documents, 7 AS group_role
		 FROM groupids i
		 WHERE i.group BETWEEN 0 AND 2)
		ORDER BY `group`
	</select>

	<select id="getGroupsForContentId" resultMap="GroupCommon.group_basic" parameterClass="int">
		SELECT DISTINCT i.group, i.group_name, i.privlevel, i.sharedDocuments, FALSE as user_shared_documents 
		  FROM groupids i JOIN grouptas t USING (`group`) 
		  WHERE t.content_id = #contentId# 
	</select>	

	<select id="getNewGroupId" resultClass="int">
		SELECT MAX(g.id) + 1 AS id FROM
    		(SELECT MAX(`group`) AS id FROM groupids 
       		UNION 
       		SELECT MAX(`group`) AS id FROM pendingGroupids) AS g
	</select>

	<select id="getGroupIdsForUser" resultClass="int" parameterClass="string">
		SELECT `group` FROM groups WHERE user_name = #userName#
	</select>

	<select id="getGroupIdByGroupNameAndUserName" resultClass="int" parameterClass="group">
		SELECT g.group
		FROM groupids g <isNotNull property="user" prepend=",">groups i</isNotNull>
		WHERE g.group_name = #name#
		      <isNotNull property="user" prepend="AND">
		        i.user_name = #user.name#
		        AND i.group = g.group
		      </isNotNull>
	</select>

	<select id="getTagSetsForGroup" resultMap="GroupCommon.tagsets" parameterClass="string">
		SELECT set_name, tag_name 
		FROM groupids i
		  JOIN group_tagsets s USING (`group`)
		WHERE i.group_name = #groupname#
	</select>
	
	<select id="getTagSetBySetNameAndGroup" resultMap="GroupCommon.tagsets" parameterClass="tagSetParam">
		SELECT set_name, tag_name from group_tagsets s
		WHERE s.group = #groupId#
		AND s.set_name = #setName#
	</select>
	
	<insert id="activateGroup" parameterClass="string">
		INSERT INTO groupids (`group_name`,`request_user_name`,`request_reason`,`request_submission_date`, `group`, `privlevel`, `sharedDocuments`)
		SELECT `group_name`,`request_user_name`,`request_reason`,`request_submission_date`, `group`, `privlevel`, `sharedDocuments`
		FROM pendingGroupids 
		WHERE pendingGroupids.group_name = #name#
	</insert>
	
	<insert id="insertGroup" parameterClass="group">
		INSERT INTO pendingGroupids (group_name, `group`, privlevel, sharedDocuments, request_user_name, request_reason) VALUES (#name#, #groupId#, #privlevel#, #sharedDocuments#, #groupRequest.userName#, #groupRequest.reason#)
	</insert>

	<insert id="insertTagSet" parameterClass="tagSetParam">
		INSERT INTO group_tagsets (set_name, tag_name, `group`) VALUES (#setName#, #tagName#, #groupId#)
	</insert>

	<delete id="deleteGroup" parameterClass="int">
		DELETE FROM groupids WHERE `group` = #groupId#
	</delete>
	
	<delete id="deletePendingGroup" parameterClass="string">
		DELETE FROM pendingGroupids WHERE pendingGroupids.group_name = #groupname#
	</delete>

	<delete id="deleteTagSet" parameterClass="tagSetParam">
		DELETE FROM group_tagsets WHERE set_name = #setName# AND `group` = #groupId#
	</delete>

	<insert id="addUserToGroup" parameterClass="group">
		INSERT INTO groups (user_name, `group`, defaultgroup, `group_role`) VALUES (#name#, #groupId#, #groupId#, #groupRole.role#)
	</insert>

	<delete id="removeUserFromGroup" parameterClass="group">
		DELETE FROM groups WHERE `group` = #groupId# AND user_name = #name#
	</delete>

	<delete id="removeAllUserFromGroup" parameterClass="int">
		DELETE FROM groups WHERE `group` = #groupId#
	</delete>

	<select id="getGroupNameByGroupId" resultClass="String" parameterClass="int">
		SELECT group_name
		FROM groupids
		WHERE `group` = #groupId#
	</select>

	<update id="updateGroupSettings" parameterClass="group">
		UPDATE groupids 
		SET privlevel=#privlevel#, sharedDocuments=#sharedDocuments#
		WHERE `group` = #groupId#
	</update>
	
	<update id="updateGroupPublicationReportingSettings" parameterClass="group">
		UPDATE groupids
		SET	publ_reporting_mail = #publicationReportingSettings.reportingMailAddress#,
			publ_reporting_mail_template = #publicationReportingSettings.reportingMailTemplate#,
			publ_reporting_external_url = #publicationReportingSettings.externalReportingUrl#
		WHERE group_name = #name#
	</update>

	<update id="updateGroupRole" parameterClass="group">
		UPDATE groups 
		SET group_role=#groupRole.role#
		WHERE `group` = #groupId# AND `user_name` = #name#
	</update>
	
	<select id="countPerRole" resultClass="Integer" parameterClass="group">
		SELECT COUNT(*) FROM groups WHERE groups.group_role = #groupRole.role# AND groups.group = #groupId#;
	</select>
	
	<select id="getGroupRoleForUser" resultClass="GroupRole" parameterClass="group">
		SELECT group_role FROM groups WHERE groups.user_name = #name# AND groups.group = #groupId#;
	</select>
</sqlMap>
