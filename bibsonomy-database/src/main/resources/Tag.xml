<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE sqlMap PUBLIC "-//iBATIS.com//DTD SQL Map 2.0//EN" "http://www.ibatis.com/dtd/sql-map-2.dtd">

<sqlMap namespace="Tag">
	<typeAlias alias="tag" type="org.bibsonomy.model.Tag" />

	<resultMap id="tags" class="tag">
		<result property="id" column="tag_id" javaType="java.lang.Integer" />
		<result property="name" column="tag_name" javaType="java.lang.String" />
		<result property="stem" column="tag_stem" javaType="java.lang.String" />
		<result property="count" column="tag_ctr" javaType="java.lang.Integer" />
	</resultMap>

	<select id="getTagById" resultMap="tags" parameterClass="tagParam">
		SELECT tag_id, tag_name, tag_stem, tag_ctr
		FROM tags
		WHERE tag_id =#id#
	</select>

	<select id="getTagByCount" resultMap="tags" parameterClass="tagParam">
		SELECT tag_id, tag_name, tag_stem, tag_ctr
		FROM tags
		WHERE tag_ctr = #count#
	</select>
	
	<select id="getAllTags" resultClass="string" parameterClass="userParam">
	 SELECT tag_name  FROM tas t GROUP BY t.tag_name LIMIT #limit# OFFSET #offset#;
	</select>
	
 	<select id="getTagsViewable" resultClass="string" parameterClass="userParam">
	SELECT tag_name FROM tas t WHERE t.group = #groupType# GROUP BY t.tag_name LIMIT #limit# OFFSET #offset#;
	</select>
   
	<select id="getTagsByUser" resultClass="string" parameterClass="userParam">
   SELECT tag_name FROM tas t WHERE t.user_name = #requestedUserName#
   <include refid="getTagForUser"/> GROUP BY t.tag_name LIMIT #limit# OFFSET #offset#;
   </select>
   
	<select id="getTagsByGroup" resultClass="string" parameterClass="userParam">
	  SELECT tag_name FROM 
	 (
	 (SELECT
	 tag_name from tas t, groups g where g.group=#groupId# AND g.user_name=t.user_name
     <include refid="lookinGroupsForTags"/>) 
     UNION
     (
     SELECT
     tag_name from tas t,groups g, friends f WHERE f.f_user_name=#userName# AND g.user_name=f.user_name AND t.user_name=f.user_name AND g.group=#groupId# AND t.group=$groupType$)     
     UNION
     (SELECT
     tag_name FROM  tas t, groups g WHERE t.user_name=#userName# AND g.user_name = t.user_name AND g.group = #groupId#)) as tagsalias
     GROUP BY tag_name LIMIT #limit# OFFSET #offset#;
	</select>
	
    <!-- noch an TagParam anpassen für das Einfügen von Bookmark bzw Bibtex Objekten -->
	
	<insert id="insertTag" parameterClass="tag">
    	INSERT INTO tags (tag_name, tag_ctr)
    	VALUES (#name#,1)
    	ON DUPLICATE KEY UPDATE tag_ctr = tag_ctr+1
	</insert>

	<insert id="insertTagTag" parameterClass="tag">
		INSERT INTO tags (tag_name, tag_name, tag_ctr)
		VALUES (#name#, #name#, 1)
		ON DUPLICATE KEY UPDATE tag_ctr = tag_ctr+1
    <!--UPDATE tags SET tag_ctr=tag_ctr+1 WHERE tag_name = ?-->
	</insert>
	
	
	
	
	
	
</sqlMap>