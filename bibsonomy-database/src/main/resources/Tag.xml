<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE sqlMap PUBLIC "-//iBATIS.com//DTD SQL Map 2.0//EN" "http://www.ibatis.com/dtd/sql-map-2.dtd">

<sqlMap namespace="Tag">

	<select id="getTagById" resultMap="TagCommon.tagWithDetails" parameterClass="int">
		SELECT T.tag_id, TAS.tag_name, count(TAS.tag_name) as tag_ctr 
		FROM tags T, tas TAS 
		WHERE T.tag_name=TAS.tag_name AND
			  (TAS.user_name=#requestedUserName# OR TAS.group=0) AND			  
			  T.tag_id = #id#
		GROUP BY TAS.tag_name
	</select>

	<select id="getTagByName" resultMap="TagCommon.tagWithGlobalCount" parameterClass="tagParam">
		SELECT t1.tag_name, count(t1.tag_name) as tag_ctr 
		FROM <include refid="tagFromQuery"/>
		WHERE <include refid="tagWhereQuery"/> AND
			  (t1.user_name=#requestedUserName# OR
			  t1.group=0)
		GROUP BY t1.tag_name
		LIMIT #limit# OFFSET #offset#
	</select>	

	<select id="getTagByCount" resultMap="TagCommon.tagWithGlobalCount" parameterClass="tagParam">
		SELECT DISTINCT T.tag_name, T.tag_ctr  
		FROM tags T, tas TAS  
		WHERE T.tag_name=TAS.tag_name AND 
		      T.tag_ctr=#count# AND 
		      (TAS.group=0 OR TAS.user_name=#requestedUserName#)
		LIMIT #limit# OFFSET #offset#	      
	</select>

	<select id="getAllTags" resultMap="TagCommon.tagWithGlobalCount" parameterClass="tagParam">
		<!--  SELECT tag_name, count(tag_name) AS tag_count FROM tas t GROUP BY t.tag_name LIMIT #limit# OFFSET #offset# -->
		<!--  up to now, a user can see his own tags as well as public tags -->
		SELECT TAS.tag_name, count(TAS.tag_name) as tag_ctr 
		FROM tas TAS 
		WHERE TAS.user_name=#requestedUserName# OR
			  TAS.group=0
		GROUP BY TAS.tag_name
		HAVING tag_ctr > 0
		LIMIT #limit# OFFSET #offset#
	</select>

	<select id="getTagsByExpression" resultMap="TagCommon.tagWithGlobalCount" parameterClass="tagParam">
		SELECT TAS.tag_name, count(TAS.tag_name) as tag_ctr 
		FROM tas TAS 
		WHERE (TAS.user_name=#requestedUserName# OR
			  TAS.group=0) AND
			  TAS.tag_name REGEXP #regex#
		GROUP BY TAS.tag_name
		LIMIT #limit# OFFSET #offset#		
	</select>

 	<select id="getTagsViewable" resultMap="TagCommon.tagWithGlobalCount" parameterClass="tagParam">
		SELECT tag_name, count(tag_name) AS tag_ctr 
		FROM tas t
		WHERE t.group = #groupType#
		GROUP BY t.tag_name LIMIT #limit# OFFSET #offset#
	</select>

	<select id="getTagsByUser" resultMap="TagCommon.tagWithGlobalCount" parameterClass="tagParam">
		SELECT tag_name, count(tag_name) AS tag_ctr FROM tas t WHERE t.user_name = #requestedUserName#
		<include refid="getTagForUser"/> GROUP BY t.tag_name LIMIT #limit# OFFSET #offset#
	</select>

	<select id="getTagsByGroup" resultMap="TagCommon.tagWithGlobalCount" parameterClass="tagParam">
		SELECT tag_name, count(tag_name) AS tag_ctr FROM 
		((SELECT tag_name
		  FROM tas t, groups g
		  WHERE g.group = #groupId# AND g.user_name=t.user_name
		  <include refid="lookinGroupsForTags"/>) 
		 UNION
		 (SELECT tag_name
		  FROM tas t, groups g, friends f
		  WHERE f.f_user_name = #userName# AND g.user_name = f.user_name
		        AND t.user_name = f.user_name AND g.group = #groupId# AND t.group = $groupType$)     
		 UNION
		 (SELECT tag_name
		  FROM tas t, groups g
		  WHERE t.user_name = #userName# AND g.user_name = t.user_name
		        AND g.group = #groupId#)) AS tagsalias
		GROUP BY tag_name LIMIT #limit# OFFSET #offset#
	</select>


	<select id="getSubtagsOfTag" resultMap="TagCommon.tagWithGlobalCount" parameterClass="tagParam">
		SELECT t1.tag_name, count(distinct(t1.tas_id)) as tag_ctr 
		FROM tas t1, tagtagrelations TTR 
		WHERE TTR.upper = <iterate property="tagIndex">#tagIndex[].tagName#</iterate> AND 
                TTR.lower = t1.tag_name AND
                (t1.group=0 OR t1.user_name = #requestedUserName#)
		GROUP BY t1.tag_name
		LIMIT #limit# OFFSET #offset#
	</select>

	<select id="getSupertagsOfTag" resultMap="TagCommon.tagWithGlobalCount" parameterClass="tagParam">
		SELECT t1.tag_name, count(distinct(t1.tas_id)) as tag_ctr 
		FROM tas t1, tagtagrelations TTR 
		WHERE TTR.lower = <iterate property="tagIndex">#tagIndex[].tagName#</iterate> AND 
                TTR.upper = t1.tag_name AND
                (t1.group=0 OR t1.user_name = #requestedUserName#)
		GROUP BY t1.tag_name
		LIMIT #limit# OFFSET #offset#
	</select>
	
	<!-- noch an TagParam anpassen für das Einfügen von Bookmark bzw Bibtex Objekten -->
	<insert id="insertTag" parameterClass="tag">
		INSERT INTO tags (tag_name, tag_ctr) VALUES (#name#, 1) ON DUPLICATE KEY UPDATE tag_ctr = tag_ctr + 1
	</insert>

	<!-- FIXME: this looks weird
	<insert id="insertTagTag" parameterClass="tag">
		INSERT INTO tags (tag_name, tag_name, tag_ctr)
		VALUES (#name#, #name#, 1)
		ON DUPLICATE KEY UPDATE tag_ctr = tag_ctr+1
	</insert>
	-->

	<insert id="insertTagTagBatch" parameterClass="tagTagBatchParam">
		INSERT INTO tagtag_batch (content_id, tags, toinc) VALUES (#contentId#, #tagList#, #jobInteger#)
	</insert>

	<update id="updateTagDec" parameterClass="string">
		UPDATE tags SET tag_ctr = tag_ctr - 1 WHERE tag_name = #tagName#
	</update>
	

	
	

</sqlMap>