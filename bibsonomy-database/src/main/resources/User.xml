<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE sqlMap PUBLIC "-//iBATIS.com//DTD SQL Map 2.0//EN" "http://www.ibatis.com/dtd/sql-map-2.dtd">

<sqlMap namespace="User">

	<select id="getAllUsers" resultMap="Common.user" parameterClass="userParam">
		SELECT <include refid="commonUserAttributes"/> 
		FROM user 
		WHERE spammer = 0 LIMIT #limit# OFFSET #offset#
	</select>

	<select id="getUserDetails" resultMap="UserCommon.userWithSettings" parameterClass="string">
		SELECT <include refid="allUserAttributes"/>
		FROM user
		WHERE user_name = #username#
	</select>

	<select id="getUserNamesByGroupId" resultClass="string" parameterClass="int">
		SELECT user_name 
		FROM groups 
		WHERE `group` = $groupId$
	</select>

	<!-- TODO: insert other attributes (see allUserAtributes in UserCommon.xml); dbe 20071119 -->
	<insert id="insertUser" parameterClass="user">
		INSERT INTO user ( 
			user_name, user_email, user_password, user_realname, user_homepage, 
			api_key, birthday, gender, hobbies, interests, ip_address, openurl, place, profession, reg_date, 
			spammer, updated_by, updated_at, role, to_classify, lang, tagbox_style, tagbox_sort, tagbox_minfreq, 
			tagbox_tooltip, list_itemcount, log_level, confirmDelete
			<isNotNull property="reminderPassword">,tmp_password, tmp_request_date</isNotNull>			   
			)
		VALUES (
			#name#, #email#, #password#, #realname#, #homepage#, 
			#apiKey#, #birthday#, #gender#, #hobbies#, #interests#, #IPAddress#, #openURL#, #place#, #profession#, #registrationDate#, 
			#spammer#,#updatedBy#, #updatedAt#, #role#, #toClassify#, #settings.defaultLanguage#, #settings.tagboxStyle#, #settings.tagboxSort#, #settings.tagboxMinfreq#, 
			#settings.tagboxTooltip#, #settings.listItemcount#, #settings.logLevel#, #settings.confirmDelete#
			<isNotNull property="reminderPassword">,#reminderPassword#,#reminderPasswordRequestDate#</isNotNull>	
			)
	</insert>
	
	<insert id="insertOpenIDUser" parameterClass="user">
		INSERT INTO openIDUser 
		VALUES (#name#, #openID#)
	</insert>	

	<delete id="deleteUser" parameterClass="string">
		DELETE FROM user WHERE user_name = #userName#
	</delete>
	
	<delete id="deleteOpenIDUser" parameterClass="string">
		DELETE FROM openIDUser WHERE user_name = #userName#
	</delete>	
	
	<select id="getOpenIDUser" resultClass="string" parameterClass="string"> 
		SELECT user_name FROM openIDUser WHERE openID = #openID#
	</select>

	<select id="getUserSettings" resultMap="UserCommon.userSettings" parameterClass="userParam">
		SELECT <include refid="userSettingsAttributes"/>
		FROM user 
		WHERE user_name = #userName#
	</select>
	
	<update id="updateUserProfile" parameterClass="user">
		UPDATE user 
		SET birthday = #birthday#, 
		user_realname = #realname#,
		gender = #gender#,
		user_email = #email#,
		user_homepage = #homepage#,
		openurl = #openURL#,
		profession = #profession#,
		interests = #interests#,
		hobbies = #hobbies#,
		place = #place#
		WHERE user_name = #name#
	</update>
	
	<update id="updateUserSettings" parameterClass="user">
		UPDATE user 
		SET log_level = #settings.logLevel#, 
		lang = #settings.defaultLanguage#,
		list_itemcount = #settings.listItemcount#,
		tagbox_tooltip = #settings.tagboxTooltip#,
		tagbox_minfreq = #settings.tagboxMinfreq#,
		tagbox_sort = #settings.tagboxSort#,
		tagbox_style = #settings.tagboxStyle#,
		confirmDelete = #settings.confirmDelete#
		WHERE user_name = #name#
	</update>

	<select id="getApiKeyForUser" resultClass="string" parameterClass="string">
		SELECT api_key 
		FROM user 
		WHERE user_name = #userName#
	</select>

	<update id="updateApiKeyForUser" parameterClass="user">
		UPDATE user 
		SET api_key = #apiKey# 
		WHERE user_name = #name#
	</update>
	
    <update id="updatePasswordForUser" parameterClass="user">
		UPDATE user 
		SET user_password = #password# 
		WHERE user_name = #name#
	</update>

	<select id="getRelatedUsersByFolkrankAndTags" resultMap="UserCommon.userWithWeight" parameterClass="userParam"> 
		SELECT w.item AS user_name, ROUND(SUM(weight),5) * 10000 AS weight
		FROM rankings r
			JOIN weights w USING (id)
			WHERE (<iterate property="tagIndex" conjunction=" OR ">r.item = #tagIndex[].tagName#</iterate>) AND r.dim = 0
			AND w.dim = 1 AND w.itemtype = 0
		GROUP BY w.item
		HAVING weight > 1
		ORDER BY 2 DESC
		LIMIT #limit# OFFSET #offset#
	</select>
	
	<select id="getRelatedUsersByFolkrankAndUser" resultMap="UserCommon.userWithWeight" parameterClass="userParam"> 
		SELECT w.item AS user_name, ROUND(weight,5) * 10000 AS weight
		FROM rankings r
			JOIN weights w USING (id)
			WHERE r.item=#requestedUserName# AND r.dim = 1
			AND w.dim = 1
			AND w.item != #requestedUserName#
			<isNotNull property="userName">
			AND w.item NOT IN (SELECT f_user_name FROM followers WHERE user_name=#userName#)
			</isNotNull> 
		ORDER BY 2 DESC
		LIMIT #limit#
	</select>	
	
	<select id="getRelatedUsersBySimilarity" resultMap="UserCommon.userWithWeight" parameterClass="userParam">
		SELECT u2 AS user_name, sim * 10 AS weight 
		FROM useruser_similarity 
		WHERE measure_id = #userRelation.id# 
		AND u1 = #requestedUserName#
		AND u2 != #requestedUserName#
		<isNotNull property="userName">		
		AND u2 NOT IN (SELECT f_user_name FROM followers WHERE user_name=#userName#)
		</isNotNull>
		ORDER by 2 DESC 
		LIMIT #limit# OFFSET #offset#
	</select>
	

	<!-- get all users u, which have user in their friend list (user, u)\in FRIEND_OF-->
	<select id="getRelation_FRIEND_OF" resultMap="Common.user"	parameterClass="string">
		SELECT user_name FROM friends WHERE f_user_name = #username#
	</select>
	
	<!-- get all users, which user has in his friend list (user, u)\in OF_FRIEND-->
	<select id="getRelation_OF_FRIEND" resultMap="Common.user" parameterClass="string">
		SELECT f_user_name AS user_name FROM friends WHERE user_name = #username#
	</select>
	
	<!-- get all users, that follow the user (user, u)\in OF_FOLLOWER-->
	<select id="getRelation_OF_FOLLOWER" resultMap="Common.user"	parameterClass="string">
		SELECT user_name FROM followers WHERE f_user_name = #username#
	</select>
	
	<!-- get all users u, which user follows (user, u)\in FOLLOWER_OF-->
	<select id="getRelation_FOLLOWER_OF" resultMap="Common.user" parameterClass="string">
		SELECT f_user_name AS user_name FROM followers WHERE user_name = #username#
	</select>

	<!-- delete (userName, requestedUserName) from OF_FRIEND-->
	<delete id="deleteRelation_OF_FRIEND" parameterClass="userParam">
		DELETE FROM friends WHERE f_user_name = #requestedUserName# and user_name = #userName#
	</delete>

	<!-- insert (userName, requestedUserName) into OF_FRIEND-->
	<insert id="insertRelation_OF_FRIEND" parameterClass="userParam">
		INSERT IGNORE INTO friends (user_name, f_user_name, friendship_date) VALUES (#userName#,#requestedUserName#,NOW())
	</insert>
	
	<!-- delete (userName, requestedUserName) from FOLLOWER_OF-->
	<delete id="deleteRelation_FOLLOWER_OF" parameterClass="userParam">
		DELETE FROM followers WHERE f_user_name = #requestedUserName# and user_name = #userName#
	</delete>
	
	<!-- insert (userName, requestedUserName) into FOLLOWER_OF-->
	<insert id="insertRelation_FOLLOWER_OF" parameterClass="userParam">
		INSERT IGNORE INTO followers (user_name, f_user_name, fellowship_date) VALUES (#userName#,#requestedUserName#,NOW())
	</insert>
	

</sqlMap>