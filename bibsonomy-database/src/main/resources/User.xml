<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE sqlMap PUBLIC "-//iBATIS.com//DTD SQL Map 2.0//EN" "http://www.ibatis.com/dtd/sql-map-2.dtd">

<sqlMap namespace="User">

	<select id="getAllUsers" resultMap="Common.user" parameterClass="userParam">
		SELECT <include refid="commonUserAttributes"/> 
		FROM user 
		WHERE spammer = 0 LIMIT #limit# OFFSET #offset#
	</select>

	<select id="getUserDetails" resultMap="UserCommon.userWithSettings" parameterClass="string">
		SELECT <include refid="allUserAttributes"/>
		FROM user
		WHERE user_name = #username#
	</select>

	<select id="getUserNamesByGroupId" resultClass="string" parameterClass="int">
		SELECT user_name 
		FROM groups 
		WHERE `group` = $groupId$
	</select>

	<!-- TODO: insert other attributes (see allUserAtributes in UserCommon.xml); dbe 20071119 -->
	<insert id="insertUser" parameterClass="user">
		INSERT INTO user ( 
			user_name, user_email, user_password, user_realname, user_homepage, 
			api_key, birthday, gender, hobbies, interests, ip_address, openurl, place, profession, reg_date, 
			spammer, updated_by, updated_at, role, to_classify, lang, tagbox_style, tagbox_sort, tagbox_minfreq, 
			tagbox_tooltip, list_itemcount, log_level
			<isNotNull property="reminderPassword">,tmp_password, tmp_request_date</isNotNull>			   
			)
		VALUES (
			#name#, #email#, #password#, #realname#, #homepage#, 
			#apiKey#, #birthday#, #gender#, #hobbies#, #interests#, #IPAddress#, #openURL#, #place#, #profession#, #registrationDate#, 
			#spammer#,#updatedBy#, #updatedAt#, #role#, #toClassify#, #settings.defaultLanguage#, #settings.tagboxStyle#, #settings.tagboxSort#, #settings.tagboxMinfreq#, 
			#settings.tagboxTooltip#, #settings.listItemcount#, #settings.logLevel#
			<isNotNull property="reminderPassword">,#reminderPassword#,#reminderPasswordRequestDate#</isNotNull>	
			)
	</insert>
	
	<insert id="insertOpenIDUser" parameterClass="user">
		INSERT INTO openIDUser 
		VALUES (#name#, #openID#)
	</insert>	

	<delete id="deleteUser" parameterClass="string">
		DELETE FROM user WHERE user_name = #userName#
	</delete>
	
	<delete id="deleteOpenIDUser" parameterClass="string">
		DELETE FROM openIDUser WHERE user_name = #userName#
	</delete>	
	
	<select id="getOpenIDUser" resultClass="string" parameterClass="string"> 
		SELECT user_name FROM openIDUser WHERE openID = #openID#
	</select>

	<select id="getUserSettings" resultMap="UserCommon.userSettings" parameterClass="userParam">
		SELECT <include refid="userSettingsAttributes"/>
		FROM user 
		WHERE user_name = #userName#
	</select>

	<select id="getApiKeyForUser" resultClass="string" parameterClass="string">
		SELECT api_key 
		FROM user 
		WHERE user_name = #userName#
	</select>

	<update id="updateApiKeyForUser" parameterClass="user">
		UPDATE user 
		SET api_key = #apiKey# 
		WHERE user_name = #name#
	</update>

	<select id="getUsersOrderedByFolkrank" resultMap="UserCommon.userWithWeight" parameterClass="userParam"> 
		SELECT w.item AS user_name, ROUND(SUM(weight),5) * 10000 AS weight
		FROM rankings r
			JOIN weights w USING (id)
			WHERE (<iterate property="tagIndex" conjunction=" OR ">r.item = #tagIndex[].tagName#</iterate>) AND r.dim = 0
			AND w.dim = 1 AND w.itemtype = 0
		GROUP BY w.item
		HAVING weight > 1
		ORDER BY 2 DESC
		LIMIT #limit#
	</select>

</sqlMap>