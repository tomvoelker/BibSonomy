<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE sqlMap PUBLIC "-//iBATIS.com//DTD SQL Map 2.0//EN" "http://www.ibatis.com/dtd/sql-map-2.dtd">

<sqlMap namespace="GoldStandard">

	<select id="getGoldStandardByHash" resultMap="GoldStandardPublicationCommon.goldStandardPost" parameterClass="resourceParam">
		SELECT <include refid ="allGoldStandardPublicationAttributesWithSimHashesAndContentId"/>, 1 AS count, content_type, <include refid="reviewRatingsRows" /> FROM gold_standard b
		LEFT JOIN review_ratings_cache c ON c.interHash = b.simhash1
		WHERE b.simhash1 = #hash# AND b.content_type = #contentType# ORDER BY b.date DESC
	</select>
	
	<select id="getGoldStandardRelated" resultMap="GoldStandardPublicationCommon.abstractResource" parameterClass="resourceParam">
		SELECT <include refid ="allGoldStandardPublicationAttributesWithSimHashes"/>, scraperid, 1 AS count, -1 AS rating, -1 AS number_of_ratings FROM (gold_standard b, gold_standard_relations r)
		WHERE r.publication = #hash# AND b.simhash1 = r.reference AND r.relation_kind = #relation# ORDER BY b.title DESC
	</select>
	
	<select id="getGoldStandardRelatedBy" resultMap="GoldStandardPublicationCommon.abstractResource" parameterClass="resourceParam">
		SELECT <include refid ="allGoldStandardPublicationAttributesWithSimHashes"/>, scraperid, 1 AS count, -1 AS rating, -1 AS number_of_ratings FROM (gold_standard b, gold_standard_relations r)
		WHERE r.reference = #hash# AND b.simhash1 = r.publication AND r.relation_kind = #relation# ORDER BY b.title DESC
	</select>
	
	<insert id="insertGoldStandardPublication" parameterClass="bibtexParam">
		INSERT INTO gold_standard (<include refid ="allGoldStandardPublicationColumns"/>, content_id)
		VALUES (<include refid ="allGoldStandardPublicationValues"/>, #requestedContentId#)
	</insert>
	
	<insert id="insertGoldStandardBookmark" parameterClass="bookmarkParam">
		INSERT INTO gold_standard (<include refid ="allGoldStandardBookmarkColumns"/>, content_id)
		VALUES (<include refid ="allGoldStandardBookmarkValues"/>, #requestedContentId#)
	</insert>
	
	<delete id="deleteGoldStandard" parameterClass="resourceParam">
		DELETE FROM gold_standard WHERE simhash1 = #hash# AND content_type = #contentType#
	</delete>
	
	<insert id="insertGoldStandardRelation">
		INSERT INTO gold_standard_relations (publication, reference, user_name, relation_kind) VALUES (#hash#, #refHash#, #username#, #relation#)
	</insert>
	
	<!-- be careful hash or refHash must be not null!!! or you delete everything -->
	<delete id="deleteGoldStandardRelation">
		DELETE FROM gold_standard_relations WHERE publication = #hash# AND reference = #refHash# AND relation_kind = #relation#
	</delete>
	
</sqlMap>