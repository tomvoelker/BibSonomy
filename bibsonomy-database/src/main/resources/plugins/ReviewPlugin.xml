<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE sqlMap PUBLIC "-//iBATIS.com//DTD SQL Map 2.0//EN" "http://www.ibatis.com/dtd/sql-map-2.dtd">

<sqlMap namespace="ReviewPlugin">
	<insert id="updateReviewRatingsCacheInsert" parameterClass="reviewParam">
		INSERT INTO review_ratings_cache (interHash, number_of_ratings, rating_arithmetic_mean) VALUES (#interHash#, 1 , #review.rating#)
  			ON DUPLICATE KEY UPDATE rating_arithmetic_mean = (rating_arithmetic_mean * number_of_ratings + #review.rating#)/(number_of_ratings + 1), number_of_ratings = number_of_ratings + 1;
	</insert>
	
	<!-- COALASCE the result because devision by zero returns null -->
	<update id="updateReviewRatingsCacheDelete" parameterClass="reviewParam">
		UPDATE review_ratings_cache SET rating_arithmetic_mean = COALESCE((rating_arithmetic_mean * number_of_ratings - #review.rating#)/(number_of_ratings - 1), 0), number_of_ratings = number_of_ratings - 1 WHERE interHash = #interHash#
	</update>
	
	<delete id="deleteAllHelpfulMarks" parameterClass="reviewParam">
		DELETE FROM reviews_helpful WHERE user_name = #review.user.name# AND interHash = #interHash#
	</delete>
	
	<delete id="deleteAllUserReviews" parameterClass="string">
		DELETE FROM reviews WHERE user_name = #username#
	</delete>
	
	<delete id="deleteAllUserMarks" parameterClass="string">
		DELETE FROM reviews_helpful WHERE user_name = #userName#
	</delete>
	
	<delete id="deleteAllMarksOfUser" parameterClass="string">
		DELETE FROM reviews_helpful WHERE mark_user_name = #userName#
	</delete>
</sqlMap>
