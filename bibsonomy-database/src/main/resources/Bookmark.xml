<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE sqlMap PUBLIC "-//iBATIS.com//DTD SQL Map 2.0//EN" "http://www.ibatis.com/dtd/sql-map-2.dtd">

<sqlMap namespace="Bookmark">

	<select id="getBookmarkByTagNames" resultMap="BookmarkCommon.bookmarkPost" parameterClass="bookmarkParam">
		SELECT <include refid="bookmarkAttributes"/>, t.tag_name, u.book_url, u.book_url_ctr  count, NULL AS `group`, NULL AS group_name
		FROM bookmark b, urls u, tas t,
		     (SELECT t1.content_id 
		      FROM <include refid="tagFromQuery"/>
		      WHERE <include refid="tagWhereQuery"/>
			        AND t1.content_type = #contentType#
			        AND t1.group = #groupType#
		      ORDER BY t1.date DESC
		      LIMIT #limit# OFFSET #offset#) AS tt
		WHERE b.content_id = tt.content_id 
		      AND t.content_id = tt.content_id 
			  AND b.book_url_hash = u.book_url_hash
		ORDER BY b.date DESC, b.content_id DESC
	</select>

	<select id="getBookmarkByTagNamesForUser" resultMap="BookmarkCommon.bookmarkPost" parameterClass="bookmarkParam">
		SELECT a.content_id, t.tag_name, a.book_url, a.book_url_hash as interHash,a.book_url_hash as intraHash, a.book_description as title, a.book_extended as description,
		       a.date, a.book_url_ctr as count, t.user_name, g.group, g.group_name
		FROM (SELECT b.content_id, u.book_url, b.book_url_hash, b.book_description as title, b.book_extended as description,
		             b.date, u.book_url_ctr, b.group
		      FROM bookmark b, urls u, <include refid="tagFromQuery"/>
		      WHERE <include refid="tagWhereQuery"/>
		            <include refid="getPostForUser2"/>
		            AND t1.content_type = #contentType#
		            AND t1.user_name = #requestedUserName#
		            AND b.book_url_hash = u.book_url_hash
		            AND t1.content_id = b.content_id
		      ORDER BY t1.date DESC
		      LIMIT #limit# OFFSET #offset#) AS a
		LEFT OUTER JOIN tas AS t ON a.content_id = t.content_id, groupids AS g
		WHERE a.group = g.group
		ORDER BY a.date DESC, a.content_id DESC
	</select>

	<select id="getBookmarkByConceptForUser" resultMap="BookmarkCommon.bookmarkPost" parameterClass="bookmarkParam">
		SELECT a.content_id, t.tag_name, a.book_url, a.book_url_hash as interhash, a.book_url_hash as intrahash, a.book_description as title, a.book_extended as description,
		       a.date, a.book_url_ctr as count, gi.group_name, t.user_name, gi.group
		FROM (SELECT DISTINCT b.content_id, u.book_url, b.book_url_hash, b.book_description as title, b.book_extended as description,
		                      b.date, u.book_url_ctr, b.group
		      FROM bookmark b, urls u, <include refid="tagFromQuery"/>
		      WHERE <include refid="tagWhereQuery"/>
		            <include refid="inGroups"/>
		            AND t1.content_type = #contentType#
		            AND t1.user_name = #userName#
		            AND b.book_url_hash = u.book_url_hash
		            AND t1.content_id = b.content_id
		      GROUP BY b.content_id
		      ORDER BY t1.date DESC
		      LIMIT #limit# OFFSET #offset#) AS a
		LEFT OUTER JOIN tas AS t ON a.content_id = t.content_id, groupids gi
		WHERE a.group = gi.group
		ORDER BY a.date DESC, a.content_id DESC
	</select>

	<select id="getBookmarkForHomepage" resultMap="BookmarkCommon.bookmarkPost" parameterClass="bookmarkParam">
		SELECT bb.content_id, bb.intraHash, bb.interHash, bb.book_description as title, bb.book_extended as description, bb.date, bb.user_name,
		       bb.book_url, bb.book_url_ctr as count, t.tag_name, NULL as `group`, NULL AS group_name
		FROM (SELECT <include refid="bookmarkAttributes"/>, u.book_url, u.book_url_ctr 
		      FROM bookmark b, urls u
		      WHERE b.group = #groupType#
		            AND u.book_url_hash = b.book_url_hash
		      ORDER BY date DESC
		      LIMIT 20) AS bb
		LEFT OUTER JOIN tas AS t ON bb.content_id = t.content_id
		ORDER BY bb.date DESC, bb.content_id DESC
	</select>

	<select id="getBookmarkPopular" resultMap="BookmarkCommon.bookmarkPost" parameterClass="bookmarkParam">
		SELECT <include refid="bookmarkAttributes"/>, t.tag_name, u.book_url, u.book_url_ctr AS count, NULL AS `group`, NULL AS group_name
		FROM temp_bookmark b
		LEFT OUTER JOIN tas AS t ON t.content_id = b.content_id, urls u
		WHERE u.book_url_hash = b.book_url_hash
		ORDER BY b.rank
	</select>

	<select id="getBookmarkByUserFriends" resultMap="BookmarkCommon.bookmarkPost" parameterClass="bookmarkParam">
		SELECT bb.content_id, b.book_url_hash, b.book_description as title, b.book_extended as description, bb.date, u.book_url,
		       u.book_url_ctr, t.tag_name, g.group_name, t.user_name
	    FROM urls u, bookmark b,
	         (SELECT content_id, date                 <!-- bookmarks from users of group which currUser may see -->
	          FROM bookmark b, friends f
	          WHERE f.f_user_name = #userName#        <!-- to see, which users have currUser as friend -->
	                AND b.user_name = f.user_name     <!-- take alle rows, which are owned by friend -->
	                AND b.group = #groupType#
	   	      ORDER BY date DESC
       	      LIMIT #limit# OFFSET #offset#) AS bb
	   	LEFT OUTER JOIN tas AS t ON bb.content_id = t.content_id, groupids AS g  <!-- join with tas -->
		WHERE t.group = g.group                                                  <!-- join groupname -->
		      AND u.book_url_hash = b.book_url_hash                              <!-- join url -->
		      AND b.content_id = bb.content_id                                   <!-- join title, description, ... -->
		ORDER BY bb.date DESC, bb.content_id DESC
	</select>

	<select id="getBookmarkByHash" resultMap="BookmarkCommon.bookmarkPost" parameterClass="bookmarkParam">
		SELECT b.content_id, t.tag_name, b.book_description as title, b.book_extended as description, b.user_name, b.date, 
		       b.book_url_hash as interHash, b.book_url_hash as intraHash, u.book_url, u.book_url_ctr as count, NULL AS group_name, NULL as `group`
		FROM (SELECT book_url_hash, book_description as title, book_extended as description, user_name, date,content_id
		      FROM bookmark
		      WHERE book_url_hash = #hash#
		            AND bookmark.group = #groupType#
		      ORDER BY date DESC
		      LIMIT #limit# OFFSET #offset#) AS b
		LEFT OUTER JOIN tas t ON b.content_id = t.content_id, urls u
		WHERE b.book_url_hash = u.book_url_hash
		ORDER BY b.date DESC,b.content_id DESC
	</select>

	<select id="getBookmarkByHashCount" resultClass="int" parameterClass="bookmarkParam">	
		SELECT count(*) FROM bookmark WHERE book_url_hash = #hash# AND bookmark.group = #groupType#
	</select>

	<select id="getBookmarkByHashForUser" resultMap="BookmarkCommon.bookmarkPost" parameterClass="bookmarkParam">
		SELECT g.*,bb.content_id, t.tag_name, bb.book_description as title, bb.book_extended as description, bb.user_name, bb.date,
		       bb.book_url_hash AS interhash,bb.book_url_hash AS intrahash, u.book_url, u.book_url_ctr as count, g.group_name
		FROM (SELECT book_url_hash, book_description as title, book_extended as description, user_name, date, content_id, b.group
		      FROM bookmark b
		      WHERE book_url_hash = #hash#
		            <include refid="inGroups"/>
		            AND user_name = #requestedUserName#
		      ORDER BY date DESC) AS bb
		LEFT OUTER JOIN tas t ON bb.content_id = t.content_id, urls u, groupids g
		WHERE bb.book_url_hash = u.book_url_hash
		      AND bb.group = g.group
		ORDER BY bb.date DESC, bb.content_id DESC
	</select>

	<select id="getBookmarkSearch" resultMap="BookmarkCommon.bookmarkPost" parameterClass="bookmarkParam">
		SELECT bb.content_id, bb.book_url_hash, bb.book_description as title, bb.book_extended as description, bb.date,
		       bb.user_name, bb.book_url, bb.book_url_ctr, t.tag_name
		FROM (SELECT b.content_id, b.book_url_hash, b.book_description as title, b.book_extended as description, b.date,
		             b.user_name, u.book_url, u.book_url_ctr
		      FROM bookmark b, urls u, search s
		      WHERE s.group = #groupType#
		            AND MATCH (s.content) AGAINST (#search# IN BOOLEAN MODE)
		            AND s.content_type = #contentType#
		            AND u.book_url_hash = b.book_url_hash
		            AND s.content_id = b.content_id
		            <isNotNull property="requestedUserName" prepend="AND">
		              s.user_name = #requestedUserName#
		            </isNotNull>
		      ORDER BY s.date DESC
		      LIMIT #limit# OFFSET #offset#) AS bb
		LEFT OUTER JOIN tas AS t ON t.content_id = bb.content_id
		ORDER BY bb.date DESC, bb.content_id
	</select>

	<select id="getBookmarkSearchCount" resultClass="int" parameterClass="bookmarkParam">
		SELECT count(*)
		FROM search s
		WHERE s.group = #groupType#
		      AND MATCH (s.content) AGAINST (#search# IN BOOLEAN MODE)
		      AND s.content_type = #contentType#
		      <isNotNull property="requestedUserName" prepend="AND">
		        s.user_name = #requestedUserName#
		      </isNotNull>
	</select>

	<select id="getBookmarkViewable" resultMap="BookmarkCommon.bookmarkPost" parameterClass="bookmarkParam">
		SELECT bb.content_id, bb.user_name,bb.book_url_hash as intraHash, bb.book_url_hash AS interHash, bb.book_description as title, bb.book_extended as description,
		       bb.date, bb.book_url, bb.book_url_ctr as count, t.tag_name, NULL as `group`, NULL AS group_name
		FROM (SELECT b.content_id, b.user_name, b.book_url_hash, b.book_description as title, b.book_extended as description,
		             b.date, u.book_url, u.book_url_ctr, b.group
		      FROM bookmark b, urls u
		      WHERE u.book_url_hash=b.book_url_hash
		            AND b.group = #groupType#
		      ORDER BY date DESC
		      LIMIT #limit# OFFSET #offset#) AS bb
		LEFT OUTER JOIN tas AS t ON t.content_id = bb.content_id
		ORDER BY bb.date DESC, bb.content_id DESC
	</select>

	<select id="getBookmarkForGroup" resultMap="BookmarkCommon.bookmarkPost" parameterClass="bookmarkParam">
		SELECT bb.content_id, b.book_url_hash as interHash,b.book_url_hash as intraHash, b.book_description as title, b.book_extended as description, bb.date, u.book_url,
		       u.book_url_ctr as count, t.tag_name, g.group_name, t.user_name, g.group
		FROM urls u, bookmark b,
		     ((SELECT content_id, date                <!-- bookmarks from users of group which currUser may see -->
		       FROM bookmark b, groups g
		       WHERE g.group = #groupId#
		             AND g.user_name = b.user_name    <!-- user owns this bookmark -->
		             <include refid="inGroups"/>
		      )UNION(
		       SELECT content_id, date                <!-- bookmarks from users of group which have currUser as friend -->
		       FROM bookmark b, groups g, friends f
		       WHERE f.f_user_name = #userName#       <!-- currUser is friend -->
		             AND g.user_name = f.user_name    <!-- user is in group -->
		             AND b.user_name = f.user_name    <!-- user owns this bookmark -->
		             AND g.group = #groupId#
		             AND b.group = $groupType$        <!-- bookmark is only for friends -->
		      )UNION(
		       SELECT content_id, date                <!-- currUsers bookmarks, ... -->
		       FROM bookmark b, groups g
		       WHERE b.user_name = #userName#
		             AND g.user_name = b.user_name    <!-- only, if currUser ... -->
		             AND g.group = #groupId#          <!-- is in this group -->
		      )
		      ORDER BY date DESC
		      LIMIT #limit# OFFSET #offset#) AS bb
		LEFT OUTER JOIN tas AS t ON bb.content_id = t.content_id, groupids AS g  <!-- join with tas -->
		WHERE t.group = g.group                                                  <!-- join groupname -->
		      AND u.book_url_hash = b.book_url_hash                              <!-- join url -->
		      AND b.content_id = bb.content_id                                   <!-- join title, description, ... -->
		ORDER BY bb.date DESC, bb.content_id DESC
	</select>

	<select id="getBookmarkForGroupCount" resultClass="int" parameterClass="bookmarkParam">
		SELECT count(*)
		FROM bookmark b, groups g
		WHERE g.group = #groupId#
		      AND b.user_name = g.user_name
		      <include refid="inGroups"/>
	</select>

	<select id="getBookmarkForGroupByTag" resultMap="BookmarkCommon.bookmarkPost" parameterClass="bookmarkParam">
		SELECT bb.content_id, b.book_url_hash as interHash, b.book_url_hash as intraHash, b.book_description as title, b.book_extended as description, bb.date, u.book_url,
		       u.book_url_ctr as count, t.tag_name, g.group_name, t.user_name, g.group
		FROM urls u, bookmark b, <include refid="selectContentIDs"/>
		LEFT OUTER JOIN tas AS t ON bb.content_id = t.content_id, groupids AS g  <!-- join with tas -->
		WHERE t.group = g.group                                                  <!-- join groupname -->
		      AND u.book_url_hash=b.book_url_hash                                <!-- join url -->
		      AND b.content_id=bb.content_id                                     <!-- join title, description, ... -->
		ORDER BY bb.date DESC, bb.content_id DESC
	</select>

	<select id="getBookmarkForUser" resultMap="BookmarkCommon.bookmarkPost" parameterClass="bookmarkParam">
		SELECT g.*, bb.content_id, bb.book_url_hash AS interHash, bb.book_url_hash AS intraHash, bb.book_description as title, bb.book_extended as description, bb.date,
		       bb.book_url, bb.book_url_ctr AS count, t.tag_name, t.user_name
		FROM (SELECT b.content_id, b.book_url_hash, b.book_description as title, b.book_extended as description, b.date,
		             u.book_url, u.book_url_ctr, b.group
		      FROM bookmark b, urls u
		      WHERE u.book_url_hash = b.book_url_hash
		            AND b.user_name = #requestedUserName#
		            <include refid="getPostForUser"/>
		      ORDER BY date DESC
		      LIMIT #limit# OFFSET #offset#) AS bb
		LEFT OUTER JOIN tas AS t ON bb.content_id = t.content_id, groupids AS g
		WHERE bb.group = g.group
		ORDER BY bb.date DESC, bb.content_id DESC
	</select>

	<select id="getBookmarkForUserCount" resultClass="int" parameterClass="bookmarkParam">
		SELECT count(*)
		FROM bookmark b
		WHERE b.user_name = #requestedUserName#
		      <include refid="getPostForUser"/>
	</select>


    <insert id="insertBookmark" parameterClass="bookmarkParam">
		INSERT INTO bookmark (content_id, book_url_hash, book_description as title, book_extended as description, `group`, date, user_name)
		VALUES (#requestedContentId#,#hash#,#resource.title#,#description#,#groupId#,#date#,#userName#)
	</insert> 
<!--
	<insert id="insertBookmarkLog" parameterClass="bookmarkParam">
	    INSERT INTO log_bookmark (content_id,book_url_hash,book_description as title,book_extended as description,`group`,date,user_name)
		SELECT content_id,book_url_hash,book_description as title,book_extended as description,`group`,date,user_name
		FROM bookmark WHERE content_id = #requestedContentId#
	</insert>
-->
    <insert id="insertBookmarkInc" parameterClass="bookmarkParam">
		INSERT INTO urls (book_url_hash,book_url,book_url_ctr) VALUES (#hash#,#url#,1) ON DUPLICATE KEY UPDATE book_url_ctr=book_url_ctr+1
	</insert>
	
	<update id="updateBookmarkHashDec" parameterClass="bookmarkParam">
		UPDATE urls SET book_url_ctr=book_url_ctr-1 WHERE book_url_hash = #hash# 
	</update>
	
	<delete id="deleteBookmarkByContentId" parameterClass="bookmarkParam">
		DELETE FROM bookmark WHERE content_id = #requestedContentId#
	</delete>
	
<!--
	<insert id="insertBibTexHashInc" parameterClass="bibtexParam">
		INSERT INTO bibhash(hash, ctr) VALUES (#hash#, 1) ON DUPLICATE KEY UPDATE ctr=ctr+1
	</insert>

	<update id="updateBookmarkLog" parameterClass="bookmarkParam">
		UPDATE log_bookmark SET new_content_id = #resource.contentId#
		WHERE content_id = #requestedContentId#
	</update>
-->
	<select id="getContentIDForBookmark" resultClass="int" parameterClass="bookmarkParam">
		SELECT content_id FROM bookmark WHERE book_url_hash = #hash# AND user_name = #userName#
	</select>


	<!--	
	only for setting concerning geotagger feature 
	
	<update id="updateBookmarkDocument" parameterClass="bookmarkParam">
		UPDATE document SET content_id = #resource.contentId# WHERE content_id =#requestedContentId#
	</update>
	<delete id="deleteBookmarkDocument">
		DELETE FROM document WHERE content_id = #requestedContentId# AND user_name= #resource.userName#
	</delete>
	
	 <insert id="insertBookmarkDocument" parameterClass="bookmarkParam">
		INSERT INTO INTO document (hash, content_id, name, user_name, date)values(#resource.hash#,#resource.contentID#,##,#resource.userName#,#resource.date#);
	</insert>-->
</sqlMap>