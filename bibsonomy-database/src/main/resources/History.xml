<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE sqlMap PUBLIC "-//iBATIS.com//DTD SQL Map 2.0//EN" "http://www.ibatis.com/dtd/sql-map-2.dtd">

<sqlMap namespace="History">
	<update id="updateBibTexHistory" parameterClass="bibtexParam">
		UPDATE log_bibtex
		SET current_content_id = #newContentId#
		WHERE current_content_id = #requestedContentId#
	</update>
	
	<update id="updateBookmarkHistory" parameterClass="bookmarkParam">
		UPDATE log_bookmark
		SET current_content_id = #newContentId#
		WHERE current_content_id = #requestedContentId#
	</update>
	
	<update id="updateGoldStandardHistory" >
		UPDATE log_gold_standard
		SET current_content_id = #newContentId#
		WHERE current_content_id = #requestedContentId#
	</update>
	
	<select id="getBibTexHistory" resultMap="BibTexCommon.bibtexPost" parameterClass="bibtexParam">
		SELECT g.*,t.tag_name,h.ctr AS count, <include refid ="bibtexAttributes2"/>,t.change_date, <include refid="reviewRatingsRows" /> 
		FROM (SELECT * FROM bibtex t1
		      WHERE simhash2 = #hash#
		      	AND user_name = #requestedUserName#) AS b2
		LEFT OUTER JOIN tas t ON (b2.content_id = t.content_id) 
		<include refid="reviewRatingsJoinPublication2" />
		LEFT JOIN bibhash h ON (<include refid="bibtexSimHash2"/>)
		LEFT JOIN groupids g ON (b2.group = g.group)
		UNION
		SELECT g.*, t.tag_name, 0 as count, <include refid ="bibtexAttributes2"/>, t.change_date, <include refid="reviewRatingsRows" />
		FROM (SELECT t1.*
		      FROM log_bibtex t1, bibtex b
		      WHERE t1.current_content_id = b.content_id
		      	AND b.simhash2 = #hash# 
				AND b.user_name = #requestedUserName#	
		      ORDER BY content_id ASC
			  LIMIT #limit# OFFSET #offset#) AS b2
		LEFT OUTER JOIN log_tas AS t ON b2.content_id = t.content_id
	    <include refid="reviewRatingsJoinPublication2" />
		LEFT JOIN groupids g ON (b2.group = g.group)
		ORDER BY content_id
	</select>
	
	<select id="getBibTexExtraURLHistory" resultMap="BibTexExtraCommon.bibtexExtraURL" parameterClass="bibtexExtraParam">
		SELECT u.url, u.text, u.date
		FROM bibtexurls u
		     JOIN bibtex b ON u.content_id = b.content_id
		WHERE b.simhash$simHash$ = #hash#
		      AND b.user_name = #userName#
		UNION
		SELECT u.url, u.text, u.date
		FROM log_bibtexurls u
		     JOIN log_bibtex lb ON u.content_id = lb.content_id
		     JOIN bibtex b ON b.content_id = lb.current_content_id
		WHERE b.simhash$simHash$ = #hash#
		      AND b.user_name = #userName#
		ORDER BY u.date DESC
	</select>
	
	<select id="getGoldStandardHistory" resultMap="GoldStandardPublicationCommon.goldStandardPost" parameterClass="resourceParam">
		(SELECT b.content_id, <include refid ="allGoldStandardPublicationAttributesWithSimHashes"/>, 1 AS count, content_type, <include refid="reviewRatingsRows" /> 
		FROM gold_standard b
		LEFT JOIN review_ratings_cache c ON c.interHash = #hash#
		WHERE b.simhash1 = #hash# <!-- AND b.content_type = #contentType# ???-->)
	UNION
		(SELECT b.content_id, <include refid ="allGoldStandardPublicationAttributesWithSimHashes"/>, 1 AS count, b.content_type, <include refid="reviewRatingsRows" /> 
		FROM log_gold_standard b, gold_standard b2
		LEFT JOIN review_ratings_cache c ON c.interHash = #hash#
		WHERE b2.simhash1 = #hash#  <!-- AND b.content_type = #contentType# -->
		  AND b2.content_id = b.current_content_id
		ORDER BY b.date ASC
		LIMIT #limit# OFFSET #offset#)
	ORDER BY content_id
	</select>
	
	<!-- Unused & Untested -->
	<select id="getBookmarkHistory" resultMap="BookmarkCommon.bookmarkPost" parameterClass="bookmarkParam">
		SELECT g.*, b.content_id, t.tag_name, title, description, b.user_name, b.date, 
		       b.book_url_hash AS interHash, b.book_url_hash AS intraHash, u.book_url, u.book_url_ctr AS count, t.change_date, <include refid="reviewRatingsRows" />
		FROM (SELECT t1.book_url_hash, t1.book_description AS title, t1.book_extended AS description, t1.user_name, t1.date, t1.content_id, t1.group, t1.change_date
		      FROM bookmark t1
		      WHERE t1.book_url_hash = #hash#
		         AND user_name = #requestedUserName#) AS b
		LEFT OUTER JOIN tas t ON b.content_id = t.content_id <include refid="reviewRatingsJoinBookmark" />, urls u, groupids g
		WHERE b.book_url_hash = u.book_url_hash
			AND b.group = g.group
	UNION
		SELECT g.*, b.content_id, t.tag_name, title, description, b.user_name, b.date, 
		       b.book_url_hash AS interHash, b.book_url_hash AS intraHash, u.book_url, u.book_url_ctr AS count, t.change_date, <include refid="reviewRatingsRows" />
		FROM (SELECT t1.book_url_hash, t1.book_description AS title, t1.book_extended AS description, t1.user_name, t1.date, t1.content_id, t1.group, t1.change_date
		      FROM log_bookmark t1, bookmark bm
		      WHERE bm.book_url_hash = #hash#
		        AND bm.content_id = t1.current_content_id
		        <include refid="restrictToGroups"/>
		        AND bm.user_name = #requestedUserName#
		      ORDER BY t1.date ASC
		      LIMIT #limit# OFFSET #offset#) AS b
		LEFT OUTER JOIN log_tas t ON b.content_id = t.content_id <include refid="reviewRatingsJoinBookmark" />, urls u, groupids g
		WHERE b.book_url_hash = u.book_url_hash
			AND b.group = g.group
	ORDER BY content_id
	</select>
</sqlMap>