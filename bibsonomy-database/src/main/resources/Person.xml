<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE sqlMap PUBLIC "-//iBATIS.com//DTD SQL Map 2.0//EN" "http://www.ibatis.com/dtd/sql-map-2.dtd">

<sqlMap namespace="Person">

	<select id="getPersonById" resultMap="PersonCommon.lazyLoadingPerson" parameterClass="String">
		SELECT <include refid="commonPersonColumns"/>
		FROM person
		WHERE person.person_id = #id#
	</select>
	
	<select id="getPersonByDnbId" resultMap="PersonCommon.lazyLoadingPerson" parameterClass="string">
		SELECT <include refid="commonPersonColumns"/>
		FROM person
		WHERE person.dnb_person_id = #personId#
	</select>
	
	<select id="getPersonByUser" resultMap="PersonCommon.lazyLoadingPerson" parameterClass="string">
		SELECT <include refid="commonPersonColumns"/>
		FROM person
		WHERE person.user_name = #user#
	</select>
	
	<insert id="insertPerson" parameterClass="person">
		INSERT INTO person (<include refid="commonPersonColumnsPlain"/>)
			VALUES (<include refid="insertPersonAttributes"/>)
	</insert>
	
	<insert id="insertName" parameterClass="personNgetBibTexRelationsForPersoname">
		INSERT INTO person_name (person_change_id, first_name, last_name, person_id, is_main, log_changed_by, log_changed_at)
			VALUES (#personNameChangeId#, #firstName#, #lastName#, #personId#, #isMain#, #changedBy#, #changedAt#)
		<selectKey resultClass="int" keyProperty="personNameChangeId" >
			SELECT @@IDENTITY AS person_change_id
 		</selectKey>
	</insert>
	
	<insert id="insertResourceRelation" parameterClass="personResourceRelation">
		INSERT INTO pub_person (<include refid="commonResourcePersonRelationColumnsPlain"/>)
			VALUES (<include refid="commonResourcePersonRelationAttributes" />)
			
		<selectKey resultClass="int" keyProperty="personRelChangeId" >
    		SELECT @@IDENTITY AS person_change_id
  		</selectKey>
	</insert>
	
	<select id="getNames" resultMap="PersonCommon.personName" parameterClass="string">
		SELECT <include refid="commonPersonNameColumns"/>
		FROM person_name
		WHERE person_id = #personId#
	</select>

	<select id="getPersonNameById" resultMap="PersonCommon.personName" parameterClass="int">
		SELECT <include refid='commonPersonNameColumns'/>
		FROM person_name
			WHERE person_change_id = #personChangeId#
	</select>

	<update id="updatePerson" parameterClass="person">
		UPDATE person
		SET person_change_id = #personChangeId#, college = #college#, email = #email#, homepage = #homepage#, gender = #gender#, dnb_person_id  = #dnbPersonId#, academic_degree = #academicDegree#, orcid = #orcid#, researcherid = #researcherid#, post_ctr = #postCounter#, user_name = #user#, log_changed_by = #changedBy#, log_changed_at = #changeDate#
		WHERE person.person_id = #personId#
	</update>

	<update id="updatePersonOrcid" parameterClass="person">
		UPDATE person
		SET person_change_id = #personChangeId#, orcid = #orcid#, user_name = #user#, log_changed_by = #changedBy#, log_changed_at = #changeDate#
		WHERE person_id = #personId#
	</update>

	<update id='updatePersonResearcherid' parameterClass='org.bibsonomy.model.Person'>
		UPDATE person
		SET researcherid = #researcherid#, person_change_id = #personChangeId#, user_name = #user#, log_changed_by = #changedBy#, log_changed_at = #changeDate#
		WHERE person_id = #personId#
	</update>

	<update id="updatePersonAcademicDegree" parameterClass="person">
		UPDATE person
		SET person_change_id = #personChangeId#, academic_degree = #academicDegree#, user_name = #user#, log_changed_by = #changedBy#, log_changed_at = #changeDate#
		WHERE person.person_id = #personId#
	</update>

	<update id="updatePersonCollege" parameterClass="person">
		UPDATE person
		SET person_change_id = #personChangeId#, college = #college#, user_name = #user#, log_changed_by = #changedBy#, log_changed_at = #changeDate#
		WHERE person.person_id = #personId#
	</update>
	
	<update id="updatePersonEmail" parameterClass="person">
		UPDATE person
		SET person_change_id = #personChangeId#, email = #email#, user_name = #user#, log_changed_by = #changedBy#, log_changed_at = #changeDate#
		WHERE person.person_id = #personId#
	</update>

	<update id="updatePersonHomepage" parameterClass="person">
		UPDATE person
		SET person_change_id = #personChangeId#, homepage = #homepage#, user_name = #user#, log_changed_by = #changedBy#, log_changed_at = #changeDate#
		WHERE person.person_id = #personId#
	</update>

	<update id="updatePersonUser" parameterClass="person">
		UPDATE person
		SET person_change_id = #personChangeId#, user_name = #user#, log_changed_by = #changedBy#, log_changed_at = #changeDate#
		WHERE person.person_id = #personId#
	</update>

	<update id="updatePersonName" parameterClass="personName">
		UPDATE person_name
		SET is_main = #isMain#
		WHERE person_name.person_change_id = #personNameChangeId#
	</update>
	
	<delete id="removeResourceRelation" parameterClass="int">
		DELETE FROM pub_person
		WHERE person_change_id = #resourceRelationId#
	</delete>

	<delete id="removePersonName" parameterClass="int">
		DELETE FROM person_name
		WHERE person_change_id = #personNameId#
	</delete>

	<delete id="deletePersonNamesByPersonId" parameterClass="string">
		DELETE FROM person_name
		WHERE person_id = #personId#
	</delete>

	<delete id="deletePersonById" parameterClass="string">
		DELETE FROM person
		WHERE person_id = #personId#
	</delete>

	<update id="unlinkUser" parameterClass="string">
		UPDATE person
		SET user_name = null,
			email = null,
			homepage = null
		WHERE user_name = #username#
	</update>
	
	<select id="getPosts" resultMap="GoldStandardPublicationCommon.goldStandardPost">
		SELECT <include refid="allGoldStandardPublicationAttributesAnonymWithPostAttributes" />, <include refid="reviewRatingsDummyRows" />
		FROM gold_standard b
		WHERE b.simhash1 = #simhash1#
	</select>
	
	<!--
		Queries to find resource <-> person relations
	-->

	<select id="getResourcePersonRelationByResourcePersonRelation" resultMap="PersonCommon.lazyLoadingResourcePersonRelation" parameterClass="personResourceRelation">
		SELECT <include refid="commonResourcePersonRelationColumns" />
		FROM pub_person
		WHERE simhash1 = #post.resource.interHash#
		<isNotNull property="person">
			AND person_id = #person.personId#
		</isNotNull>
		AND relator_code = #relationType.relatorCode#
		AND person_index = #personIndex#
	</select>

	<select id="getResourcePersonRelationsByPublication" parameterClass="java.lang.String" resultMap="PersonCommon.resourcePersonRelationWithPersonPrefilled">
		SELECT <include refid="commonResourcePersonRelationColumns" />, <include refid="commonPersonColumns" />, <include refid="commonPersonNameColumns" />
		FROM pub_person, person, person_name
		WHERE pub_person.simhash1 = #interHash#
		AND pub_person.person_id = person.person_id
		AND pub_person.person_id = person_name.person_id
		ORDER BY pub_person.simhash1, pub_person.relator_code, pub_person.person_index
	</select>

	<select id="getResourcePersonRelationsWithPersonsByInterhash" parameterClass="java.lang.String" resultMap="PersonCommon.resourcePersonRelationWithPersonPrefilled">
		SELECT <include refid="commonResourcePersonRelationColumns" />, <include refid="commonPersonColumns"/>, <include refid="commonPersonNameColumns"/>
		FROM pub_person
		JOIN person USING (person_id)
		JOIN person_name USING (person_id)
		WHERE simhash1 = #interhash#
	</select>

	<select id="getComunityBibTexRelationsForPerson" resultMap="PersonCommon.preFilledCommunityResourcePersonRelation" parameterClass="bibtexParam">
		SELECT <include refid="allGoldStandardPublicationAttributesAnonymWithPostAttributes" />, <include refid="reviewRatingsRows" />, <include refid="commonResourcePersonRelationColumns" />
		FROM
		gold_standard b
		<include refid="reviewRatingsJoinPublication" />
		JOIN pub_person USING(simhash1)
		WHERE
		pub_person.person_id = #personRelation.person.personId#
	</select>

	<select id="countComunityBibTexRelationsForPerson" resultClass="int" parameterClass="bibtexParam">
		SELECT count(*)	FROM gold_standard b <include refid="reviewRatingsJoinPublication" />
			JOIN pub_person USING(simhash1)
		WHERE
			pub_person.person_id = #personRelation.person.personId#
	</select>




	<select id="getMatches" resultMap="PersonCommon.personMatch">
		SELECT match_id, person1_id, person2_id, state
		FROM person_match
		WHERE state = 0
	</select>

	<!-- FIXME: merge this into the getMatches Query -->
	<select id="getPostsForPerson" parameterClass="string" resultMap="GoldStandardPublicationCommon.goldStandardPost">
		SELECT <include refid="allGoldStandardPublicationAttributesAnonymWithPostAttributes" />, <include refid="reviewRatingsDummyRows" />
		FROM gold_standard b
		JOIN pub_person p (simhash1)
		WHERE p.person_id = #personId#
		AND p.relator_code = 'Maut'
	</select>

	<select id="getMatchbyID" parameterClass="int" resultMap="PersonCommon.personMatch">
		SELECT match_id, person1_id, person2_id, state
		FROM person_match
		WHERE match_id = #matchID#
	</select>
	
	<select id="getMatchesFor" parameterClass="string" resultMap="PersonCommon.personMatch">
		SELECT match_id, person1_id, person2_id, state
		FROM person_match
		WHERE (person1_id = #personid# OR person2_id = #personid#)
		AND state = 0
	</select>
	
	<update id="denyMatchByID" parameterClass="org.bibsonomy.database.params.DenyMatchParam">
		UPDATE person_match
		SET state = 1
		WHERE match_id = #matchId#
	</update>
	
	<insert id="denyMatchByIDForUser" parameterClass="org.bibsonomy.database.params.DenyMatchParam">
		INSERT INTO user_denied_match VALUES (#matchId#, #userName#)
	</insert>
	
	<delete id="removeReflexivPersonMatches">
		DELETE FROM person_match
		WHERE person1_id = person2_id
	</delete>
	
	<delete id="removePersonMatch" parameterClass="int">
		DELETE FROM person_match
		WHERE match_id = #matchid#
	</delete>
	
	<update id="acceptMerge" parameterClass="int">
		UPDATE person_match
		SET state = 2
		WHERE match_id = #matchid#
	</update>
	
	<update id="updatePersonMatchAfterMerge" parameterClass="personMatch">
		UPDATE person_match
		SET person1_id = IF(person1_id = #person2.personId#, #person1.personId#, person1_id),
			person2_id = IF(person2_id = #person2.personId#, #person1.personId#, person2_id)
		WHERE match_id != #matchID# and state != 2
	</update>
	
	<update id="redirectUserDenies" parameterClass="org.bibsonomy.database.params.DenyMatchParam">
		UPDATE user_denied_match
		SET match_id = #newMatchId#
		WHERE match_id = #matchId#
	</update>
	
	<select id="getSimilarMatchesForMatch" parameterClass="personMatch" resultMap="PersonCommon.personMatch">
		SELECT *
		FROM person_match
		WHERE (person1_id = #person1.personId# AND person2_id = #person2.personId#)
		OR (person1_id = #person2.personId# AND person2_id = #person1.personId#)
	</select>

	<select id="getHabilForPerson" parameterClass="string" resultMap="GoldStandardPublicationCommon.goldStandardPost">
		SELECT <include refid="allGoldStandardPublicationAttributesAnonymWithPostAttributes" />, <include refid="reviewRatingsDummyRows" />
		FROM gold_standard b
		JOIN pub_person p USING (simhash1)
		WHERE p.person_id = #personId#
		AND p.relator_code = 'Maut'
		AND b.entrytype = 'phdthesis'
		AND b.type = 'habilitation'
	</select>

	<select id="getPHDForPerson" parameterClass="string" resultMap="GoldStandardPublicationCommon.goldStandardPost">
		SELECT <include refid="allGoldStandardPublicationAttributesAnonymWithPostAttributes" />, <include refid="reviewRatingsDummyRows" />
		FROM gold_standard b
		JOIN pub_person p USING (simhash1)
		WHERE p.person_id = #personId#
		AND p.relator_code = 'Maut'
		AND b.entrytype = 'phdthesis'
		AND (b.type is NULL or b.type != 'habilitation')
	</select>

	<select id="getDeniesForMatch" resultClass="string" parameterClass="int">
		SELECT user_name
		FROM user_denied_match
		WHERE match_id = #matchid#
	</select>

	<select id="getPersonForward" resultClass='string' parameterClass='string'>
		SELECT person1_id
		FROM person_match
		WHERE person2_id = #personId#
		AND state = 2
	</select>

	<insert id="addOtherDNBID" parameterClass="org.bibsonomy.database.params.DNBAliasParam">
		INSERT INTO other_dnb_ids VALUES (#dnbId#, #otherDnbId#)
	</insert>
	
	<update id="updateTransitivDNBID" parameterClass="org.bibsonomy.database.params.DNBAliasParam">
		UPDATE other_dnb_ids
		SET dnb_person_id = #dnbId#
		WHERE dnb_person_id = #otherDnbId#
	</update>

</sqlMap>
