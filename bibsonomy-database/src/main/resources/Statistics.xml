<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE sqlMap PUBLIC "-//iBATIS.com//DTD SQL Map 2.0//EN" "http://www.ibatis.com/dtd/sql-map-2.dtd">

<sqlMap namespace="Statistics">

	<select id="getNumberOfRelationsForUser" resultClass="int" parameterClass="String">
		SELECT count(*) FROM 
            (SELECT count(upper) AS tag_name, GROUP_CONCAT(lower ORDER BY lower SEPARATOR '') AS subtags
                FROM tagtagrelations
                WHERE user_name=#userName#
                GROUP BY upper
                ORDER BY upper
            ) as b
	</select>

	<resultMap id="userDiscussionsRatingStatistic" class="statisticsValues" groupBy="count">
    	<result property="count"	column="maxcnt"			javaType="int" />
    	<result property="average"	column="avgrating"		javaType="float" />
    	<result property="max"		column="maxrating"		javaType="float" />
    	<result property="min"		column="minrating"		javaType="float" />
    	<result property="values" resultMap="Statistics.userDiscussionsRatingStatisticList"/>
	</resultMap>

	<resultMap id="userDiscussionsRatingStatisticList" class="statistics">
		<result property="rating"      	column="rating"			javaType="float" />
    	<result property="count"     	column="cnt"			javaType="int" />
    	<result property="percentage"		column="percent"		javaType="float" />
	</resultMap>



	<!-- The inner select counts some global values, while the outer select actually determines the distribution.
		There should be an easier way, to do this in Java. Simply put out the ratings and create the distribution and all values in Java.
		Needs new ResultMap etc. 
		WHY IS THE group>=0 condition not used? It should remove spammers!  -->
	<select id="userRatingStatistic" resultMap="Statistics.userDiscussionsRatingStatistic" parameterClass="StatisticsParam" >
		SELECT rating, COUNT(rating) cnt, (COUNT(rating) / maxcnt * 100) percent, maxcnt, avgrating, maxrating, minrating 
		FROM discussion AS d <include refid="spammerClassifiedJoin"/>, 
			(SELECT COUNT(*) maxcnt, AVG(rating) avgrating, MAX(rating) maxrating, MIN(rating) minrating 
				FROM discussion AS d <include refid="spammerClassifiedJoin"/>
				WHERE
					<include refid="discussionVisible"/>
					AND type = 1 AND rating IS NOT NULL
  					<include refid="spammerClassified"/>
  				    <!-- AND d.group >=0 -->
			) AS m 
		WHERE 
			<include refid="discussionVisible"/>
			AND type = 1 AND rating IS NOT NULL
  			<include refid="spammerClassified"/>
		    <!-- AND d.group >=0 -->
		GROUP BY rating
	</select>
 
	<select id="userRatingStatisticForGroup" resultMap="Statistics.userDiscussionsRatingStatistic" parameterClass="StatisticsParam" >
		SELECT rating, COUNT(rating) cnt, (COUNT(rating) / maxcnt * 100) percent, maxcnt, avgrating, maxrating, minrating 
		FROM groups g, discussion AS d, 
			(SELECT COUNT(*) maxcnt, AVG(rating) avgrating, MAX(rating) maxrating, MIN(rating) minrating 
				FROM groups g, discussion AS d
				WHERE
					<include refid="discussionVisibleForGroup"/>
					AND type = 1 AND rating IS NOT NULL
   				    AND g.group = #groupId#
 				    AND g.user_name = d.user_name
  				    <!-- AND d.group >=0 -->
 			) AS m 
		WHERE 
			<include refid="discussionVisibleForGroup"/>
			AND type = 1 AND rating IS NOT NULL
		    AND g.group = #groupId#
		    AND g.user_name = d.user_name
		    <!-- AND d.group >=0 -->
 		GROUP BY rating
	</select>
 
</sqlMap>