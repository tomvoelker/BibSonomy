<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE sqlMap PUBLIC "-//iBATIS.com//DTD SQL Map 2.0//EN" "http://www.ibatis.com/dtd/sql-map-2.dtd">

<sqlMap namespace="Statistics">

	<select id="getNumberOfRelationsForUser" resultClass="int" parameterClass="String">
		SELECT count(*) FROM 
            (SELECT count(upper) AS tag_name, GROUP_CONCAT(lower ORDER BY lower SEPARATOR '') AS subtags
                FROM tagtagrelations
                WHERE user_name=#userName#
                GROUP BY upper
                ORDER BY upper
            ) as b
	</select>

	<resultMap id="userDiscussionsRatingStatistic" class="userDiscussionsRatingStatistic" groupBy="count">
    	<result property="count"		column="maxcnt"		javaType="int" />
    	<result property="average"	column="avgrating"		javaType="float" />
    	<result property="max"	column="maxrating"		javaType="float" />
    	<result property="min"	column="minrating"		javaType="float" />
    	<result property="ratings" resultMap="Statistics.userDiscussionsRatingStatisticList"/>
	</resultMap>

	<resultMap id="userDiscussionsRatingStatisticList" class="ratingStatValues">
		<result property="rating"      	column="rating"			javaType="float" />
    	<result property="count"     	column="cnt"			javaType="int" />
    	<result property="percent"		column="percent"		javaType="float" />
	</resultMap>


	<select id="userRatingStatistic" resultMap="Statistics.userDiscussionsRatingStatistic" parameterClass="StatisticsParam" >
		SELECT rating, COUNT(rating) cnt, (COUNT(rating) / maxcnt * 100) percent, maxcnt, avgrating, maxrating, minrating 
		FROM discussion AS d, 
			(SELECT COUNT(*) maxcnt, AVG(rating) avgrating, MAX(rating) maxrating, MIN(rating) minrating 
				FROM discussion AS d
				WHERE
					<include refid="discussionVisible"/>
			) AS m 
		WHERE 
			<include refid="discussionVisible"/>
		GROUP BY rating
	</select>

</sqlMap>