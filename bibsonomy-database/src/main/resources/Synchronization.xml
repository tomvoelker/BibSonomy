<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE sqlMap PUBLIC "-//iBATIS.com//DTD SQL Map 2.0//EN" "http://www.ibatis.com/dtd/sql-map-2.dtd">

<sqlMap namespace="Synchronization">

	<select id="getSyncServicesForUser" resultMap="SynchronizationCommon.syncService" parameterClass="syncParam">
		SELECT *
		FROM sync
		WHERE user_name = #userName#
	</select>
	
	<insert id="insertSyncServiceForUser" parameterClass="syncParam">
		INSERT INTO sync (user_name, service_id, credentials)
		VALUES (#userName#, #serviceId#, #credentials#)
	</insert> 

	<select id="getSyncBibTex" resultMap="SynchronizationCommon.syncPost" parameterClass="bibtexParam">
		SELECT <include refid="bibtexSimHashes"/>, b.date, t.change_date
		FROM bibtex b
		JOIN tas t USING (content_id)
		WHERE b.user_name = #userName#
		GROUP BY content_id
	</select>

	<select id="getSyncBookmark" resultMap="SynchronizationCommon.syncPost" parameterClass="bookmarkParam">
		SELECT b.book_url_hash AS intrahash, NULL AS interhash, b.date, b.change_date
		FROM bookmark b
		JOIN tas t USING (content_id)
		WHERE b.user_name = #userName#
		GROUP BY content_id
	</select>
	
	
	<select id="getLastSyncDateForUserForServiceForContent" resultClass="java.util.Date" parameterClass="syncParam">
		SELECT last_sync_date
		FROM sync_data
		WHERE user_name = #userName#
			AND content_type = #contentType#
			AND service_id = #serviceId#
		ORDER BY last_sync_date DESC
		LIMIT 1
	</select>
	
	<select id="getSyncData" resultMap="SynchronizationCommon.syncData" parameterClass="syncParam">
		SELECT *
		FROM sync_data
		WHERE user_name = #userName#
			AND content_type = #contentType#
			AND service_id = #serviceId#
			AND status != 'undone'
		ORDER BY last_sync_date DESC
	</select> 
	
	<select id="getCurrentSyncData" resultMap="SynchronizationCommon.syncData" parameterClass="syncParam">
		SELECT *
		FROM sync_data
		WHERE user_name = #userName#
			AND content_type = #contentType#
			AND service_id = #serviceId#
			AND status = 'undone'
		ORDER BY last_sync_date DESC
		LIMIT 1
	</select> 
	
	<insert id="insertSync" parameterClass="syncParam">
		INSERT INTO sync_data (service_id, user_name, content_type, last_sync_date, status)
		VALUES (#serviceId#, #userName#, #contentType#, #lastSyncDate#, #status#)
	</insert> 
	
	<update id="updateSyncStatus" parameterClass="syncParam">
		UPDATE sync_data 
		SET status = #status#
		WHERE user_name = #userName#
			AND content_type = #contentType#
			AND service_id = #serviceId#
			AND last_sync_date = #lastSyncDate#
	</update>
	
	<update id="updateSyncServer" parameterClass="syncParam">
		UPDATE sync
		SET credentials = #credentials#
		WHERE user_name = #userName#
			AND service_id=#serviceId#
 	</update>
	
	<delete id="deleteSyncServer" parameterClass="syncParam">
		DELETE FROM sync
		WHERE user_name = #userName#
			AND service_id = #serviceId#
	</delete>
	
</sqlMap>