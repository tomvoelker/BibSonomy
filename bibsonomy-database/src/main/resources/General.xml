<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE sqlMap PUBLIC "-//iBATIS.com//DTD SQL Map 2.0//EN" "http://www.ibatis.com/dtd/sql-map-2.dtd">

<sqlMap namespace="General">
	<!-- Changed 'SELECT user_name' to 'SELECT count(user_name)': this way we get the right boolean result -->
	<select id="isFriendOf" resultClass="boolean" parameterClass="genericParam">
		SELECT count(user_name)
		FROM friends
		WHERE user_name = #requestedUserName# AND f_user_name = #userName#
	</select>

	<!-- Changed 'SELECT spammer' to 'SELECT count(spammer)': this way we get the right boolean result -->
	<select id="isSpammer" resultClass="boolean" parameterClass="genericParam">
		SELECT count(spammer) FROM user WHERE user_name = #requestedUserName#
	</select>

	<select id="getGroupsForUser" resultClass="int" parameterClass="genericParam">
		SELECT `group` FROM groups WHERE user_name = #userName#
	</select>

	<select id="getGroupIdByGroupNameAndUserName" resultClass="int" parameterClass="genericParam">
		SELECT g.group
		FROM groupids g <isNotNull property="userName" prepend=",">groups i</isNotNull>
		WHERE g.group_name = #requestedGroupName#
		      <isNotNull property="userName" prepend="AND">
		        i.user_name = #userName#
		        AND i.group = g.group
		      </isNotNull>
	</select>

	<!--TODO enumeration -->
	<select id="getNewContentId" resultClass="int" parameterClass="bookmarkParam">
		SELECT value FROM ids WHERE name = #idsType# FOR UPDATE
	</select>

	<update id="updateIds" parameterClass="bookmarkParam">
		UPDATE ids SET value = value + 1 WHERE name = #idsType#
	</update>

	<select id="getNewTasID" resultClass="int" parameterClass="bookmarkParam">
		SELECT value FROM ids WHERE name=#idsType# FOR UPDATE
	</select>

	<!-- TODO change tag_lower value -->
	<insert id="insertTas" parameterClass="genericParam">
		INSERT INTO tas (tas_id, tag_name,content_id,content_type,user_name,date,`group`,tag_lower,change_date) 
		VALUES (#newTasId#,#tagName#,#requestedContentId#,#contentType#,#userName#,#date#,#groupId#,#tagName#,#date#)
	</insert>

	<delete id="deleteTas" parameterClass="genericParam">
		DELETE FROM bookmark WHERE content_id = #requestedContentId#
	</delete>
</sqlMap>