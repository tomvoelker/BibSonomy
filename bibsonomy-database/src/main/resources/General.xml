<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE sqlMap PUBLIC "-//iBATIS.com//DTD SQL Map 2.0//EN" "http://www.ibatis.com/dtd/sql-map-2.dtd">

<sqlMap namespace="General">

	<!-- TODO: isn't it a bit tricky, to convert a COUNT result to boolean? -->
	<!-- BTW: user has a LIST of friends, how come that #friend.name# works? -->
	<select id="isFriendOf" resultClass="boolean" parameterClass="user">
		SELECT count(user_name)
		FROM friends
		WHERE user_name = #name# AND f_user_name = #friend.name#
	</select>

	<select id="isSpammer" resultClass="boolean" parameterClass="string">
		SELECT spammer FROM user WHERE user_name = #userName#
	</select>

	<select id="getNewContentId" resultClass="int" parameterClass="int">
		SELECT value FROM ids WHERE name = #idsType# FOR UPDATE
	</select>

	<select id="getCurrentContentId" resultClass="int" parameterClass="int">
		SELECT MAX(value) FROM ids WHERE name = #idsType# FOR UPDATE
	</select>

	<update id="updateIds" parameterClass="int">
		UPDATE ids SET value = value + 1 WHERE name = #idsType#
	</update>

	<insert id="insertTas" parameterClass="tagParam">
		INSERT INTO tas (tas_id, tag_name, content_id, content_type, user_name, date, change_date, `group`, tag_lower)
		VALUES (#tasId#, #tagName#, #newContentId#, #contentType#, #userName#, #date#, #changeDate#, #groupId#, #tagNameLower#)
		<!-- VALUES
			<iterate conjunction="," property="tags">
				<iterate conjunction="," property="groups">
					((select max(tas_id)+1 FROM tas), #post.tags[].name#, #contentId#, #contentType#, #post.user.name#, #post.date#, #post.groups[].groupId#, lower(#post.tags[].name#))
				</iterate>
			</iterate -->
	</insert>
	
	<insert id="insertGroupTas" parameterClass="tagParam">
		INSERT INTO grouptas (tas_id, tag_name, content_id, content_type, user_name, date, `group`, tag_lower)
		VALUES (#tasId#, #tagName#, #newContentId#, #contentType#, #userName#, #date#, #groupId#, #tagNameLower#)
	</insert>

	<delete id="deleteTas" parameterClass="int">
		DELETE FROM tas WHERE content_id = #requestedContentId#
	</delete>
	
	<delete id="deleteGroupTas" parameterClass="int">
		DELETE FROM grouptas WHERE content_id = #requestedContentId#
	</delete>

</sqlMap>