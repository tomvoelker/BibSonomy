<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE sqlMap PUBLIC "-//iBATIS.com//DTD SQL Map 2.0//EN" "http://www.ibatis.com/dtd/sql-map-2.dtd">

<sqlMap namespace="Admin">

	<select id="getInetAddressStatus" resultClass="InetAddressStatus" parameterClass="InetAddress">
		SELECT status FROM inetAddressStates 
		WHERE address = #address#
	</select>

	<insert id="addInetAddressStatus" parameterClass="adminParam">
		INSERT INTO inetAddressStates (address, status) VALUES (#inetAddress#, #inetAddressStatus#); 
	</insert>

	<delete id="deleteInetAddressStatus" parameterClass="InetAddress">
		DELETE FROM inetAddressStates WHERE address = #address#
	</delete>
	
	<select id="getClassifierUserBeforeUpdate" resultMap="UserCommon.user" parameterClass="adminParam">
		SELECT *
		FROM user
		WHERE user_name=#userName# FOR UPDATE
	</select>

	<update id="flagSpammer" parameterClass="adminParam">
		UPDATE user SET spammer = #spammer#, updated_by = #updatedBy#, updated_at = #updatedAt#, to_classify = #toClassify# 
		WHERE user_name = #userName#
	</update>
	
	<update id="flagSpammerEvaluation" parameterClass="adminParam">
		UPDATE evaluation SET $evaluator$ = #prediction#, $evalDate$ = #updatedAt#
		WHERE user_name = #userName#
	</update>

	<select id="getAdminClassifiedUsers" resultMap="UserCommon.userWithPrediction" parameterClass="adminParam">
		SELECT *
		FROM user u JOIN prediction p ON (u.user_name = p.user_name)
		WHERE ((u.updated_by != 'classifier' AND u.updated_by != 'on_delete') OR ISNULL(u.updated_by)) AND prediction = #prediction# AND algorithm='admin'
		<isGreaterThan property="interval" compareValue="0" prepend="AND">
			u.updated_at > NOW() - INTERVAL #interval# HOUR		
	    </isGreaterThan>
		ORDER BY u.updated_at DESC
		LIMIT #limit#
	</select>

	<select id="getAdminClassifiedUsersCount" resultClass="integer" parameterClass="adminParam">
		SELECT COUNT(*) 
		FROM user WHERE (updated_by != 'classifier' OR ISNULL(updated_by)) AND spammer = #prediction# 
		<isGreaterThan property="interval" compareValue="0" prepend="AND">
			updated_at > NOW() - INTERVAL #interval# HOUR		
	    </isGreaterThan>
	</select>
	
	<select id="getClassifiedUsers" resultMap="UserCommon.userWithPrediction" parameterClass="adminParam">
		SELECT *  
		FROM user u JOIN prediction p ON (u.user_name = p.user_name AND u.updated_at = p.updated_at)
		WHERE updated_by = 'classifier' AND prediction = #prediction# 
		ORDER BY u.updated_at DESC
		LIMIT #limit#
	</select>
	
	<select id="getBibtexUsers" resultMap="AdminCommon.userPredictionWithUserProperties" parameterClass="adminParam">
		SELECT * FROM user u 
		JOIN prediction p ON (u.user_name = p.user_name AND u.updated_at = p.updated_at)
		JOIN bibtex b ON (u.user_name = b.user_name)
		WHERE algorithm != "self_deleted"
		GROUP BY u.user_name
		ORDER BY u.updated_at DESC
		LIMIT #limit#
	</select>
	
	<select id="getAllUsersWithSpam" resultMap="UserCommon.user" parameterClass="adminParam">
		SELECT * 
		FROM user u 
		ORDER BY u.reg_date DESC
		LIMIT #limit#
	</select>
	
	<select id="getClassifiedUsersCount" resultClass="integer" parameterClass="adminParam">
		SELECT COUNT(*)  
		FROM user u JOIN prediction p ON (u.user_name = p.user_name AND u.updated_at = p.updated_at)
		WHERE updated_by = 'classifier' AND prediction = #prediction#		
	   <isGreaterThan property="interval" compareValue="0" prepend="AND">	
			p.updated_at > NOW() - INTERVAL #interval# HOUR		
		</isGreaterThan>
	</select>	
	
	<select id="getClassifierSettings" resultClass="string" parameterClass="string">
		SELECT value FROM classifier_settings cs WHERE cs.key = #key#		
	</select>	

	<update id="updateClassifierSettings" parameterClass="adminParam">
		UPDATE classifier_settings cs SET value = #value# WHERE cs.key = #key# 
	</update>

	<select id="getClassifierHistory" resultMap="AdminCommon.userPrediction" parameterClass="string">
		SELECT user_name, updated_at, <include refid="commonPredictionAttributes"/>  FROM log_prediction 
		WHERE user_name  = #userName# AND algorithm != 'admin' 
		ORDER BY updated_at DESC LIMIT 25
	</select>
	 
	<select id="getClassifierUserDetails" resultMap="AdminCommon.userPredictionDetails" parameterClass="string">
		SELECT <include refid="commonPredictionAttributes"/>
		FROM prediction
		WHERE user_name = #userName#
		ORDER BY timestamp DESC
		LIMIT 1
	</select>
	 
	 <!--  
	 <select id="getClassifierComparison" resultMap="AdminCommon.userPredictionAndSpammer" parameterClass="adminParam">
	 	SELECT a.user_name,u.spammer, u.updated_by, u.updated_at, a.prediction, a.algorithm, a.mode
	 	FROM user u
	 	JOIN prediction a ON (u.user_name = a.user_name)
	 	WHERE a.evaluator=1 
	 	<isGreaterThan property="interval" compareValue="0" prepend="AND">	
			u.reg_date > NOW() - INTERVAL #interval# HOUR
		</isGreaterThan>
	 	order by u.reg_date DESC
	 </select>
	--> 
	
	 <select id="getClassifierComparison" resultMap="AdminCommon.userPredictionAndSpammer" parameterClass="adminParam">
	 	SELECT a.user_name, u.spammer, u.updated_by, u.updated_at, a.prediction, a.algorithm, a.confidence, a.mode
	 	FROM user u
	 	JOIN prediction a ON (u.user_name = a.user_name)
	 	JOIN tas t ON (t.user_name = a.user_name)
	 	WHERE a.evaluator=1 AND t.date > NOW() - INTERVAL 148 HOUR AND algorithm!='admin'
	 	<isGreaterThan property="interval" compareValue="0" prepend="AND">	
			u.reg_date > NOW() - INTERVAL #interval# DAY
		</isGreaterThan>
	 	group by u.user_name order by t.date DESC
	 </select>
	 
	 <update id="updateGroupIds" parameterClass="adminParam">
		UPDATE $groupIdTable$ SET `group` = 
		<dynamic prepend="IF">
			<isEqual property="spammer" compareValue="true">
				((`group` &gt;= 0), `group` + #groupRange#, `group`)
			</isEqual>
			<isEqual property="spammer" compareValue="false">
				((`group` &lt; 0), `group` - #groupRange#, `group`)
			</isEqual>
		</dynamic>
		WHERE user_name = #userName#
	</update>
	
</sqlMap>