<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE sqlMap PUBLIC "-//iBATIS.com//DTD SQL Map 2.0//EN" "http://www.ibatis.com/dtd/sql-map-2.dtd">

<sqlMap namespace="Admin">

<!-- 

  CREATE TABLE inetAddressStates (address char(15), status tinyint, primary key (address));
  
  ALTER TABLE user ADD COLUMN role TINYINT NOT NULL DEFAULT 1;
  
 -->

	<select id="getInetAddressStatus" resultClass="InetAddressStatus" parameterClass="InetAddress">
		SELECT status FROM inetAddressStates 
		WHERE address = #address#
	</select>

	<insert id="addInetAddressStatus" parameterClass="adminParam">
		INSERT INTO inetAddressStates (address, status) VALUES (#inetAddress#, #inetAddressStatus#); 
	</insert>

	<delete id="deleteInetAddressStatus" parameterClass="InetAddress">
		DELETE FROM inetAddressStates WHERE address = #address#
	</delete>
	
	<update id="flagSpammer" parameterClass="adminParam">
		UPDATE user SET spammer = #spammer#, updated_by = #updatedBy#, updated_at = #updatedAt#, to_classify = #toClassify# 
		WHERE user_name = #userName# 
	</update>
	
	<select id="getAdminClassifiedUsers" resultMap="UserCommon.user" parameterClass="adminParam">
		SELECT <include refid="commonUserAttributes"/>  
		FROM user WHERE (updated_by != 'classifier' OR ISNULL(updated_by)) AND spammer = #prediction# 
		ORDER BY updated_at DESC
		LIMIT #limit#
	</select>
	
	<select id="getClassifiedUsers" resultMap="UserCommon.userWithPrediction" parameterClass="adminParam">
		SELECT *  
		FROM user u JOIN log_prediction p ON (u.user_name = p.user_name AND u.updated_at = p.updated_at)
		WHERE updated_by = 'classifier' AND prediction = #prediction# 
		ORDER BY u.updated_at DESC
		LIMIT #limit#
	</select>
	
	<update id="updateTasGroupIds" parameterClass="adminParam">
		UPDATE tas SET `group` = #newGroupId# WHERE user_name = #userName# AND `group` = #oldGroupId#
	</update> 
	
	<update id="updateBookmarkGroupIds" parameterClass="adminParam">
		UPDATE bookmark SET `group` = #newGroupId# WHERE user_name = #userName# AND `group` = #oldGroupId#
	</update> 
	
	<update id="updateBibtexGroupIds" parameterClass="adminParam">
		UPDATE bibtex SET `group` = #newGroupId# WHERE user_name = #userName# AND `group` = #oldGroupId#
	</update> 
	
	<update id="updateSearchBookmarkGroupIds" parameterClass="adminParam">
		UPDATE search_bookmark SET `group` = #newGroupId# WHERE user_name = #userName# AND `group` = #oldGroupId#
	</update> 
	
	<update id="updateSearchBibtexGroupIds" parameterClass="adminParam">
		UPDATE search_bibtex SET `group` = #newGroupId# WHERE user_name = #userName# AND `group` = #oldGroupId#
	</update> 

</sqlMap>