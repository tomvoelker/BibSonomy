<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE sqlMap PUBLIC "-//iBATIS.com//DTD SQL Map 2.0//EN" "http://www.ibatis.com/dtd/sql-map-2.dtd">

<sqlMap namespace="Admin">

	<select id="getInetAddressStatus" resultClass="InetAddressStatus" parameterClass="InetAddress">
		SELECT status FROM inetAddressStates 
		WHERE address = #address#
	</select>

	<insert id="addInetAddressStatus" parameterClass="adminParam">
		INSERT INTO inetAddressStates (address, status) VALUES (#inetAddress#, #inetAddressStatus#); 
	</insert>

	<delete id="deleteInetAddressStatus" parameterClass="InetAddress">
		DELETE FROM inetAddressStates WHERE address = #address#
	</delete>

	<update id="flagSpammer" parameterClass="adminParam">
		UPDATE user SET spammer = #spammer#, updated_by = #updatedBy#, updated_at = #updatedAt#, to_classify = #toClassify# 
		WHERE user_name = #userName#
		<isEqual property="updatedBy" compareValue="classifier" prepend="AND">
			to_classify=1
	    </isEqual>
	</update>

	<!--
	<select id="getAdminClassifiedUsers" resultMap="UserCommon.user" parameterClass="adminParam">
		SELECT <include refid="commonUserAttributes"/>, prediction  
		FROM user u JOIN prediction p ON (u.user_name = p.user_name)
		WHERE (u.updated_by != 'classifier' OR ISNULL(u.updated_by)) AND spammer = #prediction# 
		<isGreaterThan property="interval" compareValue="0" prepend="AND">
			updated_at > NOW() - INTERVAL #interval# HOUR		
	    </isGreaterThan>
		ORDER BY updated_at DESC
		LIMIT #limit#
	</select>
--> 
	<select id="getAdminClassifiedUsers" resultMap="UserCommon.userWithPrediction" parameterClass="adminParam">
		SELECT *
		FROM user u JOIN prediction p ON (u.user_name = p.user_name)
		WHERE (u.updated_by != 'classifier' OR ISNULL(u.updated_by)) AND spammer = #prediction# AND algorithm='admin'
		<isGreaterThan property="interval" compareValue="0" prepend="AND">
			u.updated_at > NOW() - INTERVAL #interval# HOUR		
	    </isGreaterThan>
		ORDER BY u.updated_at DESC
		LIMIT #limit#
	</select>

	<select id="getAdminClassifiedUsersCount" resultClass="integer" parameterClass="adminParam">
		SELECT COUNT(*) 
		FROM user WHERE (updated_by != 'classifier' OR ISNULL(updated_by)) AND spammer = #prediction# 
		<isGreaterThan property="interval" compareValue="0" prepend="AND">
			updated_at > NOW() - INTERVAL #interval# HOUR		
	    </isGreaterThan>
	</select>
	
	<!--
	<select id="getClassifiedUsers" resultMap="UserCommon.userWithPrediction" parameterClass="adminParam">
		SELECT *  
		FROM user u JOIN prediction p ON (u.user_name = p.user_name AND u.updated_at = p.updated_at)
		WHERE updated_by = 'classifier' AND prediction = #prediction# 
		<isGreaterThan property="interval" compareValue="0" prepend="AND">
			p.updated_at > NOW() - INTERVAL #interval# DAY	
	    </isGreaterThan>
		ORDER BY u.updated_at DESC
		LIMIT #limit#
	</select>
	--> 
	
	<select id="getClassifiedUsers" resultMap="UserCommon.userWithPrediction" parameterClass="adminParam">
		SELECT *  
		FROM user u JOIN prediction p ON (u.user_name = p.user_name AND u.updated_at = p.updated_at)
		WHERE updated_by = 'classifier' AND prediction = #prediction# 
		ORDER BY u.updated_at DESC
		LIMIT #limit#
	</select>
	
	<select id="getClassifiedUsersCount" resultClass="integer" parameterClass="adminParam">
		SELECT COUNT(*)  
		FROM user u JOIN prediction p ON (u.user_name = p.user_name AND u.updated_at = p.updated_at)
		WHERE updated_by = 'classifier' AND prediction = #prediction#		
	   <isGreaterThan property="interval" compareValue="0" prepend="AND">	
			p.updated_at > NOW() - INTERVAL #interval# HOUR		
		</isGreaterThan>
	</select>	

	<select id="getClassifierSettings" resultClass="string" parameterClass="string">
		SELECT value FROM classifier_settings cs WHERE cs.key = #key#		
	</select>	

	<update id="updateClassifierSettings" parameterClass="adminParam">
		UPDATE classifier_settings cs SET value = #value# WHERE cs.key = #key# 
	</update>

	<select id="getClassifierHistory" resultMap="AdminCommon.userPrediction" parameterClass="string">
		SELECT <include refid="commonPredictionAttributes"/>  FROM log_prediction 
		WHERE user_name  = #userName# AND algorithm != 'admin' 
		ORDER BY updated_at DESC LIMIT 25
	</select>
	 
	 <!--  
	 <select id="getClassifierComparison" resultMap="AdminCommon.userPredictionAndSpammer" parameterClass="adminParam">
	 	SELECT a.user_name,u.spammer, u.updated_by, u.updated_at, a.prediction, a.algorithm, a.mode
	 	FROM user u
	 	JOIN prediction a ON (u.user_name = a.user_name)
	 	WHERE a.evaluator=1 
	 	<isGreaterThan property="interval" compareValue="0" prepend="AND">	
			u.reg_date > NOW() - INTERVAL #interval# HOUR
		</isGreaterThan>
	 	order by u.reg_date DESC
	 </select>
	--> 
	
	 <select id="getClassifierComparison" resultMap="AdminCommon.userPredictionAndSpammer" parameterClass="adminParam">
	 	SELECT a.user_name, u.spammer, u.updated_by, u.updated_at, a.prediction, a.algorithm, a.confidence, a.mode
	 	FROM user u
	 	JOIN prediction a ON (u.user_name = a.user_name)
	 	JOIN tas t ON (t.user_name = a.user_name)
	 	WHERE a.evaluator=1 AND t.date > NOW() - INTERVAL 1420 HOUR AND algorithm!='admin'
	 	<isGreaterThan property="interval" compareValue="0" prepend="AND">	
			u.reg_date > NOW() - INTERVAL #interval# DAY
		</isGreaterThan>
	 	group by u.user_name order by t.date DESC
	 </select>

	<update id="updateTasGroupIds" parameterClass="adminParam">
		UPDATE tas SET `group` = #newGroupId# WHERE user_name = #userName# AND `group` = #oldGroupId#
	</update>

	<update id="updateBookmarkGroupIds" parameterClass="adminParam">
		UPDATE bookmark SET `group` = #newGroupId# WHERE user_name = #userName# AND `group` = #oldGroupId#
	</update>

	<update id="updateBibtexGroupIds" parameterClass="adminParam">
		UPDATE bibtex SET `group` = #newGroupId# WHERE user_name = #userName# AND `group` = #oldGroupId#
	</update>

	<update id="updateSearchBookmarkGroupIds" parameterClass="adminParam">
		UPDATE search_bookmark SET `group` = #newGroupId# WHERE user_name = #userName# AND `group` = #oldGroupId#
	</update>

	<update id="updateSearchBibtexGroupIds" parameterClass="adminParam">
		UPDATE search_bibtex SET `group` = #newGroupId# WHERE user_name = #userName# AND `group` = #oldGroupId#
	</update>

</sqlMap>