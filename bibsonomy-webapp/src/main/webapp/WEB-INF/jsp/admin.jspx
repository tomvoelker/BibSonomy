<?xml version="1.0" ?>
<jsp:root version="2.0" xmlns="http://www.w3.org/1999/xhtml"
	xmlns:jsp="http://java.sun.com/JSP/Page"
	xmlns:c="http://java.sun.com/jsp/jstl/core"
	xmlns:fmt="http://java.sun.com/jsp/jstl/fmt"
	xmlns:layout="urn:jsptagdir:/WEB-INF/tags/layout"
	xmlns:tags="urn:jsptagdir:/WEB-INF/tags/tags"
	xmlns:fn="http://java.sun.com/jsp/jstl/functions"
	xmlns:menu="urn:jsptagdir:/WEB-INF/tags/menu"
	xmlns:parts="urn:jsptagdir:/WEB-INF/tags/layout/parts"
	xmlns:mtl="urn:jsptld:/WEB-INF/taglibs/mytaglib.tld">

	<jsp:directive.page contentType="text/html; charset=UTF-8"
		language="java" pageEncoding="UTF-8" session="true" />

	<c:set var="settingsCommand" value="${command.settingsCommand}" />
	<c:set var="statisticsCommand" value="${command.statisticsCommand}" />

	<layout:tabLayout pageTitle="${command.pageTitle}" command="${command}"
		requPath="${requPath}">

		<jsp:attribute name="heading">	
			<a href="/?filter=no">${projectName} all</a> :: <a rel="path_menu"
				href="/admin"><fmt:message key="navi.admin" /></a>
		</jsp:attribute>	

		<jsp:attribute name="headerExt">
			<link rel="stylesheet" type="text/css"
				href="${resdir}/css/spammer.css" />
		</jsp:attribute>
		
		<jsp:attribute name="topcontent">
			<menu:adminNavi />	
			<!-- Admin Navigation -->	
		</jsp:attribute>
		
		<jsp:attribute name="tabcontent">		
			<!-- spammer js -->
			<script type="text/javascript" src="${resdir}/javascript/spammer.js">&amp;nbsp;</script>				
			<script type="text/javascript"
				src="${resdir}/javascript/ajax-dynamic-content.js">&amp;nbsp;</script>
			<script type="text/javascript" src="${resdir}/javascript/ajax.js">&amp;nbsp;</script>
			<script type="text/javascript"
				src="${resdir}/javascript/ajax-tooltip.js">&amp;nbsp;</script>
			<script type="text/javascript"
				src="${resdir}/javascript/marksame.js">;</script>
				
			<c:if test="${!empty command.content}">
				
				<c:choose>
				
				<!-- classifier results tabs -->
				<c:when test="${command.selTab &lt; 10}">	
				
				<div>(show 
				<a href="?limit=100&amp;selTab=${command.selTab}">100</a> -
				<a href="?limit=500&amp;selTab=${command.selTab}">500</a> -
				<a href="?limit=1000&amp;selTab=${command.selTab}">1000</a> entries)
				</div>
  			
				<table id="spammers" class="spammertable">
					
				    <tr>
				    	<th>Spam?</th>
								<th>Username</th>
								<th>Name</th>
								<th>IP</th>
								<th>E-Mail</th>
								<th>Regdate</th>  	
				   		<c:choose>
				   		<c:when test="${command.selTab > 4}">
				    	<th>Algorithm</th>
				    	<th>Mode</th>
				    	<th>Confidence</th>
				    	</c:when>
				    	<c:otherwise>
				    	<th>By</th>
				    	</c:otherwise>
				    	</c:choose>
				    	<th>Updated</th>
				    </tr>
				    				    
				    <!-- user list -->
					<c:forEach var="user" items="${command.content}" varStatus="status">
					
					  <!-- set variables for scripts -->
					  <!-- e.g. row coloring depending on spam status -->
					  <!-- e.g. bookmark tooltip depending on tab -->
					  <tr id="sl${status.count}" class="${user.prediction == 9 ? 'spamflag uncertainUser' : ((user.spammer==true) ? 'spammer' : none)}">	
					     <c:set var="do_flag_action" value="javascript:ajax_hideTooltip()"/>
					     <c:choose>
					    	<c:when test="${command.selTab == 1}">
					        	<c:set var="Unflag" value="false" /> 
					        	<c:set var="Uncertain" value="false" />
					        	<c:set var="Flag" value="false" /> 
					    	</c:when> 
					    	<c:otherwise>
					    	<c:choose>
					    	    <c:when
									test="${command.selTab == 2 or command.selTab == 4}">
					    		<c:choose>
					    		<c:when test="${user.spammer == true}">
					    			<c:set var="Unflag" value="true" /> 
					    			<c:set var="Uncertain" value="true" />
					        		<c:set var="Flag" value="false" /> 
					        	</c:when>
					        	<c:otherwise>		        	
					    			<c:set var="Unflag" value="false" /> 
					    			<c:set var="Uncertain" value="true" />
					        		<c:set var="Flag" value="true" /> 
					        	</c:otherwise>
					        	</c:choose>
					        	</c:when>
					        	<c:otherwise>
					        	<c:choose>
					        	    <c:when test="${command.selTab == 3}">
					        	    	<c:set var="Unflag" value="true" /> 
					    				<c:set var="Uncertain" value="false" />
					        			<c:set var="Flag" value="true" /> 
					        	    </c:when>
					        	    <c:otherwise>
					        	    <c:choose>
					        	    <c:when test="${command.selTab == 9}">
					        	    	<c:set var="Unflag" value="false" /> 
					    				<c:set var="Uncertain" value="false" />
					        			<c:set var="Flag" value="false" /> 
					        	    </c:when>
					        	    <c:otherwise>    
					        			<c:set var="Unflag" value="true" /> 
					    				<c:set var="Uncertain" value="true" />
					        			<c:set var="Flag" value="true" />
					        			<c:set var="userIndex" value="${status.index+1}"/>
						                <c:set var="nextUser" value="${command.content[userIndex].name}"/> 
					        			<c:set var="do_flag_action" value="javascript:ajax_showTooltip('ajax?action=latest_posts&amp;userName=${nextUser}',document.getElementById('latest_posts_${status.index}'));" />
					        		</c:otherwise>
					        		</c:choose>
					        		</c:otherwise>
					        	</c:choose> 
					        	</c:otherwise>
					        </c:choose>
					  	 	</c:otherwise>
						</c:choose>
						
						<td style="text-align: left" class="spamflag">
						    <c:set var="nextUser" value="${command.content[userIndex].name}"/> 
							<a
										href="javascript:unflagSpammer('${user.name}','sl${status.count}', '${Unflag}')"
										title="unflag this user as spammer"
										onClick="${do_flag_action}">NO</a>
							<a
										href="javascript:markUncertainUser('${user.name}','sl${status.count}', '${Uncertain}')"
										title="mark as spammer status uncertain"
										onClick="${do_flag_action}">?</a>
					     	<a
										href="javascript:addSpammer('${user.name}','sl${status.count}', '${Flag}')"
										title="flag this user as spammer"
										onClick="${do_flag_action}">YES</a>
						</td>
				       <td>
				       	<a id="latest_posts_${status.index}" href="/user/${fn:escapeXml(user.name)}"><c:out
										value="${user.name}" /></a>
				       	<a
										onclick="javascript:ajax_showTooltip('ajax?action=latest_posts&amp;userName=${user.name}',this);return false;"
										style="cursor: pointer" title="show latest posts"><img
										src="${resdir}/image/info.png" /></a>
				        <a
										onclick="javascript:ajax_showTooltip('ajax?action=prediction_history&amp;userName=${user.name}',this);return false;"
										style="cursor: pointer" title="show latest user predictions"><img
										src="${resdir}/image/history.png" /></a></td>
				       <td><c:out value="${fn:substring(user.realname, 0, 25)}" /></td>	
					   <td><c:out value="${fn:substringBefore(user.IPAddress, ',')}"/></td>
					   <td>
					   	<c:out value="${fn:substring(user.email, 0, 35)}" />
					   </td>
					   <td>
					    <fmt:formatDate type="both" timeStyle="short"
										value="${user.registrationDate}" />
					   </td>					   
				 	   <c:choose>
				       <c:when test="${command.selTab > 4}">				    				       
				       <td><c:out value="${user.algorithm}" /></td>
				       <td><c:out value="${user.mode}" /></td>	
				       <td><c:out value="${fn:substring(user.confidence, 0,5)}" /></td>
				       </c:when>
				       <c:otherwise>
				       <td><c:out value="${user.updatedBy}" /></td>	
				       </c:otherwise>	
				       </c:choose>	       
					   <td>
					   	<fmt:formatDate type="both" timeStyle="short"
										value="${user.updatedAt}" />
					   </td>
				       </tr>
				    </c:forEach>
				</table>
				</c:when>
				
				<!-- evaluation tab -->
				<c:otherwise>
				<table id="spammers" class="spammertable">
			    <tr style="font-size: 120%">
			    	<th>Username</th>
								<th>Admin</th>
								<th>Spammer</th>
								<th>Algorithm</th>
								<th>Prediction</th>
								<th>Confidence</th>
								<th></th>
			    </tr>
				
				<c:forEach var="user" items="${command.content}" varStatus="status">
				<tr>
					<td>
						<a href="/user/${user.name}"><c:out value="${user.name}" /></a>
						<a
										onclick="javascript:ajax_showTooltip('ajax?action=latest_posts&amp;userName=${user.name}',this);return false;"
										style="cursor: pointer" title="show latest posts"><img
										src="${resdir}/image/info.png" /></a>
				        <a
										onclick="javascript:ajax_showTooltip('ajax?action=prediction_history&amp;userName=${user.name}',this);return false;"
										style="cursor: pointer" title="show latest user predictions"><img
										src="${resdir}/image/history.png" /></a>
				  	</td>
				    <td><c:out value="${user.updatedBy}" /></td>	
					<td><c:out value="${user.spammer}" /></td>
					<td><c:out value="${user.algorithm}" /></td>	
					<td><c:out value="${mtl:predictionString(user.prediction)}" /></td>	
					<td><c:out value="${fn:substring(user.confidence, 0,5)}" /></td>
					<c:choose>
						<c:when test="${user.prediction == 9}">
							<td class="uncertainUser"></td>					
						</c:when>
						<c:otherwise>
						<c:choose>
						<c:when test="${user.spammer == mtl:isSpammer(user.prediction)}">
							<td style="background: green"></td>					
						</c:when>
						<c:otherwise>
							<td style="background: red"></td>	
						</c:otherwise>
						</c:choose>
						</c:otherwise>
					</c:choose>
				</tr>				
				</c:forEach>	
				</table>			
				</c:otherwise>				
				</c:choose>				
			</c:if>		
			
			<script type="text/javascript"> 
			<![CDATA[ 
				ms_init("spammers", 4);
			]]>
			</script>
					
		</jsp:attribute>

		<jsp:attribute name="sidebar">			
			<span class="sidebar_h">logging</span>	
			<parts:logbox initialValue="no log messages" />
			<br />
			
			<span class="sidebar_h"><fmt:message key="navi.settings" /></span>			
			<table class="stattable">
				<tr>
					<td>mode:</td>
					<td>
						<select name="mode" id="mode" size="1">
							<option id="D" value="D">Day</option>
							<option id="N" value="N">Night</option>						
						</select>						
					</td>
					<td><input type="button" value="los"
						onclick="javascript:updateSettings('mode', document.getElementById('mode').value)" /></td>
				</tr>
				<tr>
					<td>algorithm:</td>
					<td>
						<select name="algorithm" id="algorithm" size="1">
							<option id="weka.classifiers.lazy.IBk"
							value="weka.classifiers.lazy.IBk">IBk</option>
							<option id="weka.classifiers.bayes.NaiveBayes"
							value="weka.classifiers.bayes.NaiveBayes">Bayes</option>
							<option id="weka.classifiers.trees.J48"
							value="weka.classifiers.trees.J48">J48</option>
							<option id="weka.classifiers.rules.OneR"
							value="weka.classifiers.rules.OneR">OneR</option>
							<option id="weka.classifiers.functions.Logistic"
							value="weka.classifiers.functions.Logistic">Log Reg</option>
							<option id="weka.classifiers.functions.LibSVM"
							value="weka.classifiers.functions.LibSVM">LibSVM</option>
							<option id="weka.classifiers.functions.SMO"
							value="weka.classifiers.functions.SMO">SVM (SMO)</option>
						</select>
					</td>
					<td><input type="button" value="los"
						onclick="javascript:updateSettings('algorithm', document.getElementById('algorithm').value)" /></td>
				</tr>
				<tr>
					<td>training period:</td>
					<td><input type="text" id="training_period" size="7"
						value="${settingsCommand.trainingPeriod}" /> sec</td>
					<td><input type="button" value="los"
						onclick="javascript:updateSettings('training_period', document.getElementById('training_period').value)" /></td>
				</tr>
				<tr>
					<td>classify period:</td>
					<td><input type="text" id="classify_period" size="7"
						value="${settingsCommand.classifyPeriod}" /> sec</td>
					<td><input type="button" value="los"
						onclick="javascript:updateSettings('classify_period', document.getElementById('classify_period').value)" /></td>
				</tr>
				<tr>
					<td>probability limit:</td>
					<td><input type="text" id="probability_limit" size="7"
						value="${settingsCommand.probabilityLimit}" /></td>
					<td><input type="button" value="los"
						onclick="javascript:updateSettings('probability_limit', document.getElementById('probability_limit').value)" /></td>
				</tr>
				<tr>
					<td>testing mode:</td>
					<td>
						<select name="testing" id="testing" size="1">
							<option id="on" value="on">On</option>
							<option id="off" value="off">Off</option>
						</select></td>
					<td><input type="button" value="los"
						onclick="javascript:updateSettings('testing', document.getElementById('testing').value)" /></td>
				</tr>
			</table>
			<br />
			
			<span class="sidebar_h"><fmt:message key="statistic" /></span>
			<table class="stattable">
				<tr class="counts">
					<th>Activities in the last</th>
					<th>7 days</th>
					<th>24 h</th>
					<th>12 h</th>
				</tr>
				<tr>
					<th>Admin</th>
					<th></th>
					<th></th>
					<th></th>
				</tr>
					
				<tr>
					<td>Spammers</td>
					<c:forEach items="${statisticsCommand.numAdminSpammer}" var="counts">
					<td><c:out value="${counts.value}"/></td>
					</c:forEach>			
				</tr>
				<tr>
					<td>No Spammers</td>
					<c:forEach items="${statisticsCommand.numAdminNoSpammer}" var="counts">
					<td><c:out value="${counts.value}"/></td>
					</c:forEach>	
				</tr>
				<tr>
					<th>Classifier</th>
					<th></th>
					<th></th>
					<th></th>
				</tr>
				
				<tr>
					<td>Spammers</td>
					<c:forEach items="${statisticsCommand.numClassifierSpammer}" var="counts">
					<td><c:out value="${counts.value}"/></td>
					</c:forEach>	
				</tr>
				<tr>
					<td>Spammers unsure</td>
					<c:forEach items="${statisticsCommand.numClassifierSpammerUnsure}" var="counts">
					<td><c:out value="${counts.value}"/></td>
					</c:forEach>
				</tr>
				<tr>
					<td>No Spammers unsure</td>
					<c:forEach items="${statisticsCommand.numClassifierNoSpammerUnsure}" var="counts">
					<td><c:out value="${counts.value}"/></td>
					</c:forEach>
				</tr>
				<tr>
					<td>No Spammers</td>
					<c:forEach items="${statisticsCommand.numClassifierNoSpammer}" var="counts">
					<td><c:out value="${counts.value}"/></td>
					</c:forEach>
				</tr>	
			</table>
			
			<script type="text/javascript">
				/** hack for preselect options in combobox */
				function preselect() {
					var mode = "${settingsCommand.mode}";
					var algorithm = "${settingsCommand.algorithm}";
					var testing = "${settingsCommand.testing}";					
					
					document.getElementById(mode).selected = true;
					document.getElementById(algorithm).selected = true;
					document.getElementById(testing).selected = true;
				}
				preselect();
			</script>											
		</jsp:attribute>
	</layout:tabLayout>
</jsp:root>