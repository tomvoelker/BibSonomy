<?xml version="1.0" encoding="UTF-8"?>
<beans xmlns="http://www.springframework.org/schema/beans"
	xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
	xmlns:util="http://www.springframework.org/schema/util"
	xmlns:security="http://www.springframework.org/schema/security"
	xmlns:context="http://www.springframework.org/schema/context"
	xsi:schemaLocation="
		http://www.springframework.org/schema/beans     http://www.springframework.org/schema/beans/spring-beans-3.1.xsd
		http://www.springframework.org/schema/security  http://www.springframework.org/schema/security/spring-security-3.1.xsd
		http://www.springframework.org/schema/util      http://www.springframework.org/schema/util/spring-util-3.1.xsd
		http://www.springframework.org/schema/context   http://www.springframework.org/schema/context/spring-context-3.1.xsd" default-lazy-init="true">

	<!-- Enable auto-wiring -->
	<context:annotation-config />
	<context:component-scan base-package="org.springframework.security.saml" />

	<!-- Unsecured pages -->
	<security:http security="none" pattern="/saml/web/**" />

	<bean id="samlFilter" class="org.bibsonomy.webapp.util.spring.factorybeans.ConditionedFactoryBean">
		<property name="condition" ref="samlActivatedCondition"/>
		<lookup-method name="produceSucessBean" bean="realSamlFilter"/>
		<lookup-method name="produceFailureBean" bean="dummySamlEntryPoint"/>
	</bean>
	
	<bean id="dummyFilter" class="org.bibsonomy.webapp.util.spring.filter.DummyFilter"/>

	<bean id="realSamlFilter" class="org.springframework.security.web.FilterChainProxy">
		<security:filter-chain-map request-matcher="ant">
			<security:filter-chain pattern="/saml/login/**" filters="samlEntryPoint" />
			<security:filter-chain pattern="/saml/logout/**" filters="samlLogoutFilter" />
			<security:filter-chain pattern="/saml/metadata/**" filters="metadataDisplayFilter" />
			<security:filter-chain pattern="/saml/SSO/**" filters="samlWebSSOProcessingFilter" />
			<security:filter-chain pattern="/saml/SSOHoK/**" filters="samlWebSSOHoKProcessingFilter" />
			<security:filter-chain pattern="/saml/SingleLogout/**" filters="samlLogoutProcessingFilter" />
			<security:filter-chain pattern="/saml/discovery/**" filters="samlIDPDiscovery" />
		</security:filter-chain-map>
	</bean>
	
	<bean id="samlLoginFilter" class="org.bibsonomy.webapp.util.spring.factorybeans.ConditionedFactoryBean">
		<property name="condition" ref="samlActivatedCondition"/>
		<lookup-method name="produceSucessBean" bean="realSamlLoginFilter"/>
		<lookup-method name="produceFailureBean" bean="dummySamlEntryPoint"/>
	</bean>
	
	<bean id="samlAutoLoginFilter" class="org.bibsonomy.webapp.util.spring.factorybeans.ConditionedFactoryBean">
		<property name="condition" ref="samlActivatedCondition"/>
		<lookup-method name="produceSucessBean" bean="realSamlAutoLoginFilter"/>
		<lookup-method name="produceFailureBean" bean="dummyFilter"/>
	</bean>
	
	<bean id="samlHttpsPretedingFilter" class="org.bibsonomy.webapp.filters.HttpsPretendingFilter">
		<property name="pathPrefix" value="/saml" />
		<property name="enabled" value="${auth.saml.useHttps}" />
	</bean>
	
	<bean id="realSamlLoginFilter" class="org.bibsonomy.webapp.util.spring.security.filter.SamlLoginFilter">
		<property name="filterProcessesUrl" value="/login_saml" />
		<property name="authenticationEntryPoint" ref="samlEntryPoint" />
		<property name="authenticationManager" ref="samlAuthenticationManager" />
		<property name="authenticationFailureHandler" ref="failureHandler" />
		<property name="rememberMeServices" ref="internalRememberMeServices" />
		<property name="requestCache" ref="dummyRequestCache" />
	</bean>
	
	<bean id="dummyRequestCache" class="org.springframework.security.web.savedrequest.NullRequestCache" />
	
	<bean id="realSamlAutoLoginFilter" class="org.bibsonomy.webapp.util.spring.security.filter.ParameterTriggeredAutoLoginFilter">
		<property name="loginParameterName" value="autoLogin" />
		<property name="authenticationEntryPoint" ref="samlRelayStateEntryPoint" />
	</bean>

	<bean id="samlRelayStateEntryPoint" class="org.bibsonomy.webapp.util.spring.security.web.RelayStateSettingEntryPoint">
		<property name="entryPoint" ref="samlEntryPoint" />
	</bean>	

	<!-- Handler deciding where to redirect user after successful login -->
	<bean id="successRedirectHandler" class="org.springframework.security.saml.SAMLRelayStateSuccessHandler">
		<property name="defaultTargetUrl" value="/" />
	</bean>

	<!-- Handler for successful logout -->
	<bean id="successLogoutHandler" class="org.springframework.security.web.authentication.logout.SimpleUrlLogoutSuccessHandler">
		<property name="defaultTargetUrl" value="/logout.jsp" />
	</bean>

	<!-- Register authentication manager with SAML provider -->
	<!-- 
	<security:authentication-manager alias="authenticationManager">
		<security:authentication-provider ref="samlAuthenticationProvider" />
	</security:authentication-manager>
	
	 -->

	<!-- Logger for SAML messages and events -->
	<bean id="samlLogger" class="org.bibsonomy.webapp.util.spring.security.saml.log.SamlExceptionLogger">
		<property name="regularSamlLogger">
			<bean class="org.springframework.security.saml.log.SAMLDefaultLogger" />
		</property>
	</bean>

	<!-- Central storage of cryptographic keys -->
	<bean id="keyManager" class="org.springframework.security.saml.key.JKSKeyManager">
		<constructor-arg value="${auth.saml.keystore}" />
		<constructor-arg type="java.lang.String" value="${auth.saml.keystore.pass}" />
		<constructor-arg>
			<map>
				<entry key="${auth.saml.keystore.key.alias}" value="${auth.saml.keystore.key.pass}" />
			</map>
		</constructor-arg>
		<constructor-arg type="java.lang.String" value="${auth.saml.keystore.key.alias}" />
	</bean>
	
	<bean id="samlActivatedCondition" class="org.bibsonomy.webapp.util.spring.condition.EvalOnceCondition">
		<property name="delegate">
			<bean class="org.bibsonomy.webapp.util.spring.condition.StringListContainsCondition">
				<property name="stringList" value="${auth.order}"/>
				<property name="expected" value="saml"/>
			</bean>
		</property>
	</bean>

	<bean id="samlEntryPoint" class="org.bibsonomy.webapp.util.spring.factorybeans.ConditionedFactoryBean">
		<property name="condition" ref="samlActivatedCondition"/>
		<lookup-method name="produceSucessBean" bean="realSamlEntryPoint"/>
		<lookup-method name="produceFailureBean" bean="dummySamlEntryPoint"/>
	</bean>

	<bean id="realSamlEntryPoint" class="org.springframework.security.saml.SAMLEntryPoint">
		<property name="defaultProfileOptions">
			<bean class="org.springframework.security.saml.websso.WebSSOProfileOptions">
				<property name="includeScoping" value="false" />
			</bean>
		</property>
	</bean>

	<bean id="dummySamlEntryPoint" class="org.bibsonomy.webapp.util.spring.security.entrypoints.UnsupportedAuthenticationMethodDummyEntryPoint">
		<property name="authMethod" value="SAML"/>
	</bean>

	<!-- IDP Discovery Service -->
	<bean id="samlIDPDiscovery" class="org.springframework.security.saml.SAMLDiscovery">
		<property name="idpSelectionPath" value="/WEB-INF/security/idpSelection.jsp" />
	</bean>

	<bean id="samlMetadataGeneratorFilter" class="org.bibsonomy.webapp.util.spring.factorybeans.ConditionedFactoryBean">
		<property name="condition" ref="samlActivatedCondition"/>
		<lookup-method name="produceSucessBean" bean="realSamlMetadataGeneratorFilter"/>
		<lookup-method name="produceFailureBean" bean="dummyFilter"/>
	</bean>

	<!-- Filter automatically generates default SP metadata -->
	<bean id="realSamlMetadataGeneratorFilter" class="org.bibsonomy.webapp.util.spring.security.saml.metadata.HttpsMetadataGeneratorFilter">
		<constructor-arg>
			<bean class="org.springframework.security.saml.metadata.MetadataGenerator">
				<property name="entityBaseURL" ref="projectHome" />
				<property name="entityAlias">
					<value>${auth.saml.entityalias}</value>
				</property>
				<property name="includeDiscovery" value="false" />
				<property name="bindingsSSO">
					<list>
						<value>urn:oasis:names:tc:SAML:2.0:bindings:HTTP-POST</value>
						<!--
						<value>urn:oasis:names:tc:SAML:2.0:bindings:PAOS</value>
						-->
						<value>urn:oasis:names:tc:SAML:2.0:bindings:HTTP-Artifact</value>
					</list>
				</property>
				<property name="bindingsHoKSSO">
					<list>
						<value>urn:oasis:names:tc:SAML:2.0:bindings:HTTP-POST</value>
						<value>urn:oasis:names:tc:SAML:2.0:bindings:HTTP-Artifact</value>
					</list>
				</property>
				<!-- WARNING: this number is complete magic. It depends on what is enabled in the bindingsSSO property and must be determined by looking at the sourcecode of org.springframework.security.saml.metadata.MetadataGenerator.buildSPSSODescriptor(String, String, boolean, boolean, Collection<String>) -->
				<!-- here we define HTTP-POST as the default binding to be used for responses from the IdP (hebis does not support the artifact bindng at the moment) -->
				<property name="assertionConsumerIndex" value="1"/>
			</bean>
		</constructor-arg>
		<property name="useHttps" value="${auth.saml.useHttps}" />
		<property name="removeTrailingBaseUrlSlash" value="true" />
	</bean>

	<!-- The filter is waiting for connections on URL suffixed with filterSuffix and presents SP metadata there -->
	<bean id="metadataDisplayFilter" class="org.springframework.security.saml.metadata.MetadataDisplayFilter" />

	<!-- SAML Authentication Provider responsible for validating of received SAML messages -->
	<bean id="samlAuthenticationProvider" class="org.springframework.security.saml.SAMLAuthenticationProvider">
		<!-- OPTIONAL property: can be used to store/load user data after login -->
		<property name="userDetails" ref="samlUserDetails" />
		<property name="forcePrincipalAsString" value="false" />
	</bean>
	
	<bean id="samlCredsAuthProvider" class="org.bibsonomy.webapp.util.spring.security.provider.SamlCredAuthProvider">
		<property name="userDetails" ref="samlUserDetails" />
		<property name="forcePrincipalAsString" value="false" />
	</bean>
	
	<bean id="samlUserDetails" class="org.bibsonomy.webapp.util.spring.security.userdetailsservice.MappingUserDetailsService">
		<property name="userNameMapping">
			<bean class="org.bibsonomy.webapp.util.spring.security.userdetailsservice.LogicInterfaceUserNameMapping">
				<property name="logic" ref="adminLogic" />
			</bean>
		</property>
		<property name="userDetailsService" ref="databaseUserService"/>
		<property name="attributeExtractor" ref="samlAttributeExtractor" />
	</bean>
	
	<bean id="samlAuthenticationManager" class="org.springframework.security.authentication.ProviderManager">
		<property name="providers">
			<list>
				<ref bean="samlAuthenticationProvider"/>
				<ref bean="samlCredsAuthProvider"/>
			</list>
		</property>
	</bean>

	<!-- Provider of default SAML Context -->
	<bean id="contextProvider" class="org.bibsonomy.webapp.util.spring.security.saml.context.RelayStateSamlContextProviderImpl" />

	<!-- Processing filter for WebSSO profile messages -->
	<bean id="samlWebSSOProcessingFilter" class="org.springframework.security.saml.SAMLProcessingFilter">
		<property name="authenticationManager" ref="samlAuthenticationManager" />
		<property name="authenticationSuccessHandler" ref="successRedirectHandler" />
		<property name="rememberMeServices" ref="internalRememberMeServices" />
	</bean>

	<!-- Processing filter for WebSSO Holder-of-Key profile -->
	<bean id="samlWebSSOHoKProcessingFilter" class="org.springframework.security.saml.SAMLWebSSOHoKProcessingFilter">
		<property name="authenticationManager" ref="samlAuthenticationManager" />
		<property name="authenticationSuccessHandler" ref="successRedirectHandler" />
	</bean>

	<!-- Logout handler terminating local session -->
	<bean id="logoutHandler"
		class="org.springframework.security.web.authentication.logout.SecurityContextLogoutHandler">
		<property name="invalidateHttpSession" value="false" />
	</bean>

	<!-- Override default logout processing filter with the one processing SAML messages -->
	<bean id="samlLogoutFilter" class="org.springframework.security.saml.SAMLLogoutFilter">
		<constructor-arg ref="successLogoutHandler" />
		<constructor-arg ref="logoutHandler" />
		<constructor-arg ref="logoutHandler" />
	</bean>

	<!-- Filter processing incoming logout messages -->
	<!-- First argument determines URL user will be redirected to after successful global logout -->
	<bean id="samlLogoutProcessingFilter" class="org.springframework.security.saml.SAMLLogoutProcessingFilter">
		<constructor-arg ref="successLogoutHandler" />
		<constructor-arg ref="logoutHandler" />
	</bean>

	<!-- Class loading incoming SAML messages from httpRequest stream -->
	<bean id="processor" class="org.springframework.security.saml.processor.SAMLProcessorImpl">
		<constructor-arg>
			<list>
				<ref bean="redirectBinding" />
				<ref bean="postBinding" />
				<ref bean="artifactBinding" />
				<ref bean="soapBinding" />
				<ref bean="paosBinding" />
			</list>
		</constructor-arg>
	</bean>

	<!-- SAML 2.0 WebSSO Assertion Consumer -->
	<bean id="webSSOprofileConsumer" class="org.springframework.security.saml.websso.WebSSOProfileConsumerImpl" />

	<!-- SAML 2.0 Holder-of-Key WebSSO Assertion Consumer -->
	<bean id="hokWebSSOprofileConsumer" class="org.springframework.security.saml.websso.WebSSOProfileConsumerHoKImpl" />

	<!-- SAML 2.0 Web SSO profile -->
	<bean id="webSSOprofile" class="org.springframework.security.saml.websso.WebSSOProfileImpl" />

	<!-- SAML 2.0 Holder-of-Key Web SSO profile -->
	<bean id="hokWebSSOProfile" class="org.springframework.security.saml.websso.WebSSOProfileConsumerHoKImpl" />

	<!-- SAML 2.0 ECP profile -->
	<bean id="ecpprofile" class="org.springframework.security.saml.websso.WebSSOProfileECPImpl" />

	<!-- SAML 2.0 Logout Profile -->
	<bean id="logoutprofile" class="org.springframework.security.saml.websso.SingleLogoutProfileImpl" />

	<!-- Bindings, encoders and decoders used for creating and parsing messages -->
	<bean id="postBinding" class="org.springframework.security.saml.processor.HTTPPostBinding">
		<constructor-arg ref="parserPool" />
		<constructor-arg ref="velocityEngine" />
	</bean>

	<bean id="redirectBinding" class="org.springframework.security.saml.processor.HTTPRedirectDeflateBinding">
		<constructor-arg ref="parserPool" />
	</bean>

	<bean id="artifactBinding" class="org.springframework.security.saml.processor.HTTPArtifactBinding">
		<constructor-arg ref="parserPool" />
		<constructor-arg ref="velocityEngine" />
		<constructor-arg>
			<bean class="org.springframework.security.saml.websso.ArtifactResolutionProfileImpl">
				<constructor-arg>
					<bean class="org.apache.commons.httpclient.HttpClient" />
				</constructor-arg>
				<property name="processor">
					<bean id="soapProcessor" class="org.springframework.security.saml.processor.SAMLProcessorImpl">
						<constructor-arg ref="soapBinding" />
					</bean>
				</property>
			</bean>
		</constructor-arg>
	</bean>

	<bean id="soapBinding" class="org.springframework.security.saml.processor.HTTPSOAP11Binding">
		<constructor-arg ref="parserPool" />
	</bean>

	<bean id="paosBinding" class="org.springframework.security.saml.processor.HTTPPAOS11Binding">
		<constructor-arg ref="parserPool" />
	</bean>

	<!-- Initialization of OpenSAML library -->
	<bean class="org.springframework.security.saml.SAMLBootstrap" />

	<!-- Initialization of the velocity engine -->
	<bean id="velocityEngine" class="org.springframework.security.saml.util.VelocityFactory" factory-method="getEngine" />

	<!-- XML parser pool needed for OpenSAML parsing -->
	<bean id="parserPool" class="org.opensaml.xml.parse.BasicParserPool" scope="singleton" />
	
	<bean id="samlAuthTool" class="org.bibsonomy.webapp.util.spring.security.saml.SamlAuthenticationTool" scope="singleton"/>
	
	<import resource="bibsonomy2-servlet-saml-extra.xml" />
</beans>