<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE sqlMap PUBLIC "-//iBATIS.com//DTD SQL Map 2.0//EN" "http://www.ibatis.com/dtd/sql-map-2.dtd">

<sqlMap namespace="Bookmark">
	<typeAlias alias="tag" type="org.bibsonomy.model.Tag" />
	<typeAlias alias="bookmark" type="org.bibsonomy.model.Bookmark" />
	<typeAlias alias="bookmarkByTagNames" type="org.bibsonomy.ibatis.params.bookmark.BookmarkByTagNames" />

	<resultMap id="bookmarks" class="bookmark" groupBy="contentId">
		<result property="contentId"   column="content_id"       javaType="int" />
		<result property="tags"        resultMap="Bookmark.tags" />
		<result property="description" column="book_description" javaType="string" />
		<result property="extended"    column="book_extended"    javaType="string" />
		<result property="userName"    column="user_name"        javaType="string" />
		<result property="date"        column="date"             javaType="date" />
		<result property="urlHash"     column="book_url_hash"    javaType="string" />
		<result property="url"         column="book_url"         javaType="string" />
		<result property="count"       column="book_url_ctr"     javaType="int" />
	</resultMap>

	<resultMap id="tags" class="tag">
		<result property="name" column="tag_name" javaType="string" />
	</resultMap>

	<select id="getBookmarkByTagNames" resultMap="bookmarks" parameterClass="bookmarkByTagNames">
		SELECT b.content_id, t.tag_name, b.book_description, b.book_extended, b.user_name, b.date,
		       b.book_url_hash, u.book_url, u.book_url_ctr
		FROM bookmark b, urls u, tas t,
		     (SELECT t1.content_id 
		      FROM
		      <iterate property="tagIndex" conjunction=",">
		        tas t$tagIndex[].index$
		      </iterate>
		      WHERE
		      <iterate property="tagIndex" conjunction="AND">
		      	<isEqual property="caseSensitive" compareValue="true">
		          t$tagIndex[].index$.tag_name = #tagIndex[].tagName#
		      	</isEqual>
		      	<isEqual property="caseSensitive" compareValue="false">
		          t$tagIndex[].index$.tag_lower = lower(#tagIndex[].tagName#)
		      	</isEqual>
		      </iterate>
		      <iterate property="tagIndex" prepend="AND" conjunction="AND">
		        <isLessThan property="tagIndex[].index" compareProperty="maxTagIndex">
		          t$tagIndex[].index$.content_id = t$tagIndex[].index2$.content_id
		        </isLessThan>
		      </iterate>
			        AND t1.content_type = #contentType#
			        AND t1.group = #groupType#
		      ORDER BY t1.date DESC
		      LIMIT #limit# OFFSET #offset#) AS tt
		WHERE b.content_id = tt.content_id 
		      AND t.content_id = tt.content_id 
			  AND b.book_url_hash = u.book_url_hash
			  ORDER BY b.date DESC, b.content_id DESC;
	</select>
</sqlMap>