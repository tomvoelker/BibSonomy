<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE sqlMap PUBLIC "-//iBATIS.com//DTD SQL Map 2.0//EN" "http://www.ibatis.com/dtd/sql-map-2.dtd">

<sqlMap namespace="Bookmark">
	<select id="getBookmarkPopular" resultMap="BookmarkCommon.bookmarks" parameterClass="bookmarkByTagNames">
		SELECT <include refid="bookmarkAttributes"/>, t.tag_name, u.book_url, u.book_url_ctr
		FROM temp_bookmark b
		LEFT OUTER JOIN tas AS t ON t.content_id = b.content_id, urls u
		WHERE u.book_url_hash = b.book_url_hash
		ORDER BY b.rank
	</select>

	<select id="getBookmarkByTagNames" resultMap="BookmarkCommon.bookmarks" parameterClass="bookmarkByTagNames">
		SELECT <include refid="bookmarkAttributes"/>, t.tag_name, u.book_url, u.book_url_ctr
		FROM bookmark b, urls u, tas t,
		     (SELECT t1.content_id 
		      FROM
		      <iterate property="tagIndex" conjunction=",">
		        tas t$tagIndex[].index$
		      </iterate>
		      WHERE
		      <iterate property="tagIndex" conjunction="AND">
		      	<isEqual property="caseSensitive" compareValue="true">
		          t$tagIndex[].index$.tag_name = #tagIndex[].tagName#
		      	</isEqual>
		      	<isEqual property="caseSensitive" compareValue="false">
		          t$tagIndex[].index$.tag_lower = lower(#tagIndex[].tagName#)
		      	</isEqual>
		      </iterate>
		      <iterate property="tagIndex" prepend="AND" conjunction="AND">
		        <isLessThan property="tagIndex[].index" compareProperty="maxTagIndex">
		          t$tagIndex[].index$.content_id = t$tagIndex[].index2$.content_id
		        </isLessThan>
		      </iterate>
			        AND t1.content_type = #contentType#
			        AND t1.group = #groupType#
		      ORDER BY t1.date DESC
		      LIMIT #limit# OFFSET #offset#) AS tt
		WHERE b.content_id = tt.content_id 
		      AND t.content_id = tt.content_id 
			  AND b.book_url_hash = u.book_url_hash
			  ORDER BY b.date DESC, b.content_id DESC;
	</select>

	<select id="getHomePageBookmark" resultMap="BookmarkCommon.bookmarks" parameterClass="homePageBookmark">
		SELECT bb.content_id, bb.book_url_hash, bb.book_description, bb.book_extended, bb.date, bb.user_name,
		       bb.book_url, bb.book_url_ctr, t.tag_name
		FROM (SELECT <include refid="bookmarkAttributes"/>, u.book_url,u.book_url_ctr
		      FROM bookmark b, urls u
		      WHERE b.group = #groupType#
		            AND u.book_url_hash = b.book_url_hash
		      ORDER BY date DESC
		      LIMIT	#limit#) AS bb
		LEFT OUTER JOIN tas AS t ON bb.content_id=t.content_id
		ORDER BY bb.date DESC, bb.content_id DESC;
	</select>

	<select id="getBookmarkByUserFriends" resultMap="BookmarkCommon.bookmarks" parameterClass="bookmarkByUserFriends">
		SELECT bb.content_id, b.book_url_hash, b.book_description, b.book_extended, bb.date, u.book_url,
		       u.book_url_ctr, t.tag_name, g.group_name, t.user_name
	    FROM urls u, bookmark b,
	         (SELECT content_id, date
	          FROM bookmark b, friends f
	          WHERE f.f_user_name =#user#                
	                AND b.user_name = f.user_name
	                AND b.group =#groupType# 
	   	      ORDER BY date DESC 
       	      LIMIT #limit# OFFSET #limit#) AS bb
	   	LEFT OUTER JOIN tas AS t ON bb.content_id=t.content_id, groupids AS g  
		WHERE t.group = g.group                                              
		      AND u.book_url_hash = b.book_url_hash                                  
		      AND b.content_id = bb.content_id                                       
		ORDER BY bb.date DESC, bb.content_id DESC;
	</select>
</sqlMap>