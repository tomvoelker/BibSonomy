<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE sqlMap PUBLIC "-//iBATIS.com//DTD SQL Map 2.0//EN" "http://www.ibatis.com/dtd/sql-map-2.dtd">

<sqlMap namespace="BibTex">
	<typeAlias alias="tag" type="org.bibsonomy.model.Tag" />
	<typeAlias alias="bibtex" type="org.bibsonomy.model.BibTex" />
	<typeAlias alias="bibTexByTagNames" type="org.bibsonomy.ibatis.params.bibtex.BibTexByTagNames" />

	<resultMap id="bibtexs" class="bibtex" groupBy="contentId">
		<result property="contentId"      column="content_id"     javaType="int" />
		<result property="tags"           resultMap="Bookmark.tags" />
		<result property="title"          column="title"          javaType="string" />
		<result property="address"        column="address"        javaType="string" />
		<result property="annote"         column="annote"         javaType="string" />
		<result property="booktitle"      column="booktitle"      javaType="string" />
		<result property="chapter"        column="chapter"        javaType="string" />
		<result property="crossref"       column="crossref"       javaType="string" />
		<result property="edition"        column="edition"        javaType="string" />
		<result property="howpublished"   column="howpublished"   javaType="string" />
		<result property="institution"    column="institution"    javaType="string" />
		<result property="journal"        column="journal"        javaType="string" />
		<result property="bkey"           column="bkey"           javaType="string" />
		<result property="month"          column="month"          javaType="string" />
		<result property="note"           column="note"           javaType="string" />
		<result property="number"         column="number"         javaType="string" />
		<result property="organization"   column="organization"   javaType="string" />
		<result property="pages"          column="pages"          javaType="string" />
		<result property="publisher"      column="publisher"      javaType="string" />
		<result property="school"         column="school"         javaType="string" />
		<result property="series"         column="series"         javaType="string" />
		<result property="type"           column="type"           javaType="string" />
		<result property="volume"         column="volume"         javaType="string" />
		<result property="day"            column="day"            javaType="string" />
		<result property="url"            column="url"            javaType="string" />
		<result property="description"    column="description"    javaType="string" />
		<result property="bibtexKey"      column="bibtexKey"      javaType="string" />
		<result property="misc"           column="misc"           javaType="string" />
		<result property="bibtexAbstract" column="bibtexAbstract" javaType="string" />
		<result property="userName"       column="user_name"      javaType="string" />
		<result property="date"           column="date"           javaType="date" />
		<result property="title"          column="title"          javaType="string" />
		<result property="author"         column="author"         javaType="string" />
		<result property="editor"         column="editor"         javaType="string" />
		<result property="year"           column="year"           javaType="string" />
		<result property="entrytype"      column="entrytype"      javaType="string" />
	</resultMap>

	<select id="getBibtexByTagNames" resultMap="bibtexs" parameterClass="bibTexByTagNames">
		SELECT $bibtexSelect$, t.tag_name, h.ctr
		FROM bibtex b, tas t, bibhash h,
		     (SELECT t1.content_id 
		      FROM
		      <iterate property="tagIndex" conjunction=",">
		        tas t$tagIndex[].index$
		      </iterate>
		      WHERE
		      <iterate property="tagIndex" conjunction="AND">
		      	<isEqual property="caseSensitive" compareValue="true">
		          t$tagIndex[].index$.tag_name = #tagIndex[].tagName#
		      	</isEqual>
		      	<isEqual property="caseSensitive" compareValue="false">
		          t$tagIndex[].index$.tag_lower = lower(#tagIndex[].tagName#)
		      	</isEqual>
		      </iterate>
		      <iterate property="tagIndex" prepend="AND" conjunction="AND">
		        <isLessThan property="tagIndex[].index" compareProperty="maxTagIndex">
		          t$tagIndex[].index$.content_id = t$tagIndex[].index2$.content_id
		        </isLessThan>
		      </iterate>
			        AND t1.content_type = #contentType#
			        AND t1.group = #groupType#
		      ORDER BY t1.date DESC
		      LIMIT #limit# OFFSET #offset#) AS tt
		WHERE b.content_id = tt.content_id
		      AND t.content_id = tt.content_id 
		      AND b.simhash$simHash$ = h.hash
		      AND h.type = $simHash$
			  ORDER BY b.date DESC, b.content_id DESC;
	</select>
</sqlMap>