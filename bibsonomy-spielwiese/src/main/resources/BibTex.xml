<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE sqlMap PUBLIC "-//iBATIS.com//DTD SQL Map 2.0//EN" "http://www.ibatis.com/dtd/sql-map-2.dtd">

<sqlMap namespace="BibTex">
	<select id="getBibTexPopular" resultMap="BibTexCommon.bibtexs" parameterClass="bibtexParam">
		SELECT <include refid="bibtexAttributes"/>, t.tag_name, h.ctr
		FROM temp_bibtex b
		LEFT OUTER JOIN tas t ON b.content_id = t.content_id, bibhash h
		WHERE <include refid="bibtexSimHash"/>
		ORDER BY b.rank
	</select>

	<select id="getBibTexByTagNames" resultMap="BibTexCommon.bibtexs" parameterClass="bibtexParam">
		SELECT <include refid="bibtexAttributes"/>, t.tag_name, h.ctr
		FROM bibtex b, tas t, bibhash h,
		     (SELECT t1.content_id
		      FROM <include refid="tagFromQuery"/>
		      WHERE <include refid="tagWhereQuery"/>
			        AND t1.content_type = #contentType#
			        AND t1.group = #groupType#
		      ORDER BY t1.date DESC
		      LIMIT #limit# OFFSET #offset#) AS tt
		WHERE b.content_id = tt.content_id
		      AND t.content_id = tt.content_id 
		      AND <include refid="bibtexSimHash"/>
		ORDER BY b.date DESC, b.content_id DESC
	</select>

	<select id="getBibTexByTagNamesForUser" resultMap="BibTexCommon.bibtexsWithGroupName" parameterClass="bibtexParam">
		SELECT <include refid="bibtexAttributes"/>, t.tag_name, g.group_name, h.ctr
		FROM bibtex b, tas t, groupids g, bibhash h,
		     (SELECT t1.content_id
		      FROM <include refid="tagFromQuery"/>
		      WHERE <include refid="tagWhereQuery"/>
		            <include refid="getPostForUser2"/>
		            AND t1.content_type = #contentType#
		            AND t1.user_name = #requestedUserName#
		      ORDER BY t1.date DESC
		      LIMIT #limit# OFFSET #offset#) AS tt
		WHERE tt.content_id=b.content_id
		      AND tt.content_id=t.content_id
		      AND <include refid="bibtexSimHash"/>
		      AND g.group = b.group
		ORDER BY b.date DESC, b.content_id DESC
	</select>

	<select id="getBibTexByConceptForUser" resultMap="BibTexCommon.bibtexsWithGroupName" parameterClass="bibtexParam">
		SELECT <include refid="bibtexAttributes"/>, t.tag_name, g.group_name, h.ctr
		FROM bibtex b, tas t, groupids g, bibhash h,
		     (SELECT DISTINCT b.content_id
		      FROM bibtex b, <include refid="conceptFromQuery"/>
		      WHERE <include refid="conceptWhereQuery"/>
		            <include refid="inGroups"/>
		            AND t1.content_type = #contentType#
		            AND t1.user_name = #userName#
		            AND t1.content_id = b.content_id
		      GROUP BY b.content_id
		      ORDER BY t1.date DESC
		      LIMIT #limit# OFFSET #offset#) AS tt
		WHERE tt.content_id = b.content_id
		      AND <include refid="bibtexSimHash"/>
		      AND tt.content_id = t.content_id
		      AND g.group = b.group
		      <!-- AND b.group IN (0,1,2)" TODO: WOZU sollte das gut sein?? bei der Bookmark Query war es auch drin! -->
		ORDER BY b.date DESC, b.content_id DESC
	</select>

	<select id="getBibTexByUserFriends" resultMap="BibTexCommon.bibtexsWithGroupName" parameterClass="bibtexParam">
		SELECT <include refid="bibtexAttributes"/>, t.tag_name, g.group_name, h.ctr
		FROM bibtex b, bibhash h,
			(SELECT content_id, date                <!-- publications from users of group which currUser may see -->
			 FROM bibtex b, friends f
			 WHERE f.f_user_name = #userName#       <!-- to see, which users have currUser as friend -->
			       AND b.user_name = f.user_name    <!-- take alle rows, which are owned by friend -->
			       AND b.group = #groupType#
			 ORDER BY date DESC
			 LIMIT #limit# OFFSET #offset# ) AS bb
		LEFT OUTER JOIN tas AS t ON bb.content_id = t.content_id, groupids AS g  <!-- join with tas (get tags) -->
		WHERE t.group = g.group                                                  <!-- join groupname -->
		      AND <include refid="bibtexSimHash"/>                               <!-- join counts, ... -->
		      AND b.content_id = bb.content_id                                   <!-- join rest of entry -->
		ORDER BY bb.date DESC, bb.content_id DESC
	</select>

	<select id="getBibTexForHomePage" resultMap="BibTexCommon.bibtexs" parameterClass="bibtexParam">
		SELECT <include refid ="bibtexAttributes"/>, t.tag_name, b.ctr
		FROM (SELECT <include refid ="bibtexAttributes"/>, h.ctr
		      FROM bibtex b FORCE INDEX (group_date_content_id_idx), bibhash h
		      WHERE `group` = #groupType#
		            AND <include refid="bibtexSimHash"/>
		      ORDER BY date DESC
		      LIMIT 15) AS b
		LEFT OUTER JOIN tas t ON b.content_id=t.content_id
		ORDER BY b.date DESC, b.content_id DESC
	</select>

	<select id="getBibTexByDownload" resultMap="BibTexCommon.bibtexs" parameterClass="bibtexParam">
		SELECT <include refid ="bibtexAttributes"/>, t.tag_name, h.ctr
		FROM (SELECT content_id, date
		      FROM collector
		      WHERE user_name = #userName#) AS c
		LEFT OUTER JOIN tas AS t ON c.content_id = t.content_id, bibtex b, bibhash h
		WHERE b.content_id = c.content_id
		      AND <include refid="bibtexSimHash"/>
		ORDER BY c.date DESC, content_id DESC
	</select>

	<select id="getBibTexByHash" resultMap="BibTexCommon.bibtexs" parameterClass="bibtexParam">
		SELECT <include refid ="bibtexAttributes"/>, t.tag_name, h.ctr
		FROM (SELECT <include refid ="bibtexAttributes2"/>, b2.simhash$simHash$
		      FROM bibtex b2
		      WHERE simhash$requestedSimHash$ = #hash#
		            AND b2.group = #groupType#
		      ORDER BY date DESC
		      LIMIT #limit# OFFSET #offset#) AS b
		LEFT OUTER JOIN tas t ON b.content_id = t.content_id, bibhash h
		WHERE <include refid="bibtexSimHash"/>
		ORDER BY b.date DESC, b.content_id DESC
	</select>
	
	<select id="getBibTexByHashCount" resultClass="int" parameterClass="bibtexParam">
		SELECT ctr FROM bibhash WHERE hash = #hash# AND type = #simHash#
	</select>

	<select id="getContentIdByUserAndHash" resultClass="int" parameterClass="bibtexParam">
		SELECT contendID FROM  WHERE hash = #hash# AND type = #simHash#
	</select>

	<!--
	   Here we join the document table to the bibtex table to get the corresponding 
	   documents and link them to the user; if currUser != requUser no documents
	   are joined so that a user can only see her own documents.
	-->
	<select id="getBibTexByHashForUser" resultMap="BibTexCommon.bibtexs" parameterClass="bibtexParam">
		SELECT *
		FROM (SELECT *
		      FROM bibtex b
		      WHERE simhash$requestedSimHash$ = #hash#
		            <include refid="inGroups"/>
		            AND user_name = #requestedUserName#
		      ORDER BY date DESC) AS b2
		LEFT OUTER JOIN tas t ON b2.content_id = t.content_id
		LEFT OUTER JOIN document d ON
		                (d.content_id = b2.content_id AND d.user_name = b2.user_name), bibhash h, groupids g
		WHERE <include refid="bibtexSimHash2"/>
		      AND b2.group = g.group
		ORDER BY b2.date DESC, b2.content_id DESC
	</select>

	<select id="getBibTexSearch" resultMap="BibTexCommon.bibtexs" parameterClass="bibtexParam">
		SELECT <include refid ="bibtexAttributes"/>, t.tag_name, b.ctr
		FROM (SELECT <include refid ="bibtexAttributes2"/>, h.ctr
		      FROM bibtex b2, bibhash h, search s
		      WHERE s.group = #groupType#
		            AND MATCH (s.content) AGAINST (#search# IN BOOLEAN MODE)
		            AND s.content_type = #contentType#
		            AND <include refid="bibtexSimHash2"/>
		            AND b2.content_id = s.content_id
		            <isNotNull property="requestedUserName" prepend="AND">
		              s.user_name = #requestedUserName#
		            </isNotNull>
		      ORDER BY s.date DESC
		      LIMIT #limit# OFFSET #offset#) AS b
		LEFT OUTER JOIN tas AS t ON t.content_id = b.content_id
		ORDER BY b.date DESC, b.content_id
	</select>

	<select id="getBibTexSearchCount" resultClass="int" parameterClass="bibtexParam">
		SELECT count(*)
		FROM search s
		WHERE s.group = #groupType#
		      AND MATCH (s.content) AGAINST (#search# IN BOOLEAN MODE)
		      AND s.content_type = #contentType#
		      <isNotNull property="requestedUserName" prepend="AND">
		        s.user_name = #requestedUserName#
		      </isNotNull>
	</select>

	<select id="getBibTexViewable" resultMap="BibTexCommon.bibtexs" parameterClass="bibtexParam">
		SELECT <include refid ="bibtexAttributes"/>, t.tag_name, b.ctr
		FROM (SELECT <include refid ="bibtexAttributes2"/>, b2.group, h.ctr
		      FROM bibtex b2, bibhash h
		      WHERE b2.group = #groupType#
		            AND <include refid="bibtexSimHash2"/>
		      ORDER BY date DESC
		      LIMIT #limit# OFFSET #offset#) AS b
		LEFT OUTER JOIN tas AS t ON t.content_id = b.content_id
		ORDER BY b.date DESC, b.content_id DESC
	</select>

	<select id="getBibTexDuplicate" resultMap="BibTexCommon.bibtexsWithGroupName" parameterClass="bibtexParam">
		SELECT <include refid ="bibtexAttributes"/>, t.tag_name, g.group_name, h.ctr
		FROM bibtex b, bibhash h,
		     (SELECT b2.content_id, b2.date
		      FROM (<include refid ="duplicatesCount"/>) AS b1
		      JOIN bibtex b2 ON b1.simhash1 = b2.simhash1 AND b2.user_name = #requestedUserName#) AS bb
		LEFT OUTER JOIN tas AS t ON bb.content_id = t.content_id, groupids AS g  <!-- join with tas (get tags) -->
		WHERE t.group = g.group                                                  <!-- join groupname -->
		      <include refid="inGroups"/>
		      AND <include refid="bibtexSimHash"/>                               <!-- join counts, ... -->
		      AND b.content_id = bb.content_id                                   <!-- join rest of entry -->
		ORDER BY b.simhash1 DESC, bb.date DESC
	</select>

	<select id="getBibTexDuplicateCount" resultClass="int" parameterClass="bibtexParam">
		SELECT count(*) FROM (<include refid ="duplicatesCount"/>) AS duplicates
	</select>

	<select id="getBibTexForGroup" resultMap="BibTexCommon.bibtexsWithGroupName" parameterClass="bibtexParam">
		SELECT <include refid ="bibtexAttributes"/>, t.tag_name, g.group_name, h.ctr
		FROM bibtex b, bibhash h,
		     ((SELECT content_id, date                <!-- publications from users of group which currUser may see -->
		       FROM bibtex b, groups g
		       WHERE g.group = #groupId#
		             AND g.user_name = b.user_name    <!-- user owns this publication -->
		             <include refid="inGroups"/>
		      )UNION(
		       SELECT content_id, date                <!-- publications from users of group which have currUser as friend -->
		       FROM bibtex b, groups g, friends f
		       WHERE f.f_user_name = #userName#       <!-- currUser is friend -->
		             AND g.user_name = f.user_name    <!-- user is in group -->
		             AND b.user_name = f.user_name    <!-- user owns this publication -->
		             AND g.group = #groupId#
		             AND b.group = $groupType$        <!-- publication is only for friends -->
		      )UNION(
		       SELECT content_id, date                <!-- currUsers publications, ... -->
		       FROM bibtex b, groups g
		       WHERE b.user_name = #userName#
		             AND g.user_name = b.user_name    <!-- only, if currUser ... -->
		             AND g.group = #groupId#          <!-- is in this group       -->
		      )
		      ORDER BY date DESC
		      LIMIT #limit# OFFSET #offset#) AS bb
		LEFT OUTER JOIN tas AS t ON bb.content_id = t.content_id, groupids AS g  <!-- join with tas (get tags) -->
		WHERE t.group = g.group                                                  <!-- join groupname -->
		      AND <include refid="bibtexSimHash"/>                               <!-- join counts, ... -->
		      AND b.content_id = bb.content_id                                   <!-- join rest of entry -->
		ORDER BY bb.date DESC, bb.content_id DESC
	</select>

	<select id="getBibTexForGroupCount" resultClass="int" parameterClass="bibtexParam">
		SELECT count(*)
		FROM bibtex b, groups g
		WHERE g.group = #groupId#
		      AND b.user_name = g.user_name
		      <include refid="inGroups"/>
	</select>

	<select id="getBibTexForGroupByTag" resultMap="BibTexCommon.bibtexsWithGroupName" parameterClass="bibtexParam">
		SELECT <include refid ="bibtexAttributes"/>, t.tag_name, g.group_name, h.ctr
		FROM bibtex b, bibhash h, <include refid="selectContentIDs"/>
		LEFT OUTER JOIN tas AS t ON bb.content_id = t.content_id, groupids AS g  <!-- join with tas (get tags) -->
		WHERE t.group = g.group                                                  <!-- join groupname -->
		      AND <include refid="bibtexSimHash"/>                               <!-- join counts, ... -->
		      AND b.content_id = bb.content_id                                   <!-- join rest of entry -->
		ORDER BY bb.date DESC, bb.content_id DESC
	</select>

	<select id="getBibTexForUser" resultMap="BibTexCommon.bibtexsWithGroupName" parameterClass="bibtexParam">
		SELECT <include refid ="bibtexAttributes2"/>, t.tag_name, g.group_name, b2.ctr
		FROM (SELECT <include refid ="bibtexAttributes"/>, b.group, h.ctr
		      FROM bibtex b, bibhash h
		      WHERE <include refid="bibtexSimHash"/>
		            AND b.user_name = #requestedUserName#
		            <include refid="getPostForUser"/>
		      ORDER BY date DESC
		      LIMIT #limit# OFFSET #offset#) AS b2
		LEFT OUTER JOIN tas AS t ON b2.content_id = t.content_id, groupids AS g
		WHERE b2.group = g.group
		ORDER BY b2.date DESC, b2.content_id DESC
	</select>

	<select id="getBibTexForUserCount" resultClass="int" parameterClass="bibtexParam">
		SELECT count(*)
		FROM bibtex b
		WHERE b.user_name = #requestedUserName#
		      <include refid="getPostForUser"/>
	</select>

	<!-- Replaced 'simhash"+Bibtex.SIM_HASH_0, simhash"+Bibtex.SIM_HASH_1, simhash"+Bibtex.SIM_HASH_2, simhash"+Bibtex.SIM_HASH_3' -->
	<!-- with 'simhash0, simhash1, simhash2, simhash3' -->
	<insert id="insertBibTex" parameterClass="bibtexParam">
		INSERT INTO bibtex (title, entrytype, author, editor, year, content_id, journal, volume, chapter,
		                    edition, month, bookTitle, howpublished, institution, organization, publisher,
		                    address, school, series, bibtexKey, `group`, date, user_name, url, description,
		                    annote, note, pages, bKey, number, crossref, misc, bibtexAbstract, type, day,
		                    scraperid, simhash0, simhash1, simhash2, simhash3)
		VALUES (#bibtex.title#, #bibtex.entrytype#, #bibtex.author#, #bibtex.editor#, #bibtex.year#,
		        #bibtex.contentId#, #bibtex.journal#, #bibtex.volume#, #bibtex.chapter#, #bibtex.edition#,
		        #bibtex.month#, #bibtex.booktitle#, #bibtex.howpublished#, #bibtex.institution#,
		        #bibtex.organization#, #bibtex.publisher#, #bibtex.address#, #bibtex.school#,
		        #bibtex.series#, #bibtex.bibtexKey#, #bibtex.groupId#, #bibtex.date#, #bibtex.userName#,
		        #bibtex.url#, #bibtex.description#, #bibtex.annote#, #bibtex.note#, #bibtex.pages#,
		        #bibtex.BKey#, #bibtex.number#, #bibtex.crossref#, #bibtex.misc#, #bibtex.bibtexAbstract#,
		        #bibtex.type#, #bibtex.day#, #bibtex.scraperId#, #bibtex.simHash0#, #bibtex.simHash1#,
		        #bibtex.simHash2#, #bibtex.simHash3#)
	</insert>

	<insert id="insertBibTexLog" parameterClass="bibtexParam">
		INSERT INTO log_bibtex (title, entrytype, author, editor, year, content_id, journal, volume, chapter,
		                    edition, month, bookTitle, howpublished, institution, organization, publisher,
		                    address, school, series, bibtexKey, `group`, date, user_name, url, description,
		                    annote, note, pages, bKey, number, crossref, misc, bibtexAbstract, type, day,
		                    scraperid, simhash0, simhash1, simhash2, simhash3)
		SELECT title, entrytype, author, editor, year, content_id, journal, volume, chapter, edition,
		       month, bookTitle, howpublished, institution, organization, publisher, address, school,
		       series, bibtexKey, `group`, date, user_name, url, description, annote, note, pages, bKey,
		       number, crossref, misc, bibtexAbstract, type, day, scraperid, simhash0, simhash1, simhash2,
		       simhash3
		FROM bibtex WHERE content_id = #requestedContentId#
	</insert>

	<insert id="insertBibTexHash" parameterClass="bibtexParam">
		INSERT INTO bibhash (hash, type) VALUES (#hash#, #simHash#)
	</insert>
	
	<insert id="insertBibTexHash0Inc" parameterClass="bibtexParam">
	INSERT INTO bibhash(hash,type,ctr) VALUES (#bibtex.simHash0#,0,1)ON DUPLICATE KEY UPDATE ctr=ctr+1 where type=0 and has=#simhash0#;
	</insert>
	
	<insert id="insertBibTexHash1Inc" parameterClass="bibtexParam">
	INSERT INTO bibhash(hash,type,ctr) VALUES (#bibtex.simHash1#,1,1)ON DUPLICATE KEY UPDATE ctr=ctr+1 where type=1 and has=#simhash1#;
	</insert>
	
	<insert id="insertBibTexHash2Inc" parameterClass="bibtexParam">
	INSERT INTO bibhash(hash,type,ctr) VALUES (#bibtex.simHash2#,2,1)ON DUPLICATE KEY UPDATE ctr=ctr+1 where type=2 and has=#simhash2#;
	</insert>
	
	<insert id="insertBibTexHash1Inc" parameterClass="bibtexParam">
	INSERT INTO bibhash(hash,type,ctr) VALUES (#bibtex.simHash0#,0,1)ON DUPLICATE KEY UPDATE ctr=ctr+1 where type=0 and has=#simhash0#;
	</insert>
	

	
	<update id="updateBibTexHashInc" parameterClass="bibtexParam">
		UPDATE bibhash SET ctr=ctr+1 WHERE hash = #hash# AND type = #simHash#
	</update>

	<update id="updateBibTexHas1Dec" parameterClass="bibtexParam">
		UPDATE bibhash SET ctr=ctr-1 WHERE hash = #hash1# AND type = 0
	</update>
	
	<update id="updateBibTexHash2Dec" parameterClass="bibtexParam">
		UPDATE bibhash SET ctr=ctr-1 WHERE hash = #hash2# AND type = 1
	</update>
	
	<update id="updateBibTexHash3Dec" parameterClass="bibtexParam">
		UPDATE bibhash SET ctr=ctr-1 WHERE hash = #hash3# AND type = 2
	</update>
	
	<update id="updateBibTexHash4Dec" parameterClass="bibtexParam">
		UPDATE bibhash SET ctr=ctr-1 WHERE hash = #hash4# AND type = 3
	</update>
	

	<update id="updateBibTexLog" parameterClass="bibtexParam">
		UPDATE log_bibtex SET new_content_id = #bibtex.contentId#
		WHERE content_id = #requestedContentId#
	</update>

	<update id="updateBibTexDocument" parameterClass="bibtexParam">
		UPDATE document SET content_id = #bibtex.contentId#
		WHERE content_id = #requestedContentId#
	</update>

	<update id="updateBibTexCollected" parameterClass="bibtexParam">
		UPDATE collector SET content_id = #bibtex.contentId#
		WHERE content_id = #requestedContentId#
	</update>

	<update id="updateBibTexExtended" parameterClass="bibtexParam">
		UPDATE extended_fields_data SET content_id = #bibtex.contentId#
		WHERE content_id = #requestedContentId#
	</update>

	<update id="updateBibTexUrl" parameterClass="bibtexParam">
		UPDATE bibtexurls SET content_id = #bibtex.contentId#
		WHERE content_id = #requestedContentId#
	</update>

	<select id="getBibTexSimHashsByContentId">
		SELECT simhash0, simhash1, simhash2, simhash3 FROM bibtex
		WHERE content_id = #requestedContentId#
	</select>

	<delete id="deleteBibTexByContentId">
		DELETE FROM bibtex WHERE content_id = #requestedContentId#
	</delete>

	<delete id="deleteBibTexDocumentByContentId">
		DELETE FROM document WHERE content_id = #requestedContentId#
	</delete>

	<delete id="deleteBibTexCollectedByContentId">
		DELETE FROM collector WHERE content_id = #requestedContentId#
	</delete>

	<delete id="deleteBibTexExtendedByContentId">
		DELETE FROM extended_fields_data WHERE content_id = #requestedContentId#
	</delete>

	<delete id="deleteBibTexUrlByContentId">
		DELETE FROM bibtexurls WHERE content_id = #requestedContentId#
	</delete>
</sqlMap>