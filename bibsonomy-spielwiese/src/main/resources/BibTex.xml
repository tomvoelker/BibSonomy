<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE sqlMap PUBLIC "-//iBATIS.com//DTD SQL Map 2.0//EN" "http://www.ibatis.com/dtd/sql-map-2.dtd">

<sqlMap namespace="BibTex">
	<select id="getBibTexPopular" resultMap="BibTexCommon.bibtexs" parameterClass="bibtexByHash">
		SELECT <include refid="bibtexAttributes"/>, t.tag_name, h.ctr
		FROM temp_bibtex b
		LEFT OUTER JOIN tas t ON b.content_id = t.content_id, bibhash h
		WHERE <include refid="bibtexSimHash"/>
		ORDER BY b.rank
	</select>

	<select id="getBibTexByTagNames" resultMap="BibTexCommon.bibtexs" parameterClass="bibtexByTagNames">
		SELECT <include refid="bibtexAttributes"/>, t.tag_name, h.ctr
		FROM bibtex b, tas t, bibhash h,
		     (SELECT t1.content_id 
		      FROM
		      <iterate property="tagIndex" conjunction=",">
		        tas t$tagIndex[].index$
		      </iterate>
		      WHERE
		      <iterate property="tagIndex" conjunction="AND">
		      	<isEqual property="caseSensitive" compareValue="true">
		          t$tagIndex[].index$.tag_name = #tagIndex[].tagName#
		      	</isEqual>
		      	<isEqual property="caseSensitive" compareValue="false">
		          t$tagIndex[].index$.tag_lower = lower(#tagIndex[].tagName#)
		      	</isEqual>
		      </iterate>
		      <iterate property="tagIndex" prepend="AND" conjunction="AND">
		        <isLessThan property="tagIndex[].index" compareProperty="maxTagIndex">
		          t$tagIndex[].index$.content_id = t$tagIndex[].index2$.content_id
		        </isLessThan>
		      </iterate>
			        AND t1.content_type = #contentType#
			        AND t1.group = #groupType#
		      ORDER BY t1.date DESC
		      LIMIT #limit# OFFSET #offset#) AS tt
		WHERE b.content_id = tt.content_id
		      AND t.content_id = tt.content_id 
		      AND <include refid="bibtexSimHash"/>
		ORDER BY b.date DESC, b.content_id DESC;
	</select>

	<select id="getBibTexByUserFriends" resultMap="BibTexCommon.bibtexs" parameterClass="bibtexByUserFriends">	
		SELECT <include refid="bibtexAttributes"/>, t.tag_name, g.group_name, h.ctr
		FROM bibtex b, bibhash h,
			(SELECT content_id, date
			 FROM bibtex b, friends f
			 WHERE f.f_user_name = #user#
			       AND b.user_name = f.user_name
			       AND b.group = #groupType#
			 ORDER BY date DESC
			 LIMIT #limit# OFFSET #offset# ) AS bb
		LEFT OUTER JOIN tas AS t ON bb.content_id = t.content_id, groupids AS g
		WHERE t.group = g.group
		      AND <include refid="bibtexSimHash"/>
		      AND b.content_id = bb.content_id
		ORDER BY bb.date DESC, bb.content_id DESC;
	</select>

	<select id="getHomePageBibTex" resultMap="BibTexCommon.bibtexs" parameterClass="homePageBibTex">
		SELECT <include refid ="bibtexAttributes"/>, t.tag_name, b.ctr
		FROM (SELECT <include refid ="bibtexAttributes"/>, h.ctr
		      FROM bibtex b FORCE INDEX (group_date_content_id_idx), bibhash h
		      WHERE `group` = #groupType#
		            AND <include refid="bibtexSimHash"/>
		      ORDER BY date DESC
		      LIMIT #limit#) AS b
		LEFT OUTER JOIN tas t ON b.content_id=t.content_id
		ORDER BY b.date DESC, b.content_id DESC;
	</select>

	<select id="getBibTexByDownload" resultMap="BibTexCommon.bibtexs" parameterClass="bibtexByDownload">
		SELECT <include refid ="bibtexAttributes"/>, t.tag_name, h.ctr
		FROM (SELECT content_id, date FROM collector WHERE user_name =#user#) AS c		 
		LEFT OUTER JOIN tas AS t ON c.content_id = t.content_id, bibtex b, bibhash h
		WHERE b.content_id = c.content_id 
		      AND <include refid="bibtexSimHash"/>
		ORDER BY c.date DESC, content_id DESC;
	</select>

	<!-- FROM (SELECT <include refid ="bibtexAttributes2"/>, bibtex.simhash#simValue# -->
	<select id="getBibTexByHash" resultMap="BibTexCommon.bibtexs" parameterClass="bibtexByHash">	
		SELECT <include refid ="bibtexAttributes"/>, t.tag_name, h.ctr
		FROM (SELECT <include refid ="bibtexAttributes2"/>, b2.simhash$simHash$
		      FROM bibtex b2
		      WHERE simhash$requSim$ = #requBibtex#  
		            AND b2.group = #groupType#
		      ORDER BY date DESC
		      LIMIT #limit# OFFSET #offset#) AS b
		LEFT OUTER JOIN tas t ON b.content_id=t.content_id, bibhash h
		WHERE <include refid="bibtexSimHash"/>
		ORDER BY b.date DESC, b.content_id DESC;
	</select>
<!--
	<select id="getBibTexSearch" resultMap="BibTexCommon.bibtexs">
		SELECT <include refid ="bibtexAttributes"/>, t.tag_name, b.ctr
		FROM (SELECT <include refid ="bibtexAttributes"/>, h.ctr
		      FROM bibtex b2, bibhash h, search s
		      WHERE s.group = #groupType#
		            AND MATCH (s.content) AGAINST (? IN BOOLEAN MODE)"
		            AND s.content_type = #contentType#
		            AND <include refid="bibtexSimHash"/>
		            AND b2.content_id = s.content_id
				+ usersearch
		      ORDER BY s.date DESC
		      LIMIT #limit# OFFSET #offset#) AS b
		LEFT OUTER JOIN tas AS t ON t.content_id = b.content_id
		ORDER BY b.date DESC, b.content_id
	</select>
-->
</sqlMap>