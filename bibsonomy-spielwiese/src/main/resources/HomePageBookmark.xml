<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE sqlMap PUBLIC "-//iBATIS.com//DTD SQL Map 2.0//EN" "http://www.ibatis.com/dtd/sql-map-2.dtd">

<sqlMap namespace="HomePageBookmark">

	<typeAlias alias="tag" type="org.bibsonomy.model.Tag" />
	<typeAlias alias="bookmark" type="org.bibsonomy.model.Bookmark" />
	<typeAlias alias="homePageForBookmark" type="org.bibsonomy.ibatis.params.bookmark.HomePageBookmark" />

	<resultMap id="bookmarks" class="bookmark" groupBy="contentId">
		<result property="contentId" column="content_Id" javaType="int" />
		<result property="tags" resultMap="HomePageBookmark.tags" />
		<result property="description" column="book_description" javaType="string" />
		<result property="extended" column="book_extended" javaType="string" />
		<result property="userName" column="user_name" javaType="string" />
		<result property="date" column="date" javaType="java.util.Date" />
		<result property="urlHash" column="book_url_hash" javaType="string" />
		<result property="url" column="book_url" javaType="string" />
		<result property="count" column="book_url_ctr" javaType="int" />
	</resultMap>

	<resultMap id="tags" class="tag">
		<result property="name" column="tag_name" javaType="string" />
	</resultMap>

	<select id="getHomePageBookmark" resultMap="bookmarks" parameterClass="homePageForBookmark">
		SELECT
		bb.content_id,bb.book_url_hash,bb.book_description,bb.book_extended,bb.date,bb.user_name,bb.book_url,bb.book_url_ctr,t.tag_name
		FROM 
	    (SELECT
		b.content_id,b.book_url_hash,b.book_description,b.book_extended,b.date,b.user_name,u.book_url,u.book_url_ctr
		FROM bookmark b, urls u WHERE b.group = #groupType# AND
		u.book_url_hash = b.book_url_hash ORDER BY date DESC LIMIT
		#itemCount#) AS bb LEFT OUTER JOIN tas AS t ON
		bb.content_id=t.content_id ORDER BY bb.date DESC, bb.content_id
		DESC;
       </select>
</sqlMap>