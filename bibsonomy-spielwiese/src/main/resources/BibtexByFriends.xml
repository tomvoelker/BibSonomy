<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE sqlMap PUBLIC "-//iBATIS.com//DTD SQL Map 2.0//EN" "http://www.ibatis.com/dtd/sql-map-2.dtd">

<sqlMap namespace="BibtexbyFriends">
    <typeAlias alias="tag" type="org.bibsonomy.model.Tag" />
	<typeAlias alias="bibTex" type="org.bibsonomy.model.BibTex" />
	<typeAlias alias="byUserFriendsBibtex" type="org.bibsonomy.ibatis.params.bibtex.BibTexByUserFriends" />

	<resultMap id="bibtexs" class="bibTex" groupBy="contentId" >
	    <result property="bibtextags"        resultMap="BibtexbyFriends.bibtextags" />
	    <result property="contentId" column="content_Id" javaType="int" />
		<result property="bibtexKey"   column="bibtexKey"       javaType="string" />
		<result property="bkey"        column="bkey"		     javaType="string" />
		<result property="misc"        column="misc"            javaType="string" />
		<result property="bibtexAbstract" column="bibtexAbstract" javaType="string" />
		<result property="description" column="description"     javaType="string" />
		<result property="entrytype"   column="entrytype"       javaType="string" />
		<result property="address"     column="address"         javaType="string" />
		<result property="annote"      column="annote"          javaType="string" />
		<result property="author"      column="author"          javaType="string" />
		<result property="title"       column="title"           javaType="string" />
		<result property="booktitle"   column="booktitle"       javaType="string" />
		<result property="chapter"     column="chapter"         javaType="string" />
		<result property="crossref"    column="crossref"        javaType="string" />
		<result property="edition"      column="edition"         javaType="string" />
		<result property="editor"       column="edition"         javaType="string" />
		<result property="howPublished" column="howpublished"    javaType="string"/>
		<result property="institution"  column="institution"     javaType="string" />
		<result property="organization" column="organization"    javaType="string" />
		<result property="journal"     column="journal"         javaType="string" />
		<result property="note"        column="note"            javaType="string" />
		<result property="number"      column="number"         javaType="string" />
		<result property="pages"       column="pages"           javaType="string" />
		<result property="publisher"   column="publisher"       javaType="string" />
		<result property="school"      column="school"          javaType="string"/>
		<result property="series"      column="series"          javaType="string" />
		<result property="volume"     column="volume"          javaType="string" />
		<result property="day"         column="day"             javaType="string" />
		<result property="month"       column="month"           javaType="string" />
		<result property="year"        column="year"            javaType="string" />
		<result property="userName"     column="user_name"      javaType="string" />                                                      
		</resultMap>
		
		
		<resultMap id="bibtextags" class="tag">
		<result property="name" column="tag_name" javaType="string" />
	    </resultMap>


    <sql id ="select_bibtexAttributes">
    SELECT b.address,b.annote,b.booktitle,b.chapter,b.crossref,b.edition,b.howpublished,
	b.institution,b.journal,b.bkey,b.month,b.note,b.number,b.organization,b.pages,b.publisher,
	b.school,b.series,b.type,b.volume,b.day,b.url,b.content_id,b.description,b.bibtexKey,b.misc,b.bibtexAbstract,b.user_name,b.date,b.title,b.author,
	b.editor,b.year,b.entrytype</sql>
    
    
	<select id="getBibTexByUserFriends" resultMap="bibtexs" parameterClass="byUserFriendsBibtex">
	
	<include refid ="select_bibtexAttributes"/>,t.tag_name,g.group_name, h.ctr
		 FROM bibtex b, bibhash h,
		 (SELECT content_id, date						
		 FROM bibtex b, friends f
		 WHERE f.f_user_name =#user#                  
		 AND b.user_name = f.user_name                             
		 AND b.group =#groupType# 
		 ORDER BY date DESC
		 LIMIT #itemCount# OFFSET #startBib# ) AS bb
		 LEFT OUTER JOIN tas AS t ON bb.content_id=t.content_id, groupids AS g  
		 WHERE t.group = g.group                                               
		 AND h.type = #simValue#
		 AND b.simhash#simValue#= h.hash                      
		 AND b.content_id = bb.content_id                                     
		 ORDER BY bb.date DESC, bb.content_id DESC;
      </select>
</sqlMap>