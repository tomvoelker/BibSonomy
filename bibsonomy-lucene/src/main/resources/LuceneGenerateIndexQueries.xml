<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE sqlMap PUBLIC "-//ibatis.apache.org//DTD SQL Map 2.0//EN" 
 "http://ibatis.apache.org/dtd/sql-map-2.dtd">
<sqlMap namespace="Lucene">
	<!--+ 
		| Result mappings.
	 	+-->
    <resultMap id="Lucene.groupIDs" class="groupParam">
        <result property="groupID"   column="group" javaType="integer"/>
        <result property="groupName" column="group_name" javaType="string"/>
    </resultMap>

    <resultMap id="Lucene.tasEntry" class="tasParam">
        <result property="contentID" column="content_id" javaType="integer"/>
        <result property="tagName"   column="tag_name"   javaType="string"/>
    </resultMap>
    
    <resultMap id="Lucene.groupedTasEntry" class="tasParam">
        <result property="contentID" column="content_id" javaType="integer"/>
        <result property="tagName"   column="tags"   javaType="string"/>
    </resultMap>

    <resultMap id="Lucene.groupTasEntry" class="groupTasParam">
        <result property="contentID" column="content_id" javaType="integer"/>
        <result property="groupID"     column="group"   javaType="integer"/>
    </resultMap>
    
	<!--+ 
		| Queries.
	 	+-->
	 <!-- get number of tag assignments -->
	<select id="getLastTasId" resultClass="integer">
		SELECT MAX(tas_id)
		FROM tas
	</select>    
	
	<!-- get number of tag assignments -->
	<select id="getTasCount" resultClass="integer">
		SELECT COUNT(*)
		FROM tas
	</select>   

	<!-- get number of public bookmark posts -->
	<select id="getBookmarkCount" resultClass="integer">
		SELECT count(*) 
		FROM bookmark b 
		WHERE b.group &gt;= 0
	</select>   

	<!-- get number of public bibtex posts -->
	<select id="getBibTexCount" resultClass="integer">
		SELECT count(*) 
		FROM bibtex b 
		WHERE b.group &gt;= 0
	</select>   
	 
	<!-- get last log_date from bibtex table -->
	<select id="getLastLogBibTex" resultClass="date">
		SELECT MAX(log_date)
		FROM log_bibtex
	</select>

	<!-- get last log_date from bibtex table -->
	<select id="getLastLogBookmark" resultClass="date">
		SELECT MAX(log_date)
		FROM log_bookmark
	</select>
	
	<!-- get group ids with corresponding group names --> 
	<select id="getGroupIDs" resultMap="groupIDs">
		SELECT `group`, group_name
		FROM groupids
	</select>    
	
	<!-- get list of tag assignments -->
	<select id="getTasEntries" parameterClass="listParam" resultMap="tasEntry">
		SELECT content_id, tag_name
		FROM tas
		LIMIT #offset#,#size#
	</select>
	
	<!-- get postwise concatenated list of tag assignments -->
	<select id="getGroupedTasEntries" parameterClass="listParam" resultMap="groupedTasEntry">
		SELECT content_id, GROUP_CONCAT(tag_name SEPARATOR ' ') AS tags 
		FROM tas 
		GROUP BY content_id 
		LIMIT #offset#,#size#
	</select>
	
	<!-- get list of  content id/group id pairs -->
	<select id="getGroupTasEntries" parameterClass="listParam" resultMap="groupTasEntry">
		SELECT DISTINCT content_id, `group` 
		FROM grouptas
		LIMIT #offset#,#size#
	</select>

	<!-- get list of all non-spam bookmarks -->
	<select id="getBookmarksForIndex" parameterClass="bookmarkParam" resultMap="BookmarkCommon.bookmarkPost" resultClass="java.util.HashMap">
		SELECT g.*, bb.content_id, bb.book_url_hash AS interHash, bb.book_url_hash AS intraHash, title, description, bb.date,
		       bb.book_url, bb.book_url_ctr AS count, t.tag_name, bb.user_name
		FROM (SELECT t1.content_id, t1.book_url_hash, t1.book_description AS title, t1.book_extended AS description, t1.date,
		             u.book_url, u.book_url_ctr, t1.group, t1.user_name
		      FROM bookmark t1, urls u
		      WHERE u.book_url_hash = t1.book_url_hash
		        AND t1.group &gt;= 0
		      ORDER BY date DESC
		      LIMIT #limit# OFFSET #offset#) AS bb
		LEFT OUTER JOIN tas AS t ON bb.content_id = t.content_id, groupids AS g
		WHERE bb.group = g.group
		ORDER BY bb.date DESC, bb.content_id DESC
	</select>		
	
		<!-- get list of all non-spam bookmarks -->
	<select id="getBookmarksForIndex2" parameterClass="bookmarkParam" resultMap="BookmarkCommon.luceneLogBookmarkPost">
		SELECT <include refid ="luceneBookmarkAttributes"/>, b.change_date AS log_date
	    FROM tas t
	      JOIN bookmark b USING (content_id)
	      JOIN urls u USING (book_url_hash)
	      JOIN groupids g ON (b.group = g.group)
	    WHERE b.group &gt;= 0
	    ORDER BY b.date DESC, b.content_id DESC, t.tas_id DESC
	    LIMIT #limit# OFFSET #offset#
	<!-- 
		SELECT g.*, bb.content_id, bb.book_url_hash AS interHash, bb.book_url_hash AS intraHash, title, description, bb.date,
		       bb.book_url, bb.book_url_ctr AS count, t.tag_name, bb.user_name
		FROM (SELECT t1.content_id, t1.book_url_hash, t1.book_description AS title, t1.book_extended AS description, t1.date,
		             u.book_url, u.book_url_ctr, t1.group, t1.user_name
		      FROM bookmark t1, urls u
		      WHERE u.book_url_hash = t1.book_url_hash
		        AND t1.group &gt;= 0
		      ORDER BY date DESC
		      LIMIT #limit# OFFSET #offset#) AS bb
		LEFT OUTER JOIN tas AS t ON bb.content_id = t.content_id, groupids AS g
		WHERE bb.group = g.group
		ORDER BY bb.date DESC, bb.content_id DESC
	 -->		
	</select>
	
	<!-- get list of all non-spam bookmarks -->
	<select id="getBookmarksForIndex3" parameterClass="bookmarkParam" resultMap="BookmarkCommon.bookmarkPost">
		SELECT 
			bb.*, 
			t.tag_name,
			g.*  
		FROM 
		( 
		  SELECT <include refid ="luceneCommonBookmarkAttributes"/>, b.group
		  FROM bookmark b 
	      JOIN urls u USING (book_url_hash)
		  WHERE b.group &gt;= 0
		  LIMIT #limit# OFFSET #offset#
		) AS bb
		LEFT JOIN tas t USING (content_id)
	    LEFT JOIN groupids g ON (bb.group = g.group)
	<!-- 
		SELECT <include refid ="luceneBookmarkAttributes"/>
	    FROM tas t
	      JOIN bookmark b USING (content_id)
	      JOIN urls u USING (book_url_hash)
	      JOIN groupids g ON (b.group = g.group)
	    WHERE b.group &gt;= 0
	      AND b.content_id &gt; #requestedContentId#
	    ORDER BY b.content_id ASC, t.tas_id DESC
	    LIMIT #limit#
 	-->
	</select>
	
	<!-- get list of all non-spam bibtex posts -->
	<select id="getBibTexForIndex" resultMap="BibTexCommon.bibtexPost" parameterClass="bibtexParam">
		SELECT <include refid ="bibtexAttributes2"/>, t.tag_name, g.*, b2.count
		FROM (SELECT t1.*, h.ctr AS count
		      FROM bibtex t1, bibhash h
		      WHERE <include refid="bibtexSimHash3"/>
		        AND t1.group &gt;= 0
		      ORDER BY date DESC
		      LIMIT #limit# OFFSET #offset#) AS b2
		LEFT OUTER JOIN tas AS t ON b2.content_id = t.content_id, groupids AS g
		WHERE b2.group = g.group
		ORDER BY b2.date DESC, b2.content_id DESC
	</select>
	
		<!-- get list of all non-spam bibtex posts -->
	<select id="getBibTexForIndex2" parameterClass="bibtexParam" resultMap="BibTexCommon.luceneLogBibtexPost">
		SELECT <include refid ="luceneBibtexAttributes2"/>, t.tag_name, g.*, h.ctr AS count, b2.change_date AS log_date
		FROM tas t
	      JOIN bibtex b2 USING (content_id)
	      JOIN bibhash h ON (<include refid="bibtexSimHash4"/>)
	      JOIN groupids g ON (b2.group = g.group)
		WHERE b2.group &gt;= 0
		ORDER BY b2.date DESC, b2.content_id DESC, t.tas_id DESC
		LIMIT #limit# OFFSET #offset#
		<!-- 
		SELECT <include refid ="bibtexAttributes2"/>, t.tag_name, g.*, b2.count
		FROM (SELECT t1.*, h.ctr AS count
		      FROM bibtex t1, bibhash h
		      WHERE <include refid="bibtexSimHash3"/>
		        AND t1.group &gt;= 0
		      ORDER BY date DESC
		      LIMIT #limit# OFFSET #offset#) AS b2
		LEFT OUTER JOIN tas AS t ON b2.content_id = t.content_id, groupids AS g
		WHERE b2.group = g.group
		ORDER BY b2.date DESC, b2.content_id DESC
		 -->
	</select>
	
	<!-- get list of all non-spam bibtex posts -->
	<select id="getBibTexForIndex3" parameterClass="bibtexParam" resultMap="BibTexCommon.bibtexPost">
		SELECT 
			bb.*, 
			t.tag_name,
			g.*  
		FROM 
		( 
		  SELECT <include refid ="commonBibtexAttributes2"/>, b2.group, h.ctr AS count, b2.scraperid
		  FROM bibtex b2 
	      JOIN bibhash h ON (<include refid="bibtexSimHash4"/>)
		  WHERE b2.group &gt;= 0
		  LIMIT #limit# OFFSET #offset#
		) AS bb
		LEFT JOIN tas t USING (content_id)
	    LEFT JOIN groupids g ON (bb.group = g.group)
		<!-- 
		SELECT <include refid ="luceneBibtexAttributes2"/>, t.tag_name, g.*, h.ctr AS count
		FROM tas t
	      JOIN bibtex b2 USING (content_id)
	      JOIN bibhash h ON (<include refid="bibtexSimHash4"/>)
	      JOIN groupids g ON (b2.group = g.group)
		WHERE b2.group &gt;= 0
		  AND b2.content_id &gt; #requestedContentId#
		ORDER BY b2.content_id ASC, t.tas_id DESC
		LIMIT #limit#
		 -->
	</select>
</sqlMap>
