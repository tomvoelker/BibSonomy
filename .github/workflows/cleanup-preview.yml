name: Cleanup Preview

on:
  pull_request:
    types: [closed]

permissions:
  contents: read

jobs:
  cleanup:
    runs-on: self-hosted
    env:
      KUBECONFIG: /home/github-runner/.kube/config
    steps:
      - name: Ensure kubectl connectivity
        run: |
          for i in {1..10}; do
            if kubectl get nodes >/dev/null 2>&1; then
              echo "kubectl connection ok"
              exit 0
            fi
            echo "kubectl connection failed ($i/10), retrying..."
            sleep 3
          done
          echo "kubectl connection failed after retries"
          exit 1

      - name: Cleanup preview resources
        env:
          PR_NUMBER: ${{ github.event.pull_request.number }}
        run: |
          kubectl -n extsonomy delete deployment,service,configmap,secret \
            -l preview.bibsonomy.org/pr="${PR_NUMBER}" --ignore-not-found
