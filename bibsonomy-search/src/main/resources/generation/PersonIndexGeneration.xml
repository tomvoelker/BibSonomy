<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE sqlMap PUBLIC "-//iBATIS.com//DTD SQL Map 2.0//EN" "http://www.ibatis.com/dtd/sql-map-2.dtd">

<sqlMap namespace="PersonGeneration">

	<resultMap id="simplePerson" class="person" groupBy="personChangeId">
		<result property="personChangeId"	column="person_change_id"		javaType="int" />
		<result property="personId"			column="person_id" 			javaType="string" />
	</resultMap>

	<resultMap id="person" class="person" groupBy="personChangeId" extends="PersonGeneration.simplePerson">
		<result property="academicDegree"	column="academic_degree"	javaType="string" />
		<result property="orcid"			column="orcid"				javaType="string" />
		<result property="college"			column="college"			javaType="string" />
		<result property="user"				column="user_name"			javaType="string"/>
		<result property="email"			column="email"				javaType="string"/>
		<result property="homepage"			column="homepage"			javaType="url"/>
		<result property="gender"			column="gender"				javaType="gender" />
		<result property="names"			resultMap="PersonGeneration.personName"/>
		<result property="changeDate"		column="log_changed_at"		javaType="date" />
	</resultMap>

	<resultMap id="personName" class="personName" groupBy="personNameChangeId">
		<result property="personNameChangeId" column="person_name_change_id" javaType="int" />
		<result property="firstName"		column="first_name"			javaType="string" />
		<result property="lastName"			column="last_name"			javaType="string" />
		<result property="isMain"			column="is_main"			javaType="boolean" />
	</resultMap>

	<resultMap id="personResourceRelation" class="resourcePersonRelation" groupBy="personRelChangeId">
		<result property="personRelChangeId"	column="person_relation_change_id"	javaType="int" />
		<result property="relationType"			column="relator_code"		javaType="personResourceRelationType" />
		<result property="changedAt"			column="log_changed_at"		javaType="date" />
		<result property="personIndex"			column="person_index"		javaType="int" />
		<result property="person"				resultMap="PersonGeneration.simplePerson" />
		<result property="post" 				resultMap="SearchGoldStandardPublicationCommon.searchGoldStandardPublicationPost" />
	</resultMap>

	<select id="getPersons" resultMap="person">
		SELECT pp.*, pn.person_change_id AS person_name_change_id, pn.first_name, pn.last_name, pn.is_main
		FROM
			(
				SELECT * FROM person p
					WHERE p.person_change_id > #lastContentId#
				ORDER BY p.person_change_id ASC
				LIMIT #limit#
			) AS pp
		JOIN person_name pn USING(person_id)
	</select>

	<select id="getResourceRelations" resultMap="personResourceRelation">
		SELECT ppr.person_id, ppr.relator_code, ppr.person_index, ppr.person_change_id AS person_relation_change_id, ppr.log_changed_at, p.person_change_id, <include refid="allGoldStandardPublicationAttributesSearch" />, b.simhash1 AS interHash, b.simhash2 AS intraHash, b.change_date, b.group, 'public' AS group_name, 1 AS count, b.content_id, -1 AS rating, -1 AS number_of_ratings
		FROM
			(
				SELECT * from pub_person
					WHERE person_change_id > #lastContentId#
				ORDER BY person_change_id
				LIMIT #limit#
			) AS ppr
		JOIN gold_standard b USING(simhash1)
		JOIN person p USING(person_id)
	</select>

	<select id="getPersonsCount" resultClass="int">
		SELECT count(*) FROM person p
	</select>

	<select id="getLastPersonChangeId" resultClass="int">
		SELECT value FROM ids where name = 17
	</select>

	<select id="getPersonRelationsCount" resultClass="int">
		SELECT count(*) FROM pub_person pp
	</select>
</sqlMap>