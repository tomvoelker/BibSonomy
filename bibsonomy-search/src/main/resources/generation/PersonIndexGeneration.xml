<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE sqlMap PUBLIC "-//iBATIS.com//DTD SQL Map 2.0//EN" "http://www.ibatis.com/dtd/sql-map-2.dtd">

<sqlMap namespace="PersonGeneration">

	<select id="getPersons" resultMap="SearchPersonCommon.person">
		SELECT pp.*, <include refid="personFields" />
		FROM
			(
				SELECT * FROM person p
					WHERE p.person_change_id > #lastContentId#
				ORDER BY p.person_change_id ASC
				LIMIT #limit#
			) AS pp
		JOIN person_name pn USING(person_id)
	</select>

	<select id="getResourceRelations" resultMap="SearchPersonCommon.personResourceRelation">
		SELECT ppr.person_id, ppr.relator_code, ppr.person_index, ppr.person_change_id AS person_relation_change_id, ppr.log_changed_at, p.person_change_id, <include refid="allGoldStandardPublicationAttributesSearch" />, b.simhash1 AS interHash, b.simhash2 AS intraHash, b.change_date, b.group, 'public' AS group_name, 1 AS count, b.content_id, -1 AS rating, -1 AS number_of_ratings
		FROM
			(
				SELECT * from pub_person
					WHERE person_change_id > #lastContentId#
				ORDER BY person_change_id
				LIMIT #limit#
			) AS ppr
		JOIN gold_standard b USING(simhash1)
		JOIN person p USING(person_id)
	</select>

	<select id="getPersonsCount" resultClass="int">
		SELECT count(*) FROM person p
	</select>

	<select id="getPersonRelationsCount" resultClass="int">
		SELECT count(*) FROM pub_person pp
	</select>
</sqlMap>