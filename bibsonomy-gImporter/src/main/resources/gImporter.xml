<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE sqlMap PUBLIC "-//ibatis.apache.org//DTD SQL Map 2.0//EN" "http://ibatis.apache.org/dtd/sql-map-2.dtd">

<sqlMap namespace="gImporter">
	<typeAlias alias="dnbPublication" type="org.bibsonomy.dnbimport.model.DnbPublication" />
	<typeAlias alias="dnbPerson" type="org.bibsonomy.dnbimport.model.DnbPerson" />

	<resultMap id="gImporterResult" class="dnbPublication" groupBy="titleId">
		<result property="titleId" column="title_id" />
		<result property="mainTitle" column="title" />
		<result property="subTitle" column="subtitle" />
		<result property="pubYear" column="pub_year_c" javaType="String" />
		<result property="subYear" column="sub_year_c" javaType="String" />
		<result property="classInfos" resultMap="gImporter.classReference" />
		<result property="schoolP1" column="uni" />
		<result property="schoolP2" column="city" />
		<result property="diss" column="diss" javaType="boolean" />
		<result property="habil" column="habil" javaType="boolean" />
		<result property="persons" resultMap="gImporter.dnbPerson"/>
	</resultMap>
	
	<resultMap id="dnbPerson" class="dnbPerson" groupBy="personId, personFunction">
		<result property="personId" column="person_id" />
		<!-- <result property="diffPerson" column="diff_person" /> -->
		<result property="firstName" column="firstname" />
		<result property="lastName" column="surname" />
		<result property="gender" column="gender" />
		<result property="personFunction" column="person_function"/>
		<result property="uniquePersonId" column="unique_person_id"/>
	</resultMap>
	
	<resultMap id="classReference" class="org.bibsonomy.common.Pair" groupBy="first, second">
		<result property="first"  column="kind"  javaType="org.bibsonomy.dnbimport.model.ClassificationScheme"  typeHandler="org.bibsonomy.dnbimport.database.typehandler.ClassificationSchemeTypeHandlerCallback" />
		<result property="second" column="class" javaType="String" />
	</resultMap>
	
	<resultMap id="classPair" class="org.bibsonomy.common.Pair">
		<result property="first"  column="class_id"   javaType="String" />
		<result property="second" column="class_name" javaType="String" />
	</resultMap>

	<select id="selectClassNames" resultMap="classPair" parameterClass="java.lang.String">
		SELECT class_id, class_name FROM title_hs_class_$className$
	</select>

	<select id="selectDissertation" resultMap="gImporterResult" parameterClass="org.bibsonomy.database.common.params.LimitOffsetParam">
		SELECT
			t.title_id, t.title, t.subtitle, t.pub_year_c, t.sub_year_c, t.city, t.uni, t.diss, t.habil, p.person_id, p.firstname, p.surname, p.diff_person, p.gender, l.person_function, l.unique_person_id, ct.kind, ct.class
		FROM
			(SELECT * FROM title_hs_title WHERE (diss=1 or habil=1) LIMIT #limit# OFFSET #offset#) t
			JOIN title_hs_link l ON l.title_id=t.title_id
			JOIN title_hs_person p ON l.person_id=p.person_id
			LEFT OUTER JOIN title_hs_class ct ON ct.title_id=t.title_id
	</select>


</sqlMap>
